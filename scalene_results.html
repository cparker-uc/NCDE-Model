                                                               Memory usage: ▂▂▃▃▃▃▃▃▄▄▄▄▄▅▅▆▆▆▆▇▇▇███▁▁ (max: 536.079 MB, growth rate:  99%)                                                                
                                                          /home/ec2-user/NCDE-model/training.py: % of time =  57.81% (1m:10.868s) out of 2m:2.595s.                                                          
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                                                                                              
       │Time   │–––––– │––––… │–––––– │Memory │–––––– │–––––––––––    │Copy   │                                                                                                                              
  Line │Python │native │syst… │GPU    │Python │peak   │timeline/%     │(MB/s) │/home/ec2-user/NCDE-model/training.py                                                                                         
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │      │       │       │       │               │       │# File Name: training.py                                                                                                      
     2 │       │       │      │       │       │       │               │       │# Author: Christopher Parker                                                                                                  
     3 │       │       │      │       │       │       │               │       │# Created: Fri Jul 21, 2023 | 12:49P EDT                                                                                      
     4 │       │       │      │       │       │       │               │       │# Last Modified: Thu Sep 14, 2023 | 02:19P EDT                                                                                
     5 │       │       │      │       │       │       │               │       │                                                                                                                              
     6 │       │       │      │       │       │       │               │       │"""This file defines the functions used for network training. These functions                                                 
     7 │       │       │      │       │       │       │               │       │are used in classification.py"""                                                                                              
     8 │       │       │      │       │       │       │               │       │                                                                                                                              
     9 │       │       │      │       │       │       │               │       │from IPython.core.debugger import set_trace                                                                                   
    10 │       │       │      │       │       │       │               │       │import os                                                                                                                     
    11 │       │       │      │       │       │       │               │       │import time                                                                                                                   
    12 │       │       │      │       │       │       │               │       │import torch                                                                                                                  
    13 │       │       │      │       │       │       │               │       │import torch.nn as nn                                                                                                         
    14 │       │       │      │       │       │       │               │       │import torch.optim as optim                                                                                                   
    15 │       │       │      │       │  97%  │   10M │▁   2%         │     1 │import torchcde                                                                                                               
    16 │       │       │      │       │       │       │               │       │from typing import Any                                                                                                        
    17 │       │       │      │       │       │       │               │       │from torch.nn.functional import binary_cross_entropy_with_logits, mse_loss                                                    
    18 │       │       │      │       │       │       │               │       │from torch.utils.data import DataLoader                                                                                       
    19 │       │       │      │       │       │       │               │       │from torchdiffeq import odeint_adjoint as odeint                                                                              
    20 │       │       │      │       │       │       │               │       │                                                                                                                              
    21 │       │       │      │       │       │       │               │       │from neural_cde import NeuralCDE                                                                                              
    22 │       │       │      │       │       │       │               │       │from neural_ode import NeuralODE                                                                                              
    23 │       │       │      │       │       │       │               │       │from ann import ANN                                                                                                           
    24 │       │       │      │       │       │       │               │       │from rnn import RNN                                                                                                           
    25 │       │       │      │       │       │       │               │       │from get_data import AblesonData, NelsonData, SriramSimulation                                                                
    26 │       │       │      │       │       │       │               │       │from get_augmented_data import (FullVirtualPopulation,                                                                        
    27 │       │       │      │       │       │       │               │       │                                FullVirtualPopulation_ByLab,                                                                  
    28 │       │       │      │       │       │       │               │       │                                NelsonVirtualPopulation, ToyDataset)                                                          
    29 │       │       │      │       │       │       │               │       │                                                                                                                              
    30 │       │       │      │       │       │       │               │       │# The constants listed here are to be defined in classification.py. The train()                                               
    31 │       │       │      │       │       │       │               │       │#  function will iterate through the parameter names passed in the                                                            
    32 │       │       │      │       │       │       │               │       │#  parameter_dict argument and set values to these global variables for use in                                                
    33 │       │       │      │       │       │       │               │       │#  all of the functions in this namespace                                                                                     
    34 │       │       │      │       │       │       │               │       │# Network architecture parameters                                                                                             
    35 │       │       │      │       │       │       │               │       │NETWORK_TYPE: str = ''                                                                                                        
    36 │       │       │      │       │       │       │               │       │INPUT_CHANNELS: int = 0                                                                                                       
    37 │       │       │      │       │       │       │               │       │HDIM: int = 0                                                                                                                 
    38 │       │       │      │       │       │       │               │       │OUTPUT_CHANNELS: int = 0                                                                                                      
    39 │       │       │      │       │       │       │               │       │N_RECURS: int = 0 # Only for RNN                                                                                              
    40 │       │       │      │       │       │       │               │       │CLASSIFY: bool = True # For use in choosing between classification/prediction                                                 
    41 │       │       │      │       │       │       │               │       │MECHANISTIC: bool = False # Should the mechanistic components be included?                                                    
    42 │       │       │      │       │       │       │               │       │                                                                                                                              
    43 │       │       │      │       │       │       │               │       │# Training hyperparameters                                                                                                    
    44 │       │       │      │       │       │       │               │       │ITERS: int = 0                                                                                                                
    45 │       │       │      │       │       │       │               │       │SAVE_FREQ: int = 0                                                                                                            
    46 │       │       │      │       │       │       │               │       │LR: float = 0.                                                                                                                
    47 │       │       │      │       │       │       │               │       │DECAY: float = 0.                                                                                                             
    48 │       │       │      │       │       │       │               │       │OPT_RESET: int = 0                                                                                                            
    49 │       │       │      │       │       │       │               │       │ATOL: float = 0.                                                                                                              
    50 │       │       │      │       │       │       │               │       │RTOL: float = 0.                                                                                                              
    51 │       │       │      │       │       │       │               │       │                                                                                                                              
    52 │       │       │      │       │       │       │               │       │# Training data selection parameters                                                                                          
    53 │       │       │      │       │       │       │               │       │PATIENT_GROUPS: list = []                                                                                                     
    54 │       │       │      │       │       │       │               │       │INDIVIDUAL_NUMBER: int = 0                                                                                                    
    55 │       │       │      │       │       │       │               │       │METHOD: str = ''                                                                                                              
    56 │       │       │      │       │       │       │               │       │NORMALIZE_STANDARDIZE: str = ''                                                                                               
    57 │       │       │      │       │       │       │               │       │NOISE_MAGNITUDE: float = 0.                                                                                                   
    58 │       │       │      │       │       │       │               │       │NUM_PER_PATIENT: int = 0                                                                                                      
    59 │       │       │      │       │       │       │               │       │POP_NUMBER: int = 0                                                                                                           
    60 │       │       │      │       │       │       │               │       │BATCH_SIZE: int = 0                                                                                                           
    61 │       │       │      │       │       │       │               │       │LABEL_SMOOTHING: float = 0.                                                                                                   
    62 │       │       │      │       │       │       │               │       │DROPOUT: float = 0.                                                                                                           
    63 │       │       │      │       │       │       │               │       │CORT_ONLY: bool = False                                                                                                       
    64 │       │       │      │       │       │       │               │       │T_END: int = 0                                                                                                                
    65 │       │       │      │       │       │       │               │       │                                                                                                                              
    66 │       │       │      │       │       │       │               │       │# Define the device with which to train networks                                                                              
    67 │       │       │      │       │       │       │               │       │DEVICE = torch.device('cpu')                                                                                                  
    68 │       │       │      │       │       │       │               │       │                                                                                                                              
    69 │       │       │      │       │       │       │               │       │                                                                                                                              
    70 │       │       │      │       │       │       │               │       │def train(hyperparameters: dict, virtual: bool=True,                                                                          
    71 │       │       │      │       │       │       │               │       │          permutations: list=[], ctrl_range: list=[], mdd_range: list=[],                                                     
    72 │       │       │      │       │       │       │               │       │          ableson_pop: bool=False, plus_ableson_mdd: bool=False,                                                              
    73 │       │       │      │       │       │       │               │       │          toy_data: bool=False):                                                                                              
    74 │       │       │      │       │       │       │               │       │    """Main function (called when script is executed directly"""                                                              
    75 │       │       │      │       │       │       │               │       │    # Loop over the constants passed in hyperparameters and set the values to                                                 
    76 │       │       │      │       │       │       │               │       │    #  the corresponding global variables                                                                                     
    77 │       │       │      │       │       │       │               │       │    for (key, val) in hyperparameters.items():                                                                                
    78 │       │       │      │       │       │       │               │       │        globals()[key] = val                                                                                                  
    79 │       │       │      │       │       │       │               │       │                                                                                                                              
    80 │       │       │      │       │       │       │               │       │    # Set a flag to indicate if we are labeling the data by lab or by diagnosis                                               
    81 │       │       │      │       │       │       │               │       │    by_lab = True if 'Nelson' in PATIENT_GROUPS else False                                                                    
    82 │       │       │      │       │       │       │               │       │                                                                                                                              
    83 │       │       │      │       │       │       │               │       │    # If the user didn't pass lists with the order of test patient                                                            
    84 │       │       │      │       │       │       │               │       │    #  permutations, we only run training on one population                                                                   
    85 │       │       │      │       │       │       │               │       │    if not permutations:                                                                                                      
    86 │       │       │      │       │       │       │               │       │        train_single(virtual, ableson_pop, toy_data)                                                                          
    87 │       │       │      │       │       │       │               │       │        return                                                                                                                
    88 │       │       │      │       │       │       │               │       │                                                                                                                              
    89 │       │       │      │       │       │       │               │       │    # Create the list of all combinations of Control and MDD (or Nelson and                                                   
    90 │       │       │      │       │       │       │               │       │    #  Ableson) populations in ctrl_range and mdd_range                                                                       
    91 │       │       │      │       │       │       │               │       │    loop_combos = [(i,j) for i in ctrl_range for j in mdd_range]                                                              
    92 │       │       │      │       │       │       │               │       │    for (ctrl_num, mdd_num) in loop_combos:                                                                                   
    93 │       │       │      │       │       │       │               │       │        control_combination = tuple(                                                                                          
    94 │       │       │      │       │       │       │               │       │            permutations[0][ctrl_num*5:(ctrl_num+1)*5]                                                                        
    95 │       │       │      │       │       │       │               │       │        )                                                                                                                     
    96 │       │       │      │       │       │       │               │       │        mdd_combination = tuple(                                                                                              
    97 │       │       │      │       │       │       │               │       │            permutations[1][mdd_num*5:((mdd_num+1)*5)                                                                         
    98 │       │       │      │       │       │       │               │       │                            if (mdd_num+1)*5 < len(permutations[1])                                                           
    99 │       │       │      │       │       │       │               │       │                            else len(permutations[1])]                                                                        
   100 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   101 │       │       │      │       │       │       │               │       │        # Load the dataset for training                                                                                       
   102 │       │       │      │       │       │       │               │       │        loader, (t_steps, t_start, t_end, t_eval) = load_data(                                                                
   103 │       │       │      │       │       │       │               │       │            control_combination=control_combination,                                                                          
   104 │       │       │      │       │       │       │               │       │            mdd_combination=mdd_combination, by_lab=by_lab,                                                                   
   105 │       │       │      │       │       │       │               │       │            plus_ableson_mdd=plus_ableson_mdd                                                                                 
   106 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   107 │       │       │      │       │       │       │               │       │        info = {                                                                                                              
   108 │       │       │      │       │       │       │               │       │            'virtual': virtual,                                                                                               
   109 │       │       │      │       │       │       │               │       │            'ctrl_num': ctrl_num,                                                                                             
   110 │       │       │      │       │       │       │               │       │            'control_combination': control_combination,                                                                       
   111 │       │       │      │       │       │       │               │       │            'mdd_num': mdd_num,                                                                                               
   112 │       │       │      │       │       │       │               │       │            'mdd_combination': mdd_combination,                                                                               
   113 │       │       │      │       │       │       │               │       │            'by_lab': by_lab,                                                                                                 
   114 │       │       │      │       │       │       │               │       │            't_steps': t_steps,                                                                                               
   115 │       │       │      │       │       │       │               │       │            't_start': t_start,                                                                                               
   116 │       │       │      │       │       │       │               │       │            't_end': t_end,                                                                                                   
   117 │       │       │      │       │       │       │               │       │            't_eval': t_eval,                                                                                                 
   118 │       │       │      │       │       │       │               │       │        }                                                                                                                     
   119 │       │       │      │       │       │       │               │       │                                                                                                                              
   120 │       │       │      │       │       │       │               │       │        model = model_init(info)                                                                                              
   121 │       │       │      │       │       │       │               │       │        run_training(model, loader, info)                                                                                     
   122 │       │       │      │       │       │       │               │       │                                                                                                                              
   123 │       │       │      │       │       │       │               │       │                                                                                                                              
   124 │       │       │      │       │       │       │               │       │def train_single(virtual: bool, ableson_pop: bool=False, toy_data: bool=False):                                               
   125 │       │       │      │       │       │       │               │       │    loader, (t_steps, t_start, t_end, t_eval) = load_data(                                                                    
   126 │       │       │      │       │       │       │               │       │        virtual, POP_NUMBER, ableson_pop=ableson_pop, toy_data=toy_data                                                       
   127 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   128 │       │       │      │       │       │       │               │       │                                                                                                                              
   129 │       │       │      │       │       │       │               │       │    info = {                                                                                                                  
   130 │       │       │      │       │       │       │               │       │        'virtual': virtual,                                                                                                   
   131 │       │       │      │       │       │       │               │       │        'toy_data': toy_data,                                                                                                 
   132 │       │       │      │       │       │       │               │       │        't_steps': t_steps,                                                                                                   
   133 │       │       │      │       │       │       │               │       │        't_start': t_start,                                                                                                   
   134 │       │       │      │       │       │       │               │       │        't_end': t_end,                                                                                                       
   135 │       │       │      │       │       │       │               │       │        't_eval': t_eval,                                                                                                     
   136 │       │       │      │       │       │       │               │       │    }                                                                                                                         
   137 │       │       │      │       │       │       │               │       │    model = model_init(info)                                                                                                  
   138 │       │       │      │       │       │       │               │       │    if MECHANISTIC:                                                                                                           
   139 │       │       │      │       │       │       │               │       │        params = param_init(model)                                                                                            
   140 │       │       │      │       │       │       │               │       │        for key, val in params.items():                                                                                       
   141 │       │       │      │       │       │       │               │       │            model.register_parameter(key, val)                                                                                
   142 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   143 │       │       │      │       │       │       │               │       │        params = {}                                                                                                           
   144 │       │       │      │       │       │       │               │       │    run_training(model, loader, info, params)                                                                                 
   145 │       │       │      │       │       │       │               │       │                                                                                                                              
   146 │       │       │      │       │       │       │               │       │                                                                                                                              
   147 │       │       │      │       │       │       │               │       │def load_data(virtual: bool=True, pop_number: int=0,                                                                          
   148 │       │       │      │       │       │       │               │       │              control_combination: tuple=(),                                                                                  
   149 │       │       │      │       │       │       │               │       │              mdd_combination: tuple=(), patient_groups: list=[],                                                             
   150 │       │       │      │       │       │       │               │       │              by_lab: bool=False, ableson_pop: bool=False,                                                                    
   151 │       │       │      │       │       │       │               │       │              plus_ableson_mdd: bool=False, test: bool=False,                                                                 
   152 │       │       │      │       │       │       │               │       │              toy_data: bool=False):                                                                                          
   153 │       │       │      │       │       │       │               │       │    if not patient_groups:                                                                                                    
   154 │       │       │      │       │       │       │               │       │        patient_groups = PATIENT_GROUPS                                                                                       
   155 │       │       │      │       │       │       │               │       │    if toy_data and not virtual:                                                                                              
   156 │       │       │      │       │       │       │               │       │        dataset = SriramSimulation(                                                                                           
   157 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   158 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE                                                                       
   159 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   160 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
   161 │       │       │      │       │       │       │               │       │        dataset = NelsonData(                                                                                                 
   162 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   163 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   164 │       │       │      │       │       │       │               │       │            individual_number=INDIVIDUAL_NUMBER,                                                                              
   165 │       │       │      │       │       │       │               │       │        ) if not ableson_pop else AblesonData(                                                                                
   166 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   167 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE                                                                       
   168 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   169 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   170 │       │       │      │       │       │       │               │       │        dataset = ToyDataset(                                                                                                 
   171 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   172 │       │       │      │       │       │       │               │       │            patient_groups=PATIENT_GROUPS,                                                                                    
   173 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   174 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   175 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   176 │       │       │      │       │       │       │               │       │            t_end=T_END                                                                                                       
   177 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   178 │       │       │      │       │       │       │               │       │    elif pop_number:                                                                                                          
   179 │       │       │      │       │       │       │               │       │        dataset = NelsonVirtualPopulation(                                                                                    
   180 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   181 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   182 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   183 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   184 │       │       │      │       │       │       │               │       │            pop_number=POP_NUMBER,                                                                                            
   185 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   186 │       │       │      │       │       │       │               │       │            label_smoothing=LABEL_SMOOTHING,                                                                                  
   187 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   188 │       │       │      │       │       │       │               │       │    elif patient_groups[1] not in ['MDD', 'Ableson']:                                                                         
   189 │       │       │      │       │       │       │               │       │        dataset = NelsonVirtualPopulation(                                                                                    
   190 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   191 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   192 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   193 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   194 │       │       │      │       │       │       │               │       │            control_combination=control_combination,                                                                          
   195 │       │       │      │       │       │       │               │       │            mdd_combination=mdd_combination,                                                                                  
   196 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   197 │       │       │      │       │       │       │               │       │            label_smoothing=LABEL_SMOOTHING,                                                                                  
   198 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   199 │       │       │      │       │       │       │               │       │            no_test_patients=ableson_pop,                                                                                     
   200 │       │       │      │       │       │       │               │       │            plus_ableson_mdd=plus_ableson_mdd,                                                                                
   201 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   202 │       │       │      │       │       │       │               │       │    elif by_lab:                                                                                                              
   203 │       │       │      │       │       │       │               │       │        dataset = FullVirtualPopulation_ByLab(                                                                                
   204 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   205 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   206 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   207 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   208 │       │       │      │       │       │       │               │       │            # Since Nelson is treated as control for the purposes of                                                          
   209 │       │       │      │       │       │       │               │       │            #  labeling, we use control_combination for the Nelson data                                                       
   210 │       │       │      │       │       │       │               │       │            #  and mdd_combination for the Ableson data                                                                       
   211 │       │       │      │       │       │       │               │       │            nelson_combination=control_combination,                                                                           
   212 │       │       │      │       │       │       │               │       │            ableson_combination=mdd_combination,                                                                              
   213 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   214 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   215 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   216 │       │       │      │       │       │       │               │       │        dataset = FullVirtualPopulation(                                                                                      
   217 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   218 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   219 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   220 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   221 │       │       │      │       │       │       │               │       │            control_combination=control_combination,                                                                          
   222 │       │       │      │       │       │       │               │       │            mdd_combination=mdd_combination,                                                                                  
   223 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   224 │       │       │      │       │       │       │               │       │            label_smoothing=LABEL_SMOOTHING                                                                                   
   225 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   226 │       │       │      │       │       │       │               │       │    if not virtual and INDIVIDUAL_NUMBER:                                                                                     
   227 │       │       │      │       │       │       │               │       │        t_steps = len(dataset[...,0])                                                                                         
   228 │       │       │      │       │       │       │               │       │        t = dataset[0][0][...,0]                                                                                              
   229 │       │       │      │       │       │       │               │       │        t_start = t[0]                                                                                                        
   230 │       │       │      │       │       │       │               │       │        t_end = t[-1]                                                                                                         
   231 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   232 │       │       │      │       │       │       │               │       │        t_steps = len(dataset[0][0][...,0])                                                                                   
   233 │       │       │      │       │       │       │               │       │        t = dataset[0][0][...,0]                                                                                              
   234 │       │       │      │       │       │       │               │       │        t_start = t[0]                                                                                                        
   235 │       │       │      │       │       │       │               │       │        t_end = t[-1]                                                                                                         
   236 │       │       │      │       │       │       │               │       │    loader = DataLoader(                                                                                                      
   237 │       │       │      │       │       │       │               │       │        dataset=dataset, batch_size=BATCH_SIZE, shuffle=True,                                                                 
   238 │       │       │      │       │       │       │               │       │        num_workers=1                                                                                                         
   239 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   240 │       │       │      │       │       │       │               │       │    return loader, (t_steps, t_start, t_end, t)                                                                               
   241 │       │       │      │       │       │       │               │       │                                                                                                                              
   242 │       │       │      │       │       │       │               │       │                                                                                                                              
   243 │       │       │      │       │       │       │               │       │def model_init(info: dict):                                                                                                   
   244 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   245 │       │       │      │       │       │       │               │       │    t_steps = info.get('t_steps', 11)                                                                                         
   246 │       │       │      │       │       │       │               │       │    t_eval = info.get('t_eval', [0,1])                                                                                        
   247 │       │       │      │       │       │       │               │       │                                                                                                                              
   248 │       │       │      │       │       │       │               │       │    if NETWORK_TYPE in ('NCDE', 'NCDE_LBFGS'):                                                                                
   249 │       │       │      │       │       │       │               │       │        return NeuralCDE(                                                                                                     
   250 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS, HDIM, OUTPUT_CHANNELS,                                                                            
   251 │       │       │      │       │       │       │               │       │            t_interval=t_eval.contiguous() if not CLASSIFY else torch.tensor((0,1)),                                          
   252 │       │       │      │       │       │       │               │       │            device=DEVICE, dropout=DROPOUT, prediction=not CLASSIFY                                                           
   253 │       │       │      │       │       │       │               │       │        ).double()                                                                                                            
   254 │       │       │      │       │       │       │               │       │    elif NETWORK_TYPE == 'NODE':                                                                                              
   255 │       │       │      │       │       │       │               │       │        return NeuralODE(                                                                                                     
   256 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS, HDIM, OUTPUT_CHANNELS,                                                                            
   257 │       │       │      │       │       │       │               │       │            device=DEVICE                                                                                                     
   258 │       │       │      │       │  73%  │   11M │▁   2%         │       │        ).double()                                                                                                            
   259 │       │       │      │       │       │       │               │       │    elif NETWORK_TYPE == 'ANN':                                                                                               
   260 │       │       │      │       │       │       │               │       │        return ANN(                                                                                                           
   261 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS*t_steps, HDIM,                                                                                     
   262 │       │       │      │       │       │       │               │       │            OUTPUT_CHANNELS*t_steps,                                                                                          
   263 │       │       │      │       │       │       │               │       │            device=DEVICE                                                                                                     
   264 │       │       │      │       │       │       │               │       │        ).double()                                                                                                            
   265 │       │       │      │       │       │       │               │       │    elif NETWORK_TYPE == 'RNN':                                                                                               
   266 │       │       │      │       │       │       │               │       │        return RNN(                                                                                                           
   267 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS*t_steps, HDIM, N_RECURS,                                                                           
   268 │       │       │      │       │       │       │               │       │            device=DEVICE,                                                                                                    
   269 │       │       │      │       │       │       │               │       │        ).double()                                                                                                            
   270 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   271 │       │       │      │       │       │       │               │       │        raise ValueError("NETWORK_TYPE must be one of NCDE, NCDE_LBFGS, NODE, ANN or RNN")                                    
   272 │       │       │      │       │       │       │               │       │                                                                                                                              
   273 │       │       │      │       │       │       │               │       │                                                                                                                              
   274 │       │       │      │       │       │       │               │       │def param_init(model: nn.Module):                                                                                             
   275 │       │       │      │       │       │       │               │       │    """Initialize the parameters for the mechanistic loss, and set them to                                                    
   276 │       │       │      │       │       │       │               │       │    require gradient"""                                                                                                       
   277 │       │       │      │       │       │       │               │       │    k_stress = torch.nn.Parameter(torch.tensor(10.1, device=DEVICE), requires_grad=True)                                      
   278 │       │       │      │       │       │       │               │       │    Ki = torch.nn.Parameter(torch.tensor(1.51, device=DEVICE), requires_grad=True)                                            
   279 │       │       │      │       │       │       │               │       │    VS3 = torch.nn.Parameter(torch.tensor(3.25, device=DEVICE), requires_grad=False)                                          
   280 │       │       │      │       │       │       │               │       │    Km1 = torch.nn.Parameter(torch.tensor(1.74, device=DEVICE), requires_grad=False)                                          
   281 │       │       │      │       │       │       │               │       │    KP2 = torch.nn.Parameter(torch.tensor(8.3, device=DEVICE), requires_grad=False)                                           
   282 │       │       │      │       │       │       │               │       │    VS4 = torch.nn.Parameter(torch.tensor(0.907, device=DEVICE), requires_grad=False)                                         
   283 │       │       │      │       │       │       │               │       │    Km2 = torch.nn.Parameter(torch.tensor(0.112, device=DEVICE), requires_grad=False)                                         
   284 │       │       │      │       │       │       │               │       │    KP3 = torch.nn.Parameter(torch.tensor(0.945, device=DEVICE), requires_grad=False)                                         
   285 │       │       │      │       │       │       │               │       │    VS5 = torch.nn.Parameter(torch.tensor(0.00535, device=DEVICE), requires_grad=False)                                       
   286 │       │       │      │       │       │       │               │       │    Km3 = torch.nn.Parameter(torch.tensor(0.0768, device=DEVICE), requires_grad=False)                                        
   287 │       │       │      │       │       │       │               │       │    Kd1 = torch.nn.Parameter(torch.tensor(0.00379, device=DEVICE), requires_grad=False)                                       
   288 │       │       │      │       │       │       │               │       │    Kd2 = torch.nn.Parameter(torch.tensor(0.00916, device=DEVICE), requires_grad=False)                                       
   289 │       │       │      │       │       │       │               │       │    Kd3 = torch.nn.Parameter(torch.tensor(0.356, device=DEVICE), requires_grad=False)                                         
   290 │       │       │      │       │       │       │               │       │    n1 = torch.nn.Parameter(torch.tensor(5.43, device=DEVICE), requires_grad=False)                                           
   291 │       │       │      │       │       │       │               │       │    n2 = torch.nn.Parameter(torch.tensor(5.1, device=DEVICE), requires_grad=False)                                            
   292 │       │       │      │       │       │       │               │       │    Kb = torch.nn.Parameter(torch.tensor(0.0202, device=DEVICE), requires_grad=False)                                         
   293 │       │       │      │       │       │       │               │       │    Gtot = torch.nn.Parameter(torch.tensor(3.28, device=DEVICE), requires_grad=False)                                         
   294 │       │       │      │       │       │       │               │       │    VS2 = torch.nn.Parameter(torch.tensor(0.0509, device=DEVICE), requires_grad=False)                                        
   295 │       │       │      │       │       │       │               │       │    K1 = torch.nn.Parameter(torch.tensor(0.645, device=DEVICE), requires_grad=False)                                          
   296 │       │       │      │       │       │       │               │       │    Kd5 = torch.nn.Parameter(torch.tensor(0.0854, device=DEVICE), requires_grad=False)                                        
   297 │       │       │      │       │       │       │               │       │                                                                                                                              
   298 │       │       │      │       │       │       │               │       │    params = {                                                                                                                
   299 │       │       │      │       │       │       │               │       │        'k_stress': k_stress,                                                                                                 
   300 │       │       │      │       │       │       │               │       │        'Ki': Ki,                                                                                                             
   301 │       │       │      │       │       │       │               │       │        'VS3': VS3,                                                                                                           
   302 │       │       │      │       │       │       │               │       │        'Km1': Km1,                                                                                                           
   303 │       │       │      │       │       │       │               │       │        'KP2': KP2,                                                                                                           
   304 │       │       │      │       │       │       │               │       │        'VS4': VS4,                                                                                                           
   305 │       │       │      │       │       │       │               │       │        'Km2': Km2,                                                                                                           
   306 │       │       │      │       │       │       │               │       │        'KP3': KP3,                                                                                                           
   307 │       │       │      │       │       │       │               │       │        'VS5': VS5,                                                                                                           
   308 │       │       │      │       │       │       │               │       │        'Km3': Km3,                                                                                                           
   309 │       │       │      │       │       │       │               │       │        'Kd1': Kd1,                                                                                                           
   310 │       │       │      │       │       │       │               │       │        'Kd2': Kd2,                                                                                                           
   311 │       │       │      │       │       │       │               │       │        'Kd3': Kd3,                                                                                                           
   312 │       │       │      │       │       │       │               │       │        'n1': n1,                                                                                                             
   313 │       │       │      │       │       │       │               │       │        'n2': n2,                                                                                                             
   314 │       │       │      │       │       │       │               │       │        'Kb': Kb,                                                                                                             
   315 │       │       │      │       │       │       │               │       │        'Gtot': Gtot,                                                                                                         
   316 │       │       │      │       │       │       │               │       │        'VS2': VS2,                                                                                                           
   317 │       │       │      │       │       │       │               │       │        'K1': K1,                                                                                                             
   318 │       │       │      │       │       │       │               │       │        'Kd5': Kd5                                                                                                            
   319 │       │       │      │       │       │       │               │       │    }                                                                                                                         
   320 │       │       │      │       │       │       │               │       │    for key, val in params.items():                                                                                           
   321 │       │       │      │       │       │       │               │       │        model.register_parameter(key, val)                                                                                    
   322 │       │       │      │       │       │       │               │       │                                                                                                                              
   323 │       │       │      │       │       │       │               │       │    return params                                                                                                             
   324 │       │       │      │       │       │       │               │       │                                                                                                                              
   325 │       │       │      │       │       │       │               │       │                                                                                                                              
   326 │       │       │      │       │       │       │               │       │def run_training(model: NeuralODE | NeuralCDE | ANN | RNN, loader: DataLoader,                                                
   327 │       │       │      │       │       │       │               │       │                 info: dict, params: dict={}):                                                                                
   328 │       │       │      │       │       │       │               │       │    """Run the training procedure for the given model and DataLoader"""                                                       
   329 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual')                                                                                             
   330 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
   331 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
   332 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   333 │       │       │      │       │       │       │               │       │                                                                                                                              
   334 │       │       │      │       │       │       │               │       │    # For use with mechanistic loss, we need the gradient with respect to time                                                
   335 │       │       │      │       │       │       │               │       │    #  so we create a linspace and set requires_grad to True                                                                  
   336 │       │       │      │       │       │       │               │       │    domain = torch.linspace(0, 1, 50, requires_grad=True).to(DEVICE)                                                          
   337 │       │       │      │       │       │       │               │       │                                                                                                                              
   338 │       │       │      │       │       │       │               │       │    # Print which population we are using to train                                                                            
   339 │       │       │      │       │       │       │               │       │    if not virtual and INDIVIDUAL_NUMBER:                                                                                     
   340 │       │       │      │       │       │       │               │       │        print(f'Starting Training w/ {PATIENT_GROUPS[0]} #{INDIVIDUAL_NUMBER}')                                               
   341 │       │       │      │       │       │       │               │       │    elif not virtual and len(PATIENT_GROUPS) == 1:                                                                            
   342 │       │       │      │       │       │       │               │       │        print(f'Starting Training w/ {PATIENT_GROUPS[0]}')                                                                    
   343 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
   344 │       │       │      │       │       │       │               │       │        print(f'Starting Training w/ {PATIENT_GROUPS[0]} '                                                                    
   345 │       │       │      │       │       │       │               │       │              f'vs {PATIENT_GROUPS[1]}')                                                                                      
   346 │       │       │      │       │       │       │               │       │    elif POP_NUMBER:                                                                                                          
   347 │       │       │      │       │       │       │               │       │        print(f'Starting Training w/ {PATIENT_GROUPS[1]} '                                                                    
   348 │       │       │      │       │       │       │               │       │              f'Population Number {POP_NUMBER}')                                                                              
   349 │       │       │      │       │       │       │               │       │    elif len(PATIENT_GROUPS) == 1:                                                                                            
   350 │       │       │      │       │       │       │               │       │        print(f'Starting Training w/ {PATIENT_GROUPS[0]}')                                                                    
   351 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   352 │       │       │      │       │       │       │               │       │        print(f'Starting Training w/ {PATIENT_GROUPS[0]} {control_combination}'                                               
   353 │       │       │      │       │       │       │               │       │              f' vs {PATIENT_GROUPS[1]} {mdd_combination}')                                                                   
   354 │       │       │      │       │       │       │               │       │                                                                                                                              
   355 │       │       │      │       │       │       │               │       │    start_time = time.time()                                                                                                  
   356 │       │       │      │       │       │       │               │       │                                                                                                                              
   357 │       │       │      │       │       │       │               │       │    optimizer = optim.AdamW(                                                                                                  
   358 │       │       │      │       │       │       │               │       │        model.parameters(), lr=LR, weight_decay=DECAY                                                                         
   359 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   360 │       │       │      │       │       │       │               │       │                                                                                                                              
   361 │       │       │      │       │       │       │               │       │    loss_over_time = []                                                                                                       
   362 │       │       │      │       │       │       │               │       │                                                                                                                              
   363 │       │       │      │       │       │       │               │       │    # We need to define the readout layer outside of the loop so that it                                                      
   364 │       │       │      │       │       │       │               │       │    #  isn't reset each iteration                                                                                             
   365 │       │       │      │       │       │       │               │       │    # Only necessary for NODE and RNN                                                                                         
   366 │       │       │      │       │       │       │               │       │    readout = None                                                                                                            
   367 │       │       │      │       │       │       │               │       │    if NETWORK_TYPE == 'NODE':                                                                                                
   368 │       │       │      │       │       │       │               │       │        readout = nn.Linear(OUTPUT_CHANNELS, 1).double().to(DEVICE)                                                           
   369 │       │       │      │       │       │       │               │       │    elif NETWORK_TYPE == 'RNN':                                                                                               
   370 │       │       │      │       │       │       │               │       │        readout = nn.Linear(HDIM, 1).double().to(DEVICE)                                                                      
   371 │       │       │      │       │       │       │               │       │                                                                                                                              
   372 │       │       │      │       │       │       │               │       │    for itr in range(1, ITERS+1):                                                                                             
   373 │       │       │      │       │       │       │               │       │        match NETWORK_TYPE:                                                                                                   
   374 │       │       │      │       │       │       │               │       │            case 'NCDE':                                                                                                      
   375 │       │       │      │       │       │       │               │       │                ncde_training_epoch(itr, loader, model, optimizer, loss_over_time, domain, info,                              
   376 │       │       │      │       │       │       │               │       │                                    toy_data=toy_data)                                                                        
   377 │       │       │      │       │       │       │               │       │            case 'NCDE_LBFGS':                                                                                                
   378 │       │       │      │       │       │       │               │       │                optimizer = optim.LBFGS(                                                                                      
   379 │       │       │      │       │       │       │               │       │                    model.parameters()                                                                                        
   380 │       │       │      │       │       │       │               │       │                )                                                                                                             
   381 │       │       │      │       │       │       │               │       │                ncde_training_epoch_lbfgs(itr, loader, model, optimizer, loss_over_time, domain, info,                        
   382 │       │       │      │       │       │       │               │       │                                    toy_data=toy_data)                                                                        
   383 │       │       │      │       │       │       │               │       │            case 'NODE':                                                                                                      
   384 │       │       │      │       │       │       │               │       │                node_training_epoch(itr, loader, model, readout,                                                              
   385 │       │       │      │       │       │       │               │       │                                    optimizer, loss_over_time, domain, params, info, toy_data=toy_data)                       
   386 │       │       │      │       │       │       │               │       │            case 'ANN':                                                                                                       
   387 │       │       │      │       │       │       │               │       │                ann_training_epoch(itr, loader, model, optimizer, loss_over_time,                                             
   388 │       │       │      │       │       │       │               │       │                                   domain, info, toy_data=toy_data)                                                           
   389 │       │       │      │       │       │       │               │       │            case 'RNN':                                                                                                       
   390 │       │       │      │       │       │       │               │       │                rnn_training_epoch(itr, loader, model, readout,                                                               
   391 │       │       │      │       │       │       │               │       │                                   optimizer, loss_over_time, domain, info, toy_data=toy_data)                                
   392 │       │       │      │       │       │       │               │       │            case _:                                                                                                           
   393 │       │       │      │       │       │       │               │       │                raise ValueError("NETWORK_TYPE must be one of NCDE, NODE, ANN, or RNN")                                       
   394 │       │       │      │       │       │       │               │       │                                                                                                                              
   395 │       │       │      │       │       │       │               │       │        # If itr is a multiple of OPT_RESET, re-initialize the optimizer to                                                   
   396 │       │       │      │       │       │       │               │       │        #  reset the learning rate and momentum                                                                               
   397 │       │       │      │       │       │       │               │       │        if not OPT_RESET:                                                                                                     
   398 │       │       │      │       │       │       │               │       │            pass                                                                                                              
   399 │       │       │      │       │       │       │               │       │        elif itr % OPT_RESET == 0:                                                                                            
   400 │       │       │      │       │       │       │               │       │            optimizer = optim.AdamW(                                                                                          
   401 │       │       │      │       │       │       │               │       │                model.parameters(), lr=LR, weight_decay=DECAY                                                                 
   402 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   403 │       │       │      │       │       │       │               │       │                                                                                                                              
   404 │       │       │      │       │       │       │               │       │        if itr % SAVE_FREQ == 0:                                                                                              
   405 │       │       │      │       │       │       │               │       │            runtime = time.time() - start_time                                                                                
   406 │       │       │      │       │       │       │               │       │            print(f"Runtime: {runtime:.6f} seconds")                                                                          
   407 │       │       │      │       │       │       │               │       │                                                                                                                              
   408 │       │       │      │       │       │       │               │       │            # Add the iteration number and runtime to the info dictionary and                                                 
   409 │       │       │      │       │       │       │               │       │            #  pass to save_network                                                                                           
   410 │       │       │      │       │       │       │               │       │            save_info = {                                                                                                     
   411 │       │       │      │       │       │       │               │       │                'itr': itr,                                                                                                   
   412 │       │       │      │       │       │       │               │       │                'runtime': runtime,                                                                                           
   413 │       │       │      │       │       │       │               │       │                'loss_over_time': loss_over_time                                                                              
   414 │       │       │      │       │       │       │               │       │            }                                                                                                                 
   415 │       │       │      │       │       │       │               │       │            save_info.update(info)                                                                                            
   416 │       │       │      │       │       │       │               │       │            save_network(model, readout, optimizer, save_info)                                                                
   417 │       │       │      │       │       │       │               │       │                                                                                                                              
   418 │       │       │      │       │       │       │               │       │                                                                                                                              
   419 │       │       │      │       │       │       │               │       │def ncde_training_epoch(itr: int, loader: DataLoader, model: NeuralCDE,                                                       
   420 │       │       │      │       │       │       │               │       │                        optimizer: optim.AdamW, loss_over_time: list, domain: torch.Tensor,  info: dict,                      
   421 │       │       │      │       │       │       │               │       │                        toy_data: bool=False):                                                                                
   422 │       │       │      │       │       │       │               │       │    t_eval = info.get('t_eval', [0,1])                                                                                        
   423 │       │       │      │       │       │       │               │       │    for j, (data, labels) in enumerate(loader):                                                                               
   424 │       │       │      │       │       │       │               │       │        # Ensure we have assigned the data and labels to the correct                                                          
   425 │       │       │      │       │       │       │               │       │        #  processing device                                                                                                  
   426 │       │       │      │       │       │       │               │       │        if CORT_ONLY:                                                                                                         
   427 │       │       │      │       │       │       │               │       │            # If we are only using CORT, we can discard the middle column as it                                               
   428 │       │       │      │       │       │       │               │       │            #  contains the ACTH concentrations                                                                               
   429 │       │       │      │       │       │       │               │       │            data = data[...,[0,2]]                                                                                            
   430 │       │       │      │       │       │       │               │       │        if toy_data and INPUT_CHANNELS == 3:                                                                                  
   431 │       │       │      │       │       │       │               │       │            data = data[...,[0,2,3]]                                                                                          
   432 │       │       │      │       │       │       │               │       │        # If we are using prediction mode instead of classification, we need                                                  
   433 │       │       │      │       │       │       │               │       │        #  the data and labels to be the same                                                                                 
   434 │       │       │      │       │       │       │               │       │        data = data.double().to(DEVICE) if CLASSIFY else data[...,1:].double().to(DEVICE)                                     
   435 │       │       │      │       │       │       │               │       │        labels = labels.to(DEVICE) if CLASSIFY else data                                                                      
   436 │       │       │      │       │       │       │               │       │        coeffs = torchcde.\                                                                                                   
   437 │       │       │      │       │       │       │               │       │            hermite_cubic_coefficients_with_backward_differences(                                                             
   438 │       │       │      │       │       │       │               │       │                data, t=t_eval                                                                                                
   439 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   440 │       │       │      │       │       │       │               │       │                                                                                                                              
   441 │       │       │      │       │       │       │               │       │        # Zero the gradient from the previous data                                                                            
   442 │       │       │      │       │       │       │               │       │        optimizer.zero_grad()                                                                                                 
   443 │       │       │      │       │       │       │               │       │                                                                                                                              
   444 │       │       │      │       │       │       │               │       │        # Compute the forward direction of the NCDE                                                                           
   445 │       │       │      │       │       │       │               │       │        pred_y = model(coeffs).squeeze(-1)                                                                                    
   446 │       │       │      │       │       │       │               │       │                                                                                                                              
   447 │       │       │      │       │       │       │               │       │        # Compute the loss based on the results                                                                               
   448 │       │       │      │       │       │       │               │       │        output = loss(pred_y, labels, domain=domain)                                                                          
   449 │       │       │      │       │       │       │               │       │                                                                                                                              
   450 │       │       │      │       │       │       │               │       │        # This happens in place, so we don't need to return loss_over_time                                                    
   451 │       │       │      │       │       │       │               │       │        loss_over_time.append((j, output.item()))                                                                             
   452 │       │       │      │       │       │       │               │       │                                                                                                                              
   453 │       │       │      │       │       │       │               │       │        # Backpropagate through the adjoint of the NODE to compute gradients                                                  
   454 │       │       │      │       │       │       │               │       │        #  WRT each parameter                                                                                                 
   455 │       │       │      │       │       │       │               │       │        output.backward()                                                                                                     
   456 │       │       │      │       │       │       │               │       │                                                                                                                              
   457 │       │       │      │       │       │       │               │       │        # Use the gradients calculated through backpropagation to adjust the                                                  
   458 │       │       │      │       │       │       │               │       │        #  parameters                                                                                                         
   459 │       │       │      │       │       │       │               │       │        optimizer.step()                                                                                                      
   460 │       │       │      │       │       │       │               │       │                                                                                                                              
   461 │       │       │      │       │       │       │               │       │        # If this is the first iteration, or a multiple of 10, present the                                                    
   462 │       │       │      │       │       │       │               │       │        #  user with a progress report                                                                                        
   463 │       │       │      │       │       │       │               │       │        if (itr == 1) or (itr % 10 == 0):                                                                                     
   464 │       │       │      │       │       │       │               │       │            print(f"Iter {itr:04d} Batch {j}: loss = {output.item():.6f}")                                                    
   465 │       │       │      │       │       │       │               │       │                                                                                                                              
   466 │       │       │      │       │       │       │               │       │                                                                                                                              
   467 │       │       │      │       │       │       │               │       │def ncde_training_epoch_lbfgs(itr: int, loader: DataLoader, model: NeuralCDE,                                                 
   468 │       │       │      │       │       │       │               │       │                              optimizer: optim.AdamW | optim.LBFGS, loss_over_time: list, domain: torch.Tensor, info: dict,   
   469 │       │       │      │       │       │       │               │       │                              toy_data: bool=False):                                                                          
   470 │       │       │      │       │       │       │               │       │                                                                                                                              
   471 │       │       │      │       │       │       │               │       │    for j, (data, labels) in enumerate(loader):                                                                               
   472 │       │       │      │       │       │       │               │       │        # Ensure we have assigned the data and labels to the correct                                                          
   473 │       │       │      │       │       │       │               │       │        #  processing device                                                                                                  
   474 │       │       │      │       │       │       │               │       │        if CORT_ONLY:                                                                                                         
   475 │       │       │      │       │       │       │               │       │            # If we are only using CORT, we can discard the middle column as it                                               
   476 │       │       │      │       │       │       │               │       │            #  contains the ACTH concentrations                                                                               
   477 │       │       │      │       │       │       │               │       │            data = data[...,[0,2]]                                                                                            
   478 │       │       │      │       │       │       │               │       │        if toy_data and INPUT_CHANNELS == 3:                                                                                  
   479 │       │       │      │       │       │       │               │       │            data = data[...,[0,2,3]]                                                                                          
   480 │       │       │      │       │       │       │               │       │        data = data.double().to(DEVICE)                                                                                       
   481 │       │       │      │       │       │       │               │       │        labels = labels.to(DEVICE) if CLASSIFY else data                                                                      
   482 │       │       │      │       │       │       │               │       │        coeffs = torchcde.\                                                                                                   
   483 │       │       │      │       │       │       │               │       │            hermite_cubic_coefficients_with_backward_differences(                                                             
   484 │       │       │      │       │       │       │               │       │                data                                                                                                          
   485 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   486 │       │       │      │       │       │       │               │       │                                                                                                                              
   487 │       │       │      │       │       │       │               │       │        def closure():                                                                                                        
   488 │       │       │      │       │       │       │               │       │            # Zero the gradient from the previous data                                                                        
   489 │       │       │      │       │       │       │               │       │            if torch.is_grad_enabled():                                                                                       
   490 │       │       │      │       │       │       │               │       │                optimizer.zero_grad()                                                                                         
   491 │       │       │      │       │       │       │               │       │                                                                                                                              
   492 │       │       │      │       │       │       │               │       │            # Compute the forward direction of the NCDE                                                                       
   493 │       │       │      │       │       │       │               │       │            pred_y = model(coeffs).squeeze(-1)                                                                                
   494 │       │       │      │       │       │       │               │       │                                                                                                                              
   495 │       │       │      │       │       │       │               │       │            # Compute the loss based on the results                                                                           
   496 │       │       │      │       │       │       │               │       │            output = loss(pred_y, labels, domain=domain)                                                                      
   497 │       │       │      │       │       │       │               │       │                                                                                                                              
   498 │       │       │      │       │       │       │               │       │            # This happens in place, so we don't need to return loss_over_time                                                
   499 │       │       │      │       │       │       │               │       │            loss_over_time.append((j, output.item()))                                                                         
   500 │       │       │      │       │       │       │               │       │                                                                                                                              
   501 │       │       │      │       │       │       │               │       │            # Backpropagate through the adjoint of the NODE to compute gradients                                              
   502 │       │       │      │       │       │       │               │       │            #  WRT each parameter                                                                                             
   503 │       │       │      │       │       │       │               │       │            if output.requires_grad:                                                                                          
   504 │       │       │      │       │       │       │               │       │                output.backward()                                                                                             
   505 │       │       │      │       │       │       │               │       │                                                                                                                              
   506 │       │       │      │       │       │       │               │       │            return output                                                                                                     
   507 │       │       │      │       │       │       │               │       │                                                                                                                              
   508 │       │       │      │       │       │       │               │       │        # Use the gradients calculated through backpropagation to adjust the                                                  
   509 │       │       │      │       │       │       │               │       │        #  parameters                                                                                                         
   510 │       │       │      │       │       │       │               │       │        optimizer.step(closure)                                                                                               
   511 │       │       │      │       │       │       │               │       │                                                                                                                              
   512 │       │       │      │       │       │       │               │       │        # If this is the first iteration, or a multiple of 10, present the                                                    
   513 │       │       │      │       │       │       │               │       │        #  user with a progress report                                                                                        
   514 │       │       │      │       │       │       │               │       │        if (itr == 1) or (itr % 10 == 0):                                                                                     
   515 │       │       │      │       │       │       │               │       │            print(f"Iter {itr:04d} Batch {j}: loss = {closure().item():.6f}")                                                 
   516 │       │       │      │       │       │       │               │       │                                                                                                                              
   517 │       │       │      │       │       │       │               │       │                                                                                                                              
   518 │       │       │      │       │       │       │               │       │def node_training_epoch(itr: int, loader: DataLoader, model: NeuralODE,                                                       
   519 │       │       │      │       │       │       │               │       │                        readout: nn.Linear, optimizer: optim.AdamW,                                                           
   520 │       │       │      │       │       │       │               │       │                        loss_over_time: list, domain: torch.Tensor, params: dict,                                             
   521 │       │       │      │       │       │       │               │       │                        info: dict, toy_data: bool=False):                                                                    
   522 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
   523 │       │       │      │       │  74%  │   10M │▁▁   4%        │     4 │    for j, (data, labels) in enumerate(loader):                                                                               
   524 │       │       │      │       │       │       │               │       │        if toy_data and not virtual:                                                                                          
   525 │       │       │      │       │       │       │               │       │            data = data.squeeze(0)                                                                                            
   526 │       │       │      │       │       │       │               │       │        t_eval = data[0,:,0].view(-1).to(DEVICE)                                                                              
   527 │       │       │      │       │       │       │               │       │                                                                                                                              
   528 │       │       │      │       │       │       │               │       │        # Ensure we have assigned the data and labels to the correct                                                          
   529 │       │       │      │       │       │       │               │       │        #  processing device                                                                                                  
   530 │       │       │      │       │       │       │               │       │        if CORT_ONLY:                                                                                                         
   531 │       │       │      │       │       │       │               │       │            # If we are only using CORT, we can discard the middle column as it                                               
   532 │       │       │      │       │       │       │               │       │            #  contains the ACTH concentrations                                                                               
   533 │       │       │      │       │       │       │               │       │            data = data[...,2]                                                                                                
   534 │       │       │      │       │       │       │               │       │        if toy_data and INPUT_CHANNELS == 2:                                                                                  
   535 │       │       │      │       │       │       │               │       │            data = data[...,[2,3]]                                                                                            
   536 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   537 │       │       │      │       │       │       │               │       │            data = data[...,1:]                                                                                               
   538 │       │       │      │       │       │       │               │       │        data = data.double().to(DEVICE)                                                                                       
   539 │       │       │      │       │       │       │               │       │        labels = labels.to(DEVICE) if CLASSIFY else data                                                                      
   540 │       │       │      │       │       │       │               │       │        y0 = data[:,0,:].to(DEVICE)                                                                                           
   541 │       │       │      │       │       │       │               │       │                                                                                                                              
   542 │       │       │      │       │       │       │               │       │        # Zero the gradient from the previous data                                                                            
   543 │       │       │      │       │       │       │               │       │        optimizer.zero_grad()                                                                                                 
   544 │       │       │      │       │       │       │               │       │                                                                                                                              
   545 │       │       │      │       │       │       │               │       │        # Compute the forward direction of the NODE                                                                           
   546 │       │       │      │       │  17%  │  227M │▂▂▂▂▂▂▂▂▃  41% │     1 │        pred_y = odeint(                                                                                                      
   547 │       │       │      │       │       │       │               │       │            model, y0, t_eval                                                                                                 
   548 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   549 │       │       │      │       │       │       │               │       │        # Compute the forward direction of the NODE with the dense domain for                                                 
   550 │       │       │      │       │       │       │               │       │        #  use in the mechanistic loss                                                                                        
   551 │       │       │      │       │       │       │               │       │        dense_pred_y = None                                                                                                   
   552 │       │       │      │       │       │       │               │       │        if MECHANISTIC:                                                                                                       
   553 │       │       │      │       │       │       │               │       │            dense_pred_y = odeint(                                                                                            
   554 │       │       │      │       │       │       │               │       │                model, y0, domain                                                                                             
   555 │       │       │      │       │       │       │               │       │            ).squeeze().to(DEVICE)                                                                                            
   556 │       │       │      │       │       │       │               │       │        # We need to take the output_channels down to a single output, then                                                   
   557 │       │       │      │       │       │       │               │       │        #  we only need the last value (so the value after the entire depth of                                                
   558 │       │       │      │       │       │       │               │       │        #  the network)                                                                                                       
   559 │       │       │      │       │       │       │               │       │        # We squeeze to remove the extraneous dimension of the output so that                                                 
   560 │       │       │      │       │       │       │               │       │        #  it matches the shape of the labels                                                                                 
   561 │       │       │      │       │       │       │               │       │        pred_y = readout(pred_y)[-1].squeeze(-1) if CLASSIFY else pred_y.squeeze(-1)                                          
   562 │       │       │      │       │       │       │               │       │                                                                                                                              
   563 │       │       │      │       │       │       │               │       │        # Compute the loss based on the results                                                                               
   564 │       │       │      │       │       │       │               │       │        # set_trace()                                                                                                         
   565 │       │       │      │       │       │       │               │       │        output = loss(pred_y, labels, dense_pred_y, domain, params)                                                           
   566 │       │       │      │       │       │       │               │       │                                                                                                                              
   567 │       │       │      │       │       │       │               │       │        # This happens in place, so we don't need to return loss_over_time                                                    
   568 │       │       │      │       │       │       │               │       │        loss_over_time.append((j, output.item()))                                                                             
   569 │       │       │      │       │       │       │               │       │                                                                                                                              
   570 │       │       │      │       │       │       │               │       │        # Backpropagate through the adjoint of the NODE to compute gradients                                                  
   571 │       │       │      │       │       │       │               │       │        #  WRT each parameter                                                                                                 
   572 │       │   17% │      │  1%   │   6%  │   35M │▁▁▁   6%       │     1 │        output.backward()                                                                                                     
   573 │       │       │      │       │       │       │               │       │                                                                                                                              
   574 │       │       │      │       │       │       │               │       │        # Use the gradients calculated through backpropagation to adjust the                                                  
   575 │       │       │      │       │       │       │               │       │        #  parameters                                                                                                         
   576 │       │       │      │       │  19%  │   58M │▁▁▁▁▁  10%     │       │        optimizer.step()                                                                                                      
   577 │       │       │      │       │       │       │               │       │                                                                                                                              
   578 │       │       │      │       │       │       │               │       │        # If this is the first iteration, or a multiple of 10, present the                                                    
   579 │       │       │      │       │       │       │               │       │        #  user with a progress report                                                                                        
   580 │       │       │      │       │       │       │               │       │        if (itr == 1) or (itr % 10 == 0):                                                                                     
   581 │       │       │      │       │       │       │               │       │            print(f"Iter {itr:04d} Batch {j}: loss = {output.item():.6f}")                                                    
   582 │       │       │      │       │       │       │               │       │                                                                                                                              
   583 │       │       │      │       │       │       │               │       │                                                                                                                              
   584 │       │       │      │       │       │       │               │       │def ann_training_epoch(itr: int, loader: DataLoader, model: ANN,                                                              
   585 │       │       │      │       │       │       │               │       │                       optimizer: optim.AdamW, loss_over_time: list, domain: torch.Tensor, info: dict,                        
   586 │       │       │      │       │       │       │               │       │                       toy_data: bool=False):                                                                                 
   587 │       │       │      │       │       │       │               │       │                                                                                                                              
   588 │       │       │      │       │       │       │               │       │    for j, (data, labels) in enumerate(loader):                                                                               
   589 │       │       │      │       │       │       │               │       │        # Check how many patients are in the batch (as it may be less than                                                    
   590 │       │       │      │       │       │       │               │       │        #  BATCH_SIZE if it's the last batch)                                                                                 
   591 │       │       │      │       │       │       │               │       │        batch_size_ = data.size(0)                                                                                            
   592 │       │       │      │       │       │       │               │       │        # Ensure we have assigned the data and labels to the correct                                                          
   593 │       │       │      │       │       │       │               │       │        #  processing device                                                                                                  
   594 │       │       │      │       │       │       │               │       │        if CORT_ONLY:                                                                                                         
   595 │       │       │      │       │       │       │               │       │            # If we are only using CORT, we can discard the middle column as it                                               
   596 │       │       │      │       │       │       │               │       │            #  contains the ACTH concentrations                                                                               
   597 │       │       │      │       │       │       │               │       │            data = data[...,2]                                                                                                
   598 │       │       │      │       │       │       │               │       │        elif toy_data and INPUT_CHANNELS == 2:                                                                                
   599 │       │       │      │       │       │       │               │       │            data = data[...,[2,3]]                                                                                            
   600 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   601 │       │       │      │       │       │       │               │       │            data = data[...,1:]                                                                                               
   602 │       │       │      │       │       │       │               │       │        data = data.double().to(DEVICE)                                                                                       
   603 │       │       │      │       │       │       │               │       │        labels = labels.to(DEVICE) if CLASSIFY else data                                                                      
   604 │       │       │      │       │       │       │               │       │                                                                                                                              
   605 │       │       │      │       │       │       │               │       │        # Zero the gradient from the previous data                                                                            
   606 │       │       │      │       │       │       │               │       │        optimizer.zero_grad()                                                                                                 
   607 │       │       │      │       │       │       │               │       │                                                                                                                              
   608 │       │       │      │       │       │       │               │       │        # We pass the data from the entire batch at once, shaped to fit the ANN                                               
   609 │       │       │      │       │       │       │               │       │        pred_y = model(                                                                                                       
   610 │       │       │      │       │       │       │               │       │            data.reshape(batch_size_, INPUT_CHANNELS)                                                                         
   611 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   612 │       │       │      │       │       │       │               │       │        # Remove the extraneous dimension from the output of the network so the                                               
   613 │       │       │      │       │       │       │               │       │        #  shape matches the labels                                                                                           
   614 │       │       │      │       │       │       │               │       │        # We also need to reshape the output so that it has the number of                                                     
   615 │       │       │      │       │       │       │               │       │        #  columns necessary                                                                                                  
   616 │       │       │      │       │       │       │               │       │        pred_y = pred_y.squeeze(-1).reshape(-1, labels.size(1), labels.size(2))                                               
   617 │       │       │      │       │       │       │               │       │                                                                                                                              
   618 │       │       │      │       │       │       │               │       │        # Compute the loss based on the results                                                                               
   619 │       │       │      │       │       │       │               │       │        output = loss(pred_y, labels, domain)                                                                                 
   620 │       │       │      │       │       │       │               │       │                                                                                                                              
   621 │       │       │      │       │       │       │               │       │        # This happens in place, so we don't need to return loss_over_time                                                    
   622 │       │       │      │       │       │       │               │       │        loss_over_time.append((j, output.item()))                                                                             
   623 │       │       │      │       │       │       │               │       │                                                                                                                              
   624 │       │       │      │       │       │       │               │       │        # Backpropagate through the adjoint of the NODE to compute gradients                                                  
   625 │       │       │      │       │       │       │               │       │        #  WRT each parameter                                                                                                 
   626 │       │       │      │       │       │       │               │       │        output.backward()                                                                                                     
   627 │       │       │      │       │       │       │               │       │                                                                                                                              
   628 │       │       │      │       │       │       │               │       │        # Use the gradients calculated through backpropagation to adjust the                                                  
   629 │       │       │      │       │       │       │               │       │        #  parameters                                                                                                         
   630 │       │       │      │       │       │       │               │       │        optimizer.step()                                                                                                      
   631 │       │       │      │       │       │       │               │       │                                                                                                                              
   632 │       │       │      │       │       │       │               │       │        # If this is the first iteration, or a multiple of 10, present the                                                    
   633 │       │       │      │       │       │       │               │       │        #  user with a progress report                                                                                        
   634 │       │       │      │       │       │       │               │       │        if (itr == 1) or (itr % 10 == 0):                                                                                     
   635 │       │       │      │       │       │       │               │       │            print(f"Iter {itr:04d} Batch {j}: loss = {output.item():.6f}")                                                    
   636 │       │       │      │       │       │       │               │       │                                                                                                                              
   637 │       │       │      │       │       │       │               │       │                                                                                                                              
   638 │       │       │      │       │       │       │               │       │def rnn_training_epoch(itr: int, loader: DataLoader, model: RNN,                                                              
   639 │       │       │      │       │       │       │               │       │                       readout: nn.Linear, optimizer: optim.AdamW,                                                            
   640 │       │       │      │       │       │       │               │       │                       loss_over_time: list, domain: torch.Tensor, info: dict, toy_data: bool=False):                         
   641 │       │       │      │       │       │       │               │       │                                                                                                                              
   642 │       │       │      │       │       │       │               │       │    for j, (data, labels) in enumerate(loader):                                                                               
   643 │       │       │      │       │       │       │               │       │        # Check how many patients are in the batch (as it may be less than                                                    
   644 │       │       │      │       │       │       │               │       │        #  BATCH_SIZE if it's the last batch)                                                                                 
   645 │       │       │      │       │       │       │               │       │        batch_size_ = data.size(0)                                                                                            
   646 │       │       │      │       │       │       │               │       │        # Ensure we have assigned the data and labels to the correct                                                          
   647 │       │       │      │       │       │       │               │       │        #  processing device                                                                                                  
   648 │       │       │      │       │       │       │               │       │        if CORT_ONLY:                                                                                                         
   649 │       │       │      │       │       │       │               │       │            # If we are only using CORT, we can discard the middle column as it                                               
   650 │       │       │      │       │       │       │               │       │            #  contains the ACTH concentrations                                                                               
   651 │       │       │      │       │       │       │               │       │            data = data[...,2]                                                                                                
   652 │       │       │      │       │       │       │               │       │        elif toy_data and INPUT_CHANNELS == 2:                                                                                
   653 │       │       │      │       │       │       │               │       │            data = data[...,[2,3]]                                                                                            
   654 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   655 │       │       │      │       │       │       │               │       │            data = data[...,1:]                                                                                               
   656 │       │       │      │       │       │       │               │       │        data = data.double().to(DEVICE)                                                                                       
   657 │       │       │      │       │       │       │               │       │        labels = labels.to(DEVICE) if CLASSIFY else data                                                                      
   658 │       │       │      │       │       │       │               │       │                                                                                                                              
   659 │       │       │      │       │       │       │               │       │        # Zero the gradient from the previous data                                                                            
   660 │       │       │      │       │       │       │               │       │        optimizer.zero_grad()                                                                                                 
   661 │       │       │      │       │       │       │               │       │                                                                                                                              
   662 │       │       │      │       │       │       │               │       │        # We pass the data from the entire batch at once, shaped to fit the ANN                                               
   663 │       │       │      │       │       │       │               │       │        pred_y = model(                                                                                                       
   664 │       │       │      │       │       │       │               │       │                data.reshape(batch_size_, INPUT_CHANNELS)                                                                     
   665 │       │       │      │       │       │       │               │       │                )                                                                                                             
   666 │       │       │      │       │       │       │               │       │        # Remove the extraneous dimension from the output of the network so the                                               
   667 │       │       │      │       │       │       │               │       │        #  shape matches the labels                                                                                           
   668 │       │       │      │       │       │       │               │       │        pred_y = readout(pred_y).squeeze(-1).reshape(                                                                         
   669 │       │       │      │       │       │       │               │       │                -1, labels.size(1), labels.size(2)                                                                            
   670 │       │       │      │       │       │       │               │       │                ) if CLASSIFY else pred_y.squeeze(-1)                                                                         
   671 │       │       │      │       │       │       │               │       │                                                                                                                              
   672 │       │       │      │       │       │       │               │       │        # Compute the loss based on the results                                                                               
   673 │       │       │      │       │       │       │               │       │        output = loss(pred_y, labels, domain)                                                                                 
   674 │       │       │      │       │       │       │               │       │                                                                                                                              
   675 │       │       │      │       │       │       │               │       │        # This happens in place, so we don't need to return loss_over_time                                                    
   676 │       │       │      │       │       │       │               │       │        loss_over_time.append((j, output.item()))                                                                             
   677 │       │       │      │       │       │       │               │       │                                                                                                                              
   678 │       │       │      │       │       │       │               │       │        # Backpropagate through the adjoint of the NODE to compute gradients                                                  
   679 │       │       │      │       │       │       │               │       │        #  WRT each parameter                                                                                                 
   680 │       │       │      │       │       │       │               │       │        output.backward()                                                                                                     
   681 │       │       │      │       │       │       │               │       │                                                                                                                              
   682 │       │       │      │       │       │       │               │       │        # Use the gradients calculated through backpropagation to adjust the                                                  
   683 │       │       │      │       │       │       │               │       │        #  parameters                                                                                                         
   684 │       │       │      │       │       │       │               │       │        optimizer.step()                                                                                                      
   685 │       │       │      │       │       │       │               │       │                                                                                                                              
   686 │       │       │      │       │       │       │               │       │        # If this is the first iteration, or a multiple of 10, present the                                                    
   687 │       │       │      │       │       │       │               │       │        #  user with a progress report                                                                                        
   688 │       │       │      │       │       │       │               │       │        if (itr == 1) or (itr % 10 == 0):                                                                                     
   689 │       │       │      │       │       │       │               │       │            print(f"Iter {itr:04d} Batch {j}: loss = {output.item():.6f}")                                                    
   690 │       │       │      │       │       │       │               │       │                                                                                                                              
   691 │       │       │      │       │       │       │               │       │                                                                                                                              
   692 │       │       │      │       │       │       │               │       │def loss(pred_y: torch.Tensor, labels: torch.Tensor,                                                                          
   693 │       │       │      │       │       │       │               │       │         dense_pred_y: torch.Tensor | None=None,                                                                              
   694 │       │       │      │       │       │       │               │       │         domain: torch.Tensor | None=None, params: dict={}):                                                                  
   695 │       │       │      │       │       │       │               │       │    """To compute the loss with potential mechanistic components"""                                                           
   696 │       │       │      │       │       │       │               │       │    if CLASSIFY:                                                                                                              
   697 │       │       │      │       │       │       │               │       │        return binary_cross_entropy_with_logits(pred_y, labels)                                                               
   698 │       │       │      │       │       │       │               │       │                                                                                                                              
   699 │       │       │      │       │       │       │               │       │    if MECHANISTIC:                                                                                                           
   700 │       │       │      │       │       │       │               │       │        mech_loss_total = 0                                                                                                   
   701 │       │       │      │       │       │       │               │       │        # We loop through all of the patients in the batch and compute the                                                    
   702 │       │       │      │       │       │       │               │       │        #  mechanistic loss for each (I can probably get this to run in one                                                   
   703 │       │       │      │       │       │       │               │       │        #  shot, but this is easier for the moment).                                                                          
   704 │       │       │      │       │       │       │               │       │        for y in dense_pred_y.reshape(BATCH_SIZE, domain.size(0), INPUT_CHANNELS).to(DEVICE):                                 
   705 │       │       │      │       │       │       │               │       │            mech_loss = mechanistic_loss(y, domain, params)                                                                   
   706 │       │       │      │       │       │       │               │       │            mech_loss_total += mech_loss                                                                                      
   707 │       │       │      │       │       │       │               │       │        mech_loss = mech_loss_total/BATCH_SIZE                                                                                
   708 │       │       │      │       │       │       │               │       │        data_loss = mse_loss(pred_y, labels.reshape(pred_y.shape))                                                            
   709 │       │       │      │       │       │       │               │       │        return (mech_loss + data_loss)/2                                                                                      
   710 │       │       │      │       │       │       │               │       │                                                                                                                              
   711 │       │       │      │       │       │       │               │       │    return mse_loss(pred_y, labels.reshape(pred_y.shape))                                                                     
   712 │       │       │      │       │       │       │               │       │                                                                                                                              
   713 │       │       │      │       │       │       │               │       │                                                                                                                              
   714 │       │       │      │       │       │       │               │       │def mechanistic_loss(dense_pred_y: torch.Tensor, domain: torch.Tensor,                                                        
   715 │       │       │      │       │       │       │               │       │                     params: dict):                                                                                           
   716 │       │       │      │       │       │       │               │       │    """Here we combine the predicted y with the mechanistic knowledge and then                                                
   717 │       │       │      │       │       │       │               │       │    compute the loss against the experimental data"""                                                                         
   718 │       │       │      │       │       │       │               │       │                                                                                                                              
   719 │       │       │      │       │       │       │               │       │    pred_dy = torch.zeros_like(dense_pred_y).to(DEVICE)                                                                       
   720 │       │   10% │      │  1%   │       │       │               │       │    pred_dy[:,0] = torch.autograd.grad(                                                                                       
   721 │       │       │      │       │       │       │               │       │        dense_pred_y[...,0], domain,                                                                                          
   722 │       │       │      │       │       │       │               │       │        grad_outputs=torch.ones_like(domain).to(DEVICE),                                                                      
   723 │       │       │      │       │       │       │               │       │        retain_graph=True,                                                                                                    
   724 │       │       │      │       │       │       │               │       │        create_graph=True,                                                                                                    
   725 │       │       │      │       │       │       │               │       │    )[0]                                                                                                                      
   726 │       │   10% │      │  1%   │       │       │               │       │    pred_dy[:,1] = torch.autograd.grad(                                                                                       
   727 │       │       │      │       │       │       │               │       │        dense_pred_y[...,1], domain,                                                                                          
   728 │       │       │      │       │       │       │               │       │        grad_outputs=torch.ones_like(domain),                                                                                 
   729 │       │       │      │       │       │       │               │       │        retain_graph=True,                                                                                                    
   730 │       │       │      │       │       │       │               │       │        create_graph=True                                                                                                     
   731 │       │       │      │       │       │       │               │       │    )[0]                                                                                                                      
   732 │       │   10% │      │  1%   │       │       │               │       │    pred_dy[:,2] = torch.autograd.grad(                                                                                       
   733 │       │       │      │       │       │       │               │       │        dense_pred_y[...,2], domain,                                                                                          
   734 │       │       │      │       │       │       │               │       │        grad_outputs=torch.ones_like(domain),                                                                                 
   735 │       │       │      │       │       │       │               │       │        retain_graph=True,                                                                                                    
   736 │       │       │      │       │       │       │               │       │        create_graph=True                                                                                                     
   737 │       │       │      │       │       │       │               │       │    )[0]                                                                                                                      
   738 │       │   10% │      │  1%   │       │       │               │       │    pred_dy[:,3] = torch.autograd.grad(                                                                                       
   739 │       │       │      │       │       │       │               │       │        dense_pred_y[...,3], domain,                                                                                          
   740 │       │       │      │       │       │       │               │       │        grad_outputs=torch.ones_like(domain),                                                                                 
   741 │       │       │      │       │       │       │               │       │        retain_graph=True,                                                                                                    
   742 │       │       │      │       │       │       │               │       │        create_graph=True                                                                                                     
   743 │       │       │      │       │       │       │               │       │    )[0]                                                                                                                      
   744 │       │       │      │       │       │       │               │       │    mechanistic_dy = torch.zeros_like(dense_pred_y).to(DEVICE)                                                                
   745 │       │       │      │       │       │       │               │       │    mechanistic_dy[...,0] = params['k_stress']*((params['Ki']**params['n2'])/(params['Ki']**params['n2'] + torch.sign(dense_  
   746 │       │       │      │       │       │       │               │       │    mechanistic_dy[...,1] = params['KP2']*((params['Ki']**params['n2'])/(params['Ki']**params['n2'] + torch.sign(dense_pred_  
   747 │       │       │      │       │       │       │               │       │    mechanistic_dy[...,2] = params['KP3']*dense_pred_y[...,0] - params['VS5']*(dense_pred_y[...,2]/(params['Km3'] + dense_pr  
   748 │       │       │      │       │       │       │               │       │    mechanistic_dy[...,3] = params['Kb']*dense_pred_y[...,2]*(params['Gtot'] - dense_pred_y[...,3]) + params['VS2']*((dense_  
   749 │       │       │      │       │  31%  │   22M │▁▁   4%        │       │    return mse_loss(pred_dy, mechanistic_dy)                                                                                  
   750 │       │       │      │       │       │       │               │       │                                                                                                                              
   751 │       │       │      │       │       │       │               │       │                                                                                                                              
   752 │       │       │      │       │       │       │               │       │def stress(domain):                                                                                                           
   753 │       │       │      │       │       │       │               │       │    """Placeholder for adding stress to the system"""                                                                         
   754 │       │       │      │       │       │       │               │       │    return 5                                                                                                                  
   755 │       │       │      │       │       │       │               │       │                                                                                                                              
   756 │       │       │      │       │       │       │               │       │                                                                                                                              
   757 │       │       │      │       │       │       │               │       │def save_network(model: NeuralCDE | NeuralODE | ANN | RNN,                                                                    
   758 │       │       │      │       │       │       │               │       │                 readout: nn.Linear | None, optimizer: optim.AdamW,                                                           
   759 │       │       │      │       │       │       │               │       │                 info: dict):                                                                                                 
   760 │       │       │      │       │       │       │               │       │    """Save the network state_dict and the training hyperparameters in the                                                    
   761 │       │       │      │       │       │       │               │       │    relevant directory"""                                                                                                     
   762 │       │       │      │       │       │       │               │       │    # Access the necessary variables from the info dictionary                                                                 
   763 │       │       │      │       │       │       │               │       │    virtual = info.get("virtual")                                                                                             
   764 │       │       │      │       │       │       │               │       │    ctrl_num = info.get("ctrl_num")                                                                                           
   765 │       │       │      │       │       │       │               │       │    control_combination = info.get("control_combination")                                                                     
   766 │       │       │      │       │       │       │               │       │    mdd_num = info.get("mdd_num")                                                                                             
   767 │       │       │      │       │       │       │               │       │    mdd_combination = info.get("mdd_combination")                                                                             
   768 │       │       │      │       │       │       │               │       │    by_lab = info.get("by_lab")                                                                                               
   769 │       │       │      │       │       │       │               │       │    itr = info.get("itr")                                                                                                     
   770 │       │       │      │       │       │       │               │       │    runtime = info.get("runtime")                                                                                             
   771 │       │       │      │       │       │       │               │       │    loss_over_time = info.get("loss_over_time")                                                                               
   772 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   773 │       │       │      │       │       │       │               │       │                                                                                                                              
   774 │       │       │      │       │       │       │               │       │    # Set the directory name based on which type of dataset was used for the                                                  
   775 │       │       │      │       │       │       │               │       │    #  training                                                                                                               
   776 │       │       │      │       │       │       │               │       │    if not virtual and len(PATIENT_GROUPS) == 1:                                                                              
   777 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   778 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   779 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   780 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}/'                                                                                           
   781 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   782 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
   783 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   784 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   785 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   786 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
   787 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   788 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   789 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   790 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   791 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   792 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
   793 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   794 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
   795 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   796 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
   797 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   798 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
   799 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]} '                                                                                           
   800 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
   801 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1]} {mdd_num} {mdd_combination}/'                                                               
   802 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   803 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   804 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   805 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
   806 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   807 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
   808 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   809 │       │       │      │       │       │       │               │       │                                                                                                                              
   810 │       │       │      │       │       │       │               │       │    # Make sure the directory exists before we try to write anything                                                          
   811 │       │       │      │       │       │       │               │       │    if not os.path.exists(directory):                                                                                         
   812 │       │       │      │       │       │       │               │       │        os.makedirs(directory)                                                                                                
   813 │       │       │      │       │       │       │               │       │                                                                                                                              
   814 │       │       │      │       │       │       │               │       │    # Set the filename for the network state_dict                                                                             
   815 │       │       │      │       │       │       │               │       │    if INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                        
   816 │       │       │      │       │       │       │               │       │        filename = (                                                                                                          
   817 │       │       │      │       │       │       │               │       │            f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                           
   818 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}{INDIVIDUAL_NUMBER}_'                                                                        
   819 │       │       │      │       │       │       │               │       │            f'batchsize{BATCH_SIZE}_'                                                                                         
   820 │       │       │      │       │       │       │               │       │            f'{itr}ITER_{NORMALIZE_STANDARDIZE}_'                                                                             
   821 │       │       │      │       │       │       │               │       │            f'smoothing{LABEL_SMOOTHING}_'                                                                                    
   822 │       │       │      │       │       │       │               │       │            f'dropout{DROPOUT}.txt'                                                                                           
   823 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   824 │       │       │      │       │       │       │               │       │    elif not virtual and len(PATIENT_GROUPS) == 1:                                                                            
   825 │       │       │      │       │       │       │               │       │        filename = (                                                                                                          
   826 │       │       │      │       │       │       │               │       │            f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                           
   827 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}{INDIVIDUAL_NUMBER}_'                                                                        
   828 │       │       │      │       │       │       │               │       │            f'batchsize{BATCH_SIZE}_'                                                                                         
   829 │       │       │      │       │       │       │               │       │            f'{itr}ITER_{NORMALIZE_STANDARDIZE}_'                                                                             
   830 │       │       │      │       │       │       │               │       │            f'smoothing{LABEL_SMOOTHING}_'                                                                                    
   831 │       │       │      │       │       │       │               │       │            f'dropout{DROPOUT}.txt'                                                                                           
   832 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   833 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
   834 │       │       │      │       │       │       │               │       │        filename = (                                                                                                          
   835 │       │       │      │       │       │       │               │       │            f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                           
   836 │       │       │      │       │       │       │               │       │            f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                                
   837 │       │       │      │       │       │       │               │       │            f'batchsize{BATCH_SIZE}_'                                                                                         
   838 │       │       │      │       │       │       │               │       │            f'{itr}ITER_{NORMALIZE_STANDARDIZE}_'                                                                             
   839 │       │       │      │       │       │       │               │       │            f'smoothing{LABEL_SMOOTHING}_'                                                                                    
   840 │       │       │      │       │       │       │               │       │            f'dropout{DROPOUT}.txt'                                                                                           
   841 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   842 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   843 │       │       │      │       │       │       │               │       │        filename = (                                                                                                          
   844 │       │       │      │       │       │       │               │       │            f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                           
   845 │       │       │      │       │       │       │               │       │            f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                              
   846 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                        
   847 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                            
   848 │       │       │      │       │       │       │               │       │            f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                          
   849 │       │       │      │       │       │       │               │       │            f'{NUM_PER_PATIENT}perPatient_'                                                                                   
   850 │       │       │      │       │       │       │               │       │            f'batchsize{BATCH_SIZE}_'                                                                                         
   851 │       │       │      │       │       │       │               │       │            f'{itr}ITER_{NORMALIZE_STANDARDIZE}_'                                                                             
   852 │       │       │      │       │       │       │               │       │            f'smoothing{LABEL_SMOOTHING}_'                                                                                    
   853 │       │       │      │       │       │       │               │       │            f'dropout{DROPOUT}'                                                                                               
   854 │       │       │      │       │       │       │               │       │            f'{"_byLab" if by_lab else ""}.txt'                                                                               
   855 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   856 │       │       │      │       │       │       │               │       │                                                                                                                              
   857 │       │       │      │       │       │       │               │       │    # Add _setup to the filename before the .txt extension                                                                    
   858 │       │       │      │       │       │       │               │       │    setup_filename = "".join([filename[:-4], "_setup", filename[-4:]])                                                        
   859 │       │       │      │       │       │       │               │       │                                                                                                                              
   860 │       │       │      │       │       │       │               │       │    # Add _readout to the filename before the .txt extension if readout is an                                                 
   861 │       │       │      │       │       │       │               │       │    #  instance of nn.Linear                                                                                                  
   862 │       │       │      │       │       │       │               │       │    readout_filename = None                                                                                                   
   863 │       │       │      │       │       │       │               │       │    if isinstance(readout, nn.Linear):                                                                                        
   864 │       │       │      │       │       │       │               │       │        readout_filename = "".join([filename[:-4], '_readout', filename[-4:]])                                                
   865 │       │       │      │       │       │       │               │       │                                                                                                                              
   866 │       │       │      │       │       │       │               │       │    # Save the network state dictionary                                                                                       
   867 │       │       │      │       │       │       │               │       │    torch.save(                                                                                                               
   868 │       │       │      │       │       │       │               │       │        model.state_dict(), os.path.join(directory, filename)                                                                 
   869 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   870 │       │       │      │       │       │       │               │       │    # If defined, save the readout state dictionary                                                                           
   871 │       │       │      │       │       │       │               │       │    if readout_filename:                                                                                                      
   872 │       │       │      │       │       │       │               │       │        torch.save(                                                                                                           
   873 │       │       │      │       │       │       │               │       │            readout.state_dict(), os.path.join(directory, readout_filename)                                                   
   874 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   875 │       │       │      │       │       │       │               │       │                                                                                                                              
   876 │       │       │      │       │       │       │               │       │    # Write the hyperparameters to the setup file                                                                             
   877 │       │       │      │       │       │       │               │       │    with open(os.path.join(directory, setup_filename), 'w+') as file:                                                         
   878 │       │       │      │       │       │       │               │       │        file.write(                                                                                                           
   879 │       │       │      │       │       │       │               │       │            f'Model Setup for {METHOD+"virtual " if virtual else ""}'                                                         
   880 │       │       │      │       │       │       │               │       │            '{PATIENT_GROUPS} Trained Network:\n\n'                                                                           
   881 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   882 │       │       │      │       │       │       │               │       │        file.write(                                                                                                           
   883 │       │       │      │       │       │       │               │       │            '{NETWORK_TYPE} Network Architecture Parameters\n'                                                                
   884 │       │       │      │       │       │       │               │       │            f'Input channels={INPUT_CHANNELS}\n'                                                                              
   885 │       │       │      │       │       │       │               │       │            f'Hidden channels={HDIM}\n'                                                                                       
   886 │       │       │      │       │       │       │               │       │            f'Output channels={OUTPUT_CHANNELS}\n\n'                                                                          
   887 │       │       │      │       │       │       │               │       │            'Training hyperparameters\n'                                                                                      
   888 │       │       │      │       │       │       │               │       │            f'Optimizer={optimizer}'                                                                                          
   889 │       │       │      │       │       │       │               │       │            f'Training Iterations={itr}\n'                                                                                    
   890 │       │       │      │       │       │       │               │       │            f'Learning rate={LR}\n'                                                                                           
   891 │       │       │      │       │       │       │               │       │            f'Weight decay={DECAY}\n'                                                                                         
   892 │       │       │      │       │       │       │               │       │            f'Optimizer reset frequency={OPT_RESET}\n\n'                                                                      
   893 │       │       │      │       │       │       │               │       │            'Dropout probability '                                                                                            
   894 │       │       │      │       │       │       │               │       │            f'(after initial linear layer before NCDE): {DROPOUT}\n'                                                          
   895 │       │       │      │       │       │       │               │       │            'Training Data Selection Parameters\n'                                                                            
   896 │       │       │      │       │       │       │               │       │            '(If not virtual, the only important params are the groups'                                                       
   897 │       │       │      │       │       │       │               │       │            ' and whether data was normalized/standardized)\n'                                                                
   898 │       │       │      │       │       │       │               │       │            f'Patient groups={PATIENT_GROUPS}\n'                                                                              
   899 │       │       │      │       │       │       │               │       │            f'Augmentation strategy={METHOD}\n'                                                                               
   900 │       │       │      │       │       │       │               │       │            f'Noise Magnitude={NOISE_MAGNITUDE}\n'                                                                            
   901 │       │       │      │       │       │       │               │       │            f'Normalized/standardized={NORMALIZE_STANDARDIZE}\n'                                                              
   902 │       │       │      │       │       │       │               │       │            'Number of virtual patients'                                                                                      
   903 │       │       │      │       │       │       │               │       │            f' per real patient={NUM_PER_PATIENT}\n'                                                                          
   904 │       │       │      │       │       │       │               │       │            f'Label smoothing factor={LABEL_SMOOTHING}\n'                                                                     
   905 │       │       │      │       │       │       │               │       │            'Test Patient Combinations:\n'                                                                                    
   906 │       │       │      │       │       │       │               │       │            f'Control: {control_combination}\n'                                                                               
   907 │       │       │      │       │       │       │               │       │            f'MDD: {mdd_combination}\n'                                                                                       
   908 │       │       │      │       │       │       │               │       │            f'Training batch size={BATCH_SIZE}\n'                                                                             
   909 │       │       │      │       │       │       │               │       │            'Training Results:\n'                                                                                             
   910 │       │       │      │       │       │       │               │       │            f'Runtime={runtime}\n'                                                                                            
   911 │       │       │      │       │       │       │               │       │            f'Loss over time={loss_over_time}'                                                                                
   912 │       │       │      │       │       │       │               │       │            # Currently not using:                                                                                            
   913 │       │       │      │       │       │       │               │       │            # f'ATOL={ATOL}\nRTOL={RTOL}\n'                                                                                   
   914 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   915 │       │       │      │       │       │       │               │       │                                                                                                                              
   916 │       │       │      │       │       │       │               │       │                                                                                                                              
   917 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
   918 │       │       │      │       │       │       │               │       │#                                 MIT License                                 #                                               
   919 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
   920 │       │       │      │       │       │       │               │       │#     Copyright (c) 2022 Christopher John Parker <parkecp@mail.uc.edu>        #                                               
   921 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   922 │       │       │      │       │       │       │               │       │# Permission is hereby granted, free of charge, to any person obtaining a     #                                               
   923 │       │       │      │       │       │       │               │       │# copy of this software and associated documentation files (the "Software"),  #                                               
   924 │       │       │      │       │       │       │               │       │# to deal in the Software without restriction, including without limitation   #                                               
   925 │       │       │      │       │       │       │               │       │# the rights to use, copy, modify, merge, publish, distribute, sublicense,    #                                               
   926 │       │       │      │       │       │       │               │       │# and/or sell copies of the Software, and to permit persons to whom the       #                                               
   927 │       │       │      │       │       │       │               │       │# Software is furnished to do so, subject to the following conditions:        #                                               
   928 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   929 │       │       │      │       │       │       │               │       │# The above copyright notice and this permission notice shall be included in  #                                               
   930 │       │       │      │       │       │       │               │       │# all copies or substantial portions of the Software.                         #                                               
   931 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   932 │       │       │      │       │       │       │               │       │# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  #                                               
   933 │       │       │      │       │       │       │               │       │# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,    #                                               
   934 │       │       │      │       │       │       │               │       │# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE #                                               
   935 │       │       │      │       │       │       │               │       │# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER      #                                               
   936 │       │       │      │       │       │       │               │       │# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING     #                                               
   937 │       │       │      │       │       │       │               │       │# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER         #                                               
   938 │       │       │      │       │       │       │               │       │# DEALINGS IN THE SOFTWARE.                                                   #                                               
   939 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   940 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
   941 │       │       │      │       │       │       │               │       │                                                                                                                              
   942 │       │       │      │       │       │       │               │       │                                                                                                                              
       │       │       │      │       │       │       │               │       │                                                                                                                              
╶──────┼───────┼───────┼──────┼───────┼───────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │      │       │       │       │               │       │function summary for /home/ec2-user/NCDE-model/training.py                                                                    
   243 │       │       │      │       │  73%  │   11M │█   2%         │       │Scalene.model_init                                                                                                            
   518 │       │   13% │   4% │  2%   │  20%  │  227M │█████████  61% │     6 │Scalene.node_training_epoch                                                                                                   
   714 │       │   39% │      │  5%   │  31%  │   22M │██   4%        │       │Scalene.mechanistic_loss                                                                                                      
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                                                                                              
Top AVERAGE memory consumption, by line:
(1)   523:     5 MB                                                                                                                                                                                           
Top PEAK memory consumption, by line:
(1)   546:   227 MB                                                                                                                                                                                           
(2)   576:    58 MB                                                                                                                                                                                           
(3)   572:    35 MB                                                                                                                                                                                           
(4)   749:    22 MB                                                                                                                                                                                           
(5)   258:    11 MB                                                                                                                                                                                           
                                                         /home/ec2-user/NCDE-model/classification.py: % of time =   1.63% (2.003s) out of 2m:2.595s.                                                         
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                                                                                              
       │Time   │–––––– │––––… │–––––– │Memory │–––––– │–––––––––––    │Copy   │                                                                                                                              
  Line │Python │native │syst… │GPU    │Python │peak   │timeline/%     │(MB/s) │/home/ec2-user/NCDE-model/classification.py                                                                                   
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │      │       │       │       │               │       │# File Name: galerkin_node.py                                                                                                 
     2 │       │       │      │       │       │       │               │       │# Author: Christopher Parker                                                                                                  
     3 │       │       │      │       │       │       │               │       │# Created: Tue May 30, 2023 | 03:04P EDT                                                                                      
     4 │       │       │      │       │       │       │               │       │# Last Modified: Thu Sep 14, 2023 | 01:44P EDT                                                                                
     5 │       │       │      │       │       │       │               │       │                                                                                                                              
     6 │       │       │      │       │       │       │               │       │"Root file for classification of augmented TSST or simulation data"                                                           
     7 │       │       │      │       │       │       │               │       │                                                                                                                              
     8 │       │       │      │       │       │       │               │       │# Network architecture parameters                                                                                             
     9 │       │       │      │       │       │       │               │       │NETWORK_TYPE = 'NODE' # NCDE, NODE, ANN or RNN                                                                                
    10 │       │       │      │       │       │       │               │       │# Should be 40 for Toy dataset or 22 for others if using ANN or RNN                                                           
    11 │       │       │      │       │       │       │               │       │# If using NCDE, should be the number of vars plus 1, since we include time                                                   
    12 │       │       │      │       │       │       │               │       │# If using NODE, should just be the number of vars                                                                            
    13 │       │       │      │       │       │       │               │       │INPUT_CHANNELS = 4                                                                                                            
    14 │       │       │      │       │       │       │               │       │HDIM = 32                                                                                                                     
    15 │       │       │      │       │       │       │               │       │# Needs to be 2 for NODE (even though it will be run through readout to combine down to 1)                                    
    16 │       │       │      │       │       │       │               │       │OUTPUT_CHANNELS = 4                                                                                                           
    17 │       │       │      │       │       │       │               │       │# Only necessary for RNN                                                                                                      
    18 │       │       │      │       │       │       │               │       │N_RECURS = 3                                                                                                                  
    19 │       │       │      │       │       │       │               │       │CLASSIFY = False                                                                                                              
    20 │       │       │      │       │       │       │               │       │MECHANISTIC = True                                                                                                            
    21 │       │       │      │       │       │       │               │       │                                                                                                                              
    22 │       │       │      │       │       │       │               │       │# Training hyperparameters                                                                                                    
    23 │       │       │      │       │       │       │               │       │ITERS = 10                                                                                                                    
    24 │       │       │      │       │       │       │               │       │SAVE_FREQ = 100                                                                                                               
    25 │       │       │      │       │       │       │               │       │LR = 3e-3                                                                                                                     
    26 │       │       │      │       │       │       │               │       │DECAY = 1e-6                                                                                                                  
    27 │       │       │      │       │       │       │               │       │OPT_RESET = 1000                                                                                                              
    28 │       │       │      │       │       │       │               │       │ATOL = 1e-8                                                                                                                   
    29 │       │       │      │       │       │       │               │       │RTOL = 1e-6                                                                                                                   
    30 │       │       │      │       │       │       │               │       │                                                                                                                              
    31 │       │       │      │       │       │       │               │       │# Training data selection parameters                                                                                          
    32 │       │       │      │       │       │       │               │       │POP = 'toydata'                                                                                                               
    33 │       │       │      │       │       │       │               │       │PATIENT_GROUPS = ['Control'] # Only necessary for POP='NelsonOnly'                                                            
    34 │       │       │      │       │       │       │               │       │INDIVIDUAL_NUMBER = 0                                                                                                         
    35 │       │       │      │       │       │       │               │       │METHOD = 'Uniform'                                                                                                            
    36 │       │       │      │       │       │       │               │       │NORMALIZE_STANDARDIZE = None                                                                                                  
    37 │       │       │      │       │       │       │               │       │NOISE_MAGNITUDE = 0.05                                                                                                        
    38 │       │       │      │       │       │       │               │       │NUM_PER_PATIENT = 100                                                                                                         
    39 │       │       │      │       │       │       │               │       │POP_NUMBER = 0                                                                                                                
    40 │       │       │      │       │       │       │               │       │BATCH_SIZE = 1                                                                                                                
    41 │       │       │      │       │       │       │               │       │LABEL_SMOOTHING = 0                                                                                                           
    42 │       │       │      │       │       │       │               │       │DROPOUT = 0.5                                                                                                                 
    43 │       │       │      │       │       │       │               │       │CORT_ONLY = False                                                                                                             
    44 │       │       │      │       │       │       │               │       │# These variables determine which population groups to train/test using                                                       
    45 │       │       │      │       │       │       │               │       │#  Should be 3 for both if using NelsonOnly data, 11 for control and 12 for MDD                                               
    46 │       │       │      │       │       │       │               │       │#  if using FullVPOP or 12 for control and 10 for MDD if using FullVPOPByLab                                                  
    47 │       │       │      │       │       │       │               │       │CTRL_RANGE = list(range(11))                                                                                                  
    48 │       │       │      │       │       │       │               │       │MDD_RANGE = list(range(12))                                                                                                   
    49 │       │       │      │       │       │       │               │       │                                                                                                                              
    50 │       │       │      │       │       │       │               │       │# End time for use with toy dataset (2.35 hours, 10 hours or 24 hours)                                                        
    51 │       │       │      │       │       │       │               │       │T_END = 24                                                                                                                    
    52 │       │       │      │       │       │       │               │       │                                                                                                                              
    53 │       │       │      │       │       │       │               │       │                                                                                                                              
    54 │       │       │      │       │       │       │               │       │import sys                                                                                                                    
    55 │       │       │      │       │  64%  │  120M │▁▁▁▁▁▁▁▁▁  22% │     7 │import torch                                                                                                                  
    56 │       │       │      │       │       │       │               │       │                                                                                                                              
    57 │       │       │      │       │       │       │               │       │# from typing import Tuple                                                                                                    
    58 │       │       │      │       │       │       │               │       │from training import train                                                                                                    
    59 │       │       │      │       │       │       │               │       │from testing import test                                                                                                      
    60 │       │       │      │       │       │       │               │       │                                                                                                                              
    61 │       │       │      │       │       │       │               │       │                                                                                                                              
    62 │       │       │      │       │       │       │               │       │# Define the device with which to train networks                                                                              
    63 │       │       │      │       │       │       │               │       │DEVICE = torch.device('cuda')                                                                                                 
    64 │       │       │      │       │       │       │               │       │                                                                                                                              
    65 │       │       │      │       │       │       │               │       │# These are the permutations of test patients selected from each group                                                        
    66 │       │       │      │       │       │       │               │       │#  (hard-coded for reproducibility and easy reference)                                                                        
    67 │       │       │      │       │       │       │               │       │                                                                                                                              
    68 │       │       │      │       │       │       │               │       │PERMUTATIONS = {                                                                                                              
    69 │       │       │      │       │       │       │               │       │    'nelsononly': [                                                                                                           
    70 │       │       │      │       │       │       │               │       │        # Control                                                                                                             
    71 │       │       │      │       │       │       │               │       │        [13, 11,  8, 14,  6,  2, 12, 10,  5,  1,  0,  9,  3,  7,  4],                                                         
    72 │       │       │      │       │       │       │               │       │        # Atypical                                                                                                            
    73 │       │       │      │       │       │       │               │       │        [ 0,  7, 12,  8, 11,  2,  6,  9,  3,  5,  4,  1, 13, 10],                                                             
    74 │       │       │      │       │       │       │               │       │        # Melancholic                                                                                                         
    75 │       │       │      │       │       │       │               │       │        [10, 13,  4,  2,  3, 12, 14,  6,  8,  9,  5,  7,  0, 11,  1],                                                         
    76 │       │       │      │       │       │       │               │       │        # Neither                                                                                                             
    77 │       │       │      │       │       │       │               │       │        [ 5, 12,  7, 13, 11,  9,  4,  1,  0,  2,  3, 10,  6,  8]                                                              
    78 │       │       │      │       │       │       │               │       │    ],                                                                                                                        
    79 │       │       │      │       │       │       │               │       │    'plusablesonmdd0and12': [                                                                                                 
    80 │       │       │      │       │       │       │               │       │        # Control                                                                                                             
    81 │       │       │      │       │       │       │               │       │        [13, 11,  8, 14,  6,  2, 12, 10,  5,  1,  0,  9,  3,  7,  4],                                                         
    82 │       │       │      │       │       │       │               │       │        # Atypical                                                                                                            
    83 │       │       │      │       │       │       │               │       │        [11, 12,  6, 10, 13,  2,  9,  3,  8, 14,  1,  4,  5,  7, 15,  0]                                                      
    84 │       │       │      │       │       │       │               │       │    ],                                                                                                                        
    85 │       │       │      │       │       │       │               │       │    'fullvpop': [                                                                                                             
    86 │       │       │      │       │       │       │               │       │        # Control                                                                                                             
    87 │       │       │      │       │       │       │               │       │        [30, 11, 3, 38, 29, 35, 1, 31, 14, 19, 39, 17, 23, 27, 8, 16, 22, 47,                                                 
    88 │       │       │      │       │       │       │               │       │         15, 7, 26, 33, 36, 49, 2, 37, 4, 45, 48, 20, 12, 18, 34, 42, 21, 46,                                                 
    89 │       │       │      │       │       │       │               │       │         28, 13, 50, 51, 25, 44, 40, 41, 43, 0, 6, 9, 24, 32, 10, 5],                                                         
    90 │       │       │      │       │       │       │               │       │        # MDD                                                                                                                 
    91 │       │       │      │       │       │       │               │       │        [41, 8, 15, 16, 33, 43, 3, 19, 7, 1, 11, 12, 53, 29, 55, 37, 24, 6, 54,                                               
    92 │       │       │      │       │       │       │               │       │         21, 27, 47, 13, 25, 5, 0, 30, 46, 17, 23, 36, 10, 39, 14, 18, 35, 22,                                                
    93 │       │       │      │       │       │       │               │       │         50, 45, 28, 38, 9, 49, 26, 34, 4, 32, 48, 44, 31, 42, 52, 20, 51, 40,                                                
    94 │       │       │      │       │       │       │               │       │         2]                                                                                                                   
    95 │       │       │      │       │       │       │               │       │    ],                                                                                                                        
    96 │       │       │      │       │       │       │               │       │    'fullvpopbylab': [                                                                                                        
    97 │       │       │      │       │       │       │               │       │        # Nelson                                                                                                              
    98 │       │       │      │       │       │       │               │       │        [22, 10, 50, 39, 48, 40, 15,  6, 37, 25, 34,  0, 26, 12, 41, 24, 30, 57,                                              
    99 │       │       │      │       │       │       │               │       │         49, 53, 46, 56,  4, 38,  5, 43, 19, 11, 17, 31, 29, 20, 35,  8, 52, 21,                                              
   100 │       │       │      │       │       │       │               │       │         13, 18, 32, 54, 47, 28, 36, 14,  1, 45,  9, 44,  3,  2, 16, 27, 42, 51,                                              
   101 │       │       │      │       │       │       │               │       │         33, 23, 55,  7],                                                                                                     
   102 │       │       │      │       │       │       │               │       │        # Ableson                                                                                                             
   103 │       │       │      │       │       │       │               │       │        [8, 45,  1,  2, 24,  7, 32, 40, 15, 34, 26, 13, 27, 25, 16, 18, 29, 14,                                               
   104 │       │       │      │       │       │       │               │       │         48, 38, 36, 30, 39, 35, 43, 20, 47,  6, 28,  3, 33, 49, 46, 37, 41,  0,                                              
   105 │       │       │      │       │       │       │               │       │         12, 11, 17, 44,  9, 23, 10,  4, 42, 19, 31, 22,  5, 21]                                                              
   106 │       │       │      │       │       │       │               │       │    ]                                                                                                                         
   107 │       │       │      │       │       │       │               │       │}                                                                                                                             
   108 │       │       │      │       │       │       │               │       │                                                                                                                              
   109 │       │       │      │       │       │       │               │       │                                                                                                                              
   110 │       │       │      │       │       │       │               │       │def set_patient_groups(population):                                                                                           
   111 │       │       │      │       │       │       │               │       │    if population == 'nelsononly':                                                                                            
   112 │       │       │      │       │       │       │               │       │        return PATIENT_GROUPS                                                                                                 
   113 │       │       │      │       │       │       │               │       │    elif population == 'fullvpopbylab':                                                                                       
   114 │       │       │      │       │       │       │               │       │        return ['Nelson', 'Ableson']                                                                                          
   115 │       │       │      │       │       │       │               │       │    elif population == 'plusablesonmdd0and12':                                                                                
   116 │       │       │      │       │       │       │               │       │        return ['Control', 'Atypical']                                                                                        
   117 │       │       │      │       │       │       │               │       │    elif population == 'toydata':                                                                                             
   118 │       │       │      │       │       │       │               │       │        return PATIENT_GROUPS                                                                                                 
   119 │       │       │      │       │       │       │               │       │                                                                                                                              
   120 │       │       │      │       │       │       │               │       │    return ['Control', 'MDD']                                                                                                 
   121 │       │       │      │       │       │       │               │       │                                                                                                                              
   122 │       │       │      │       │       │       │               │       │                                                                                                                              
   123 │       │       │      │       │       │       │               │       │def usage_hint():                                                                                                             
   124 │       │       │      │       │       │       │               │       │    raise(ValueError('Try again with the proper CLI arguments.\n\n'                                                           
   125 │       │       │      │       │       │       │               │       │                     'Usage:\n\tpython classification.py train/test population'                                               
   126 │       │       │      │       │       │       │               │       │                     ' (Atypical, Melancholic, or Neither)'                                                                   
   127 │       │       │      │       │       │       │               │       │                     '\n\nWhere train initiates training and test initiates '                                                 
   128 │       │       │      │       │       │       │               │       │                     'testing,\nand population is one of: "NelsonOnly",'                                                      
   129 │       │       │      │       │       │       │               │       │                     ' "FullVPOP", "FullVPOPByLab".\nIf using Nelson only '                                                   
   130 │       │       │      │       │       │       │               │       │                     'populations, include patient subtype after NelsonOnly.'                                                 
   131 │       │       │      │       │       │       │               │       │                     '\nTo change network '                                                                                   
   132 │       │       │      │       │       │       │               │       │                     'training hyperparameters, edit the constant variables '                                                 
   133 │       │       │      │       │       │       │               │       │                     'at the top of the file.\n'))                                                                            
   134 │       │       │      │       │       │       │               │       │                                                                                                                              
   135 │       │       │      │       │       │       │               │       │if __name__ == "__main__":                                                                                                    
   136 │       │       │      │       │       │       │               │       │    patient_groups = set_patient_groups(POP)                                                                                  
   137 │       │       │      │       │       │       │               │       │    if POP != 'toydata':                                                                                                      
   138 │       │       │      │       │       │       │               │       │        perms = PERMUTATIONS[POP.lower()]                                                                                     
   139 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   140 │       │       │      │       │       │       │               │       │        perms = None                                                                                                          
   141 │       │       │      │       │       │       │               │       │    if POP == 'nelsononly' and not INDIVIDUAL_NUMBER:                                                                         
   142 │       │       │      │       │       │       │               │       │        match patient_groups[1]:                                                                                              
   143 │       │       │      │       │       │       │               │       │            case 'Atypical':                                                                                                  
   144 │       │       │      │       │       │       │               │       │                perms = [perms[0], perms[1]]                                                                                  
   145 │       │       │      │       │       │       │               │       │            case 'Melancholic':                                                                                               
   146 │       │       │      │       │       │       │               │       │                perms = [perms[0], perms[2]]                                                                                  
   147 │       │       │      │       │       │       │               │       │            case 'Neither':                                                                                                   
   148 │       │       │      │       │       │       │               │       │                perms = [perms[0], perms[3]]                                                                                  
   149 │       │       │      │       │       │       │               │       │        # If not using Python 3.11:                                                                                           
   150 │       │       │      │       │       │       │               │       │        # if patient_groups[1] == "Atypical":                                                                                 
   151 │       │       │      │       │       │       │               │       │        #     perms = [perms[0], perms[1]]                                                                                    
   152 │       │       │      │       │       │       │               │       │        # elif patient_groups[1] == "Melancholic":                                                                            
   153 │       │       │      │       │       │       │               │       │        #     perms = [perms[0], perms[2]]                                                                                    
   154 │       │       │      │       │       │       │               │       │        # elif patient_groups[1] == "Neither":                                                                                
   155 │       │       │      │       │       │       │               │       │        #     perms = [perms[0], perms[3]]                                                                                    
   156 │       │       │      │       │       │       │               │       │                                                                                                                              
   157 │       │       │      │       │       │       │               │       │    try:                                                                                                                      
   158 │       │       │      │       │       │       │               │       │        if sys.argv[1].lower() == 'train':                                                                                    
   159 │       │       │      │       │       │       │               │       │            train(                                                                                                            
   160 │       │       │      │       │       │       │               │       │                hyperparameters={                                                                                             
   161 │       │       │      │       │       │       │               │       │                    'NETWORK_TYPE': NETWORK_TYPE,                                                                             
   162 │       │       │      │       │       │       │               │       │                    'INPUT_CHANNELS': INPUT_CHANNELS,                                                                         
   163 │       │       │      │       │       │       │               │       │                    'HDIM': HDIM,                                                                                             
   164 │       │       │      │       │       │       │               │       │                    'OUTPUT_CHANNELS': OUTPUT_CHANNELS,                                                                       
   165 │       │       │      │       │       │       │               │       │                    'N_RECURS': N_RECURS,                                                                                     
   166 │       │       │      │       │       │       │               │       │                    'CLASSIFY': CLASSIFY,                                                                                     
   167 │       │       │      │       │       │       │               │       │                    'MECHANISTIC': MECHANISTIC,                                                                               
   168 │       │       │      │       │       │       │               │       │                    'ITERS': ITERS,                                                                                           
   169 │       │       │      │       │       │       │               │       │                    'SAVE_FREQ': SAVE_FREQ,                                                                                   
   170 │       │       │      │       │       │       │               │       │                    'LR': LR,                                                                                                 
   171 │       │       │      │       │       │       │               │       │                    'DECAY': DECAY,                                                                                           
   172 │       │       │      │       │       │       │               │       │                    'OPT_RESET': OPT_RESET,                                                                                   
   173 │       │       │      │       │       │       │               │       │                    'ATOL': ATOL,                                                                                             
   174 │       │       │      │       │       │       │               │       │                    'RTOL': RTOL,                                                                                             
   175 │       │       │      │       │       │       │               │       │                    'PATIENT_GROUPS': patient_groups,                                                                         
   176 │       │       │      │       │       │       │               │       │                    'INDIVIDUAL_NUMBER': INDIVIDUAL_NUMBER,                                                                   
   177 │       │       │      │       │       │       │               │       │                    'METHOD': METHOD,                                                                                         
   178 │       │       │      │       │       │       │               │       │                    'NORMALIZE_STANDARDIZE': NORMALIZE_STANDARDIZE,                                                           
   179 │       │       │      │       │       │       │               │       │                    'NOISE_MAGNITUDE': NOISE_MAGNITUDE,                                                                       
   180 │       │       │      │       │       │       │               │       │                    'NUM_PER_PATIENT': NUM_PER_PATIENT,                                                                       
   181 │       │       │      │       │       │       │               │       │                    'POP_NUMBER': POP_NUMBER,                                                                                 
   182 │       │       │      │       │       │       │               │       │                    'BATCH_SIZE': BATCH_SIZE,                                                                                 
   183 │       │       │      │       │       │       │               │       │                    'LABEL_SMOOTHING': LABEL_SMOOTHING,                                                                       
   184 │       │       │      │       │       │       │               │       │                    'DROPOUT': DROPOUT,                                                                                       
   185 │       │       │      │       │       │       │               │       │                    'CORT_ONLY': CORT_ONLY,                                                                                   
   186 │       │       │      │       │       │       │               │       │                    'T_END': T_END,                                                                                           
   187 │       │       │      │       │       │       │               │       │                    'DEVICE': DEVICE,                                                                                         
   188 │       │       │      │       │       │       │               │       │                },                                                                                                            
   189 │       │       │      │       │       │       │               │       │                virtual=False,                                                                                                
   190 │       │       │      │       │       │       │               │       │                # permutations=perms,                                                                                         
   191 │       │       │      │       │       │       │               │       │                # ctrl_range=CTRL_RANGE,                                                                                      
   192 │       │       │      │       │       │       │               │       │                # mdd_range=MDD_RANGE,                                                                                        
   193 │       │       │      │       │       │       │               │       │                plus_ableson_mdd=True if POP.lower()=='plusablesonmdd0and12' else False,                                      
   194 │       │       │      │       │       │       │               │       │                toy_data=True if POP.lower()=='toydata' else False                                                            
   195 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   196 │       │       │      │       │       │       │               │       │        elif sys.argv[1].lower() == 'test':                                                                                   
   197 │       │       │      │       │       │       │               │       │            test(                                                                                                             
   198 │       │       │      │       │       │       │               │       │                hyperparameters={                                                                                             
   199 │       │       │      │       │       │       │               │       │                    'NETWORK_TYPE': NETWORK_TYPE,                                                                             
   200 │       │       │      │       │       │       │               │       │                    'INPUT_CHANNELS': INPUT_CHANNELS,                                                                         
   201 │       │       │      │       │       │       │               │       │                    'HDIM': HDIM,                                                                                             
   202 │       │       │      │       │       │       │               │       │                    'OUTPUT_CHANNELS': OUTPUT_CHANNELS,                                                                       
   203 │       │       │      │       │       │       │               │       │                    'N_RECURS': N_RECURS,                                                                                     
   204 │       │       │      │       │       │       │               │       │                    'CLASSIFY': CLASSIFY,                                                                                     
   205 │       │       │      │       │       │       │               │       │                    'MECHANISTIC': MECHANISTIC,                                                                               
   206 │       │       │      │       │       │       │               │       │                    'ITERS': ITERS,                                                                                           
   207 │       │       │      │       │       │       │               │       │                    'SAVE_FREQ': SAVE_FREQ,                                                                                   
   208 │       │       │      │       │       │       │               │       │                    'LR': LR,                                                                                                 
   209 │       │       │      │       │       │       │               │       │                    'DECAY': DECAY,                                                                                           
   210 │       │       │      │       │       │       │               │       │                    'OPT_RESET': OPT_RESET,                                                                                   
   211 │       │       │      │       │       │       │               │       │                    'ATOL': ATOL,                                                                                             
   212 │       │       │      │       │       │       │               │       │                    'RTOL': RTOL,                                                                                             
   213 │       │       │      │       │       │       │               │       │                    'PATIENT_GROUPS': patient_groups,                                                                         
   214 │       │       │      │       │       │       │               │       │                    'INDIVIDUAL_NUMBER': INDIVIDUAL_NUMBER,                                                                   
   215 │       │       │      │       │       │       │               │       │                    'METHOD': METHOD,                                                                                         
   216 │       │       │      │       │       │       │               │       │                    'NORMALIZE_STANDARDIZE': NORMALIZE_STANDARDIZE,                                                           
   217 │       │       │      │       │       │       │               │       │                    'NOISE_MAGNITUDE': NOISE_MAGNITUDE,                                                                       
   218 │       │       │      │       │       │       │               │       │                    'NUM_PER_PATIENT': NUM_PER_PATIENT,                                                                       
   219 │       │       │      │       │       │       │               │       │                    'POP_NUMBER': POP_NUMBER,                                                                                 
   220 │       │       │      │       │       │       │               │       │                    'BATCH_SIZE': BATCH_SIZE,                                                                                 
   221 │       │       │      │       │       │       │               │       │                    'LABEL_SMOOTHING': LABEL_SMOOTHING,                                                                       
   222 │       │       │      │       │       │       │               │       │                    'DROPOUT': DROPOUT,                                                                                       
   223 │       │       │      │       │       │       │               │       │                    'CORT_ONLY': CORT_ONLY,                                                                                   
   224 │       │       │      │       │       │       │               │       │                    'MAX_ITR': ITERS,                                                                                         
   225 │       │       │      │       │       │       │               │       │                    'T_END': T_END,                                                                                           
   226 │       │       │      │       │       │       │               │       │                    'DEVICE': DEVICE,                                                                                         
   227 │       │       │      │       │       │       │               │       │                },                                                                                                            
   228 │       │       │      │       │       │       │               │       │                virtual=True,                                                                                                 
   229 │       │       │      │       │       │       │               │       │                # permutations=perms,                                                                                         
   230 │       │       │      │       │       │       │               │       │                # ctrl_range=CTRL_RANGE,                                                                                      
   231 │       │       │      │       │       │       │               │       │                # mdd_range=MDD_RANGE,                                                                                        
   232 │       │       │      │       │       │       │               │       │                plus_ableson_mdd=True if POP.lower()=='plusablesonmdd0and12' else False,                                      
   233 │       │       │      │       │       │       │               │       │                toy_data=True if POP.lower()=='toydata' else False                                                            
   234 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   235 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   236 │       │       │      │       │       │       │               │       │            usage_hint()                                                                                                      
   237 │       │       │      │       │       │       │               │       │    except IndexError:                                                                                                        
   238 │       │       │      │       │       │       │               │       │        usage_hint()                                                                                                          
   239 │       │       │      │       │       │       │               │       │                                                                                                                              
   240 │       │       │      │       │       │       │               │       │                                                                                                                              
   241 │       │       │      │       │       │       │               │       │                                                                                                                              
   242 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
   243 │       │       │      │       │       │       │               │       │#                                 MIT License                                 #                                               
   244 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
   245 │       │       │      │       │       │       │               │       │#     Copyright (c) 2022 Christopher John Parker <parkecp@mail.uc.edu>        #                                               
   246 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   247 │       │       │      │       │       │       │               │       │# Permission is hereby granted, free of charge, to any person obtaining a     #                                               
   248 │       │       │      │       │       │       │               │       │# copy of this software and associated documentation files (the "Software"),  #                                               
   249 │       │       │      │       │       │       │               │       │# to deal in the Software without restriction, including without limitation   #                                               
   250 │       │       │      │       │       │       │               │       │# the rights to use, copy, modify, merge, publish, distribute, sublicense,    #                                               
   251 │       │       │      │       │       │       │               │       │# and/or sell copies of the Software, and to permit persons to whom the       #                                               
   252 │       │       │      │       │       │       │               │       │# Software is furnished to do so, subject to the following conditions:        #                                               
   253 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   254 │       │       │      │       │       │       │               │       │# The above copyright notice and this permission notice shall be included in  #                                               
   255 │       │       │      │       │       │       │               │       │# all copies or substantial portions of the Software.                         #                                               
   256 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   257 │       │       │      │       │       │       │               │       │# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  #                                               
   258 │       │       │      │       │       │       │               │       │# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,    #                                               
   259 │       │       │      │       │       │       │               │       │# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE #                                               
   260 │       │       │      │       │       │       │               │       │# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER      #                                               
   261 │       │       │      │       │       │       │               │       │# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING     #                                               
   262 │       │       │      │       │       │       │               │       │# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER         #                                               
   263 │       │       │      │       │       │       │               │       │# DEALINGS IN THE SOFTWARE.                                                   #                                               
   264 │       │       │      │       │       │       │               │       │#                                                                             #                                               
   265 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
   266 │       │       │      │       │       │       │               │       │                                                                                                                              
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                                                                                              
Top PEAK memory consumption, by line:
(1)    55:   120 MB                                                                                                                                                                                           
                                                            /home/ec2-user/NCDE-model/testing.py: % of time =   0.90% (1.109s) out of 2m:2.595s.                                                             
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                                                                                              
       │Time   │–––––– │––––… │–––––– │Memory │–––––– │–––––––––––    │Copy   │                                                                                                                              
  Line │Python │native │syst… │GPU    │Python │peak   │timeline/%     │(MB/s) │/home/ec2-user/NCDE-model/testing.py                                                                                          
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │      │       │       │       │               │       │# File Name: testing.py                                                                                                       
     2 │       │       │      │       │       │       │               │       │# Author: Christopher Parker                                                                                                  
     3 │       │       │      │       │       │       │               │       │# Created: Fri Jul 21, 2023 | 04:30P EDT                                                                                      
     4 │       │       │      │       │       │       │               │       │# Last Modified: Fri Sep 15, 2023 | 09:54P EDT                                                                                
     5 │       │       │      │       │       │       │               │       │                                                                                                                              
     6 │       │       │      │       │       │       │               │       │"""Code for testing trained networks and saving summaries of classification                                                   
     7 │       │       │      │       │       │       │               │       │success rates into Excel spreadsheets"""                                                                                      
     8 │       │       │      │       │       │       │               │       │                                                                                                                              
     9 │       │       │      │       │       │       │               │       │import os                                                                                                                     
    10 │       │       │      │       │       │       │               │       │import torch                                                                                                                  
    11 │       │       │      │       │       │       │               │       │import torch.nn as nn                                                                                                         
    12 │       │       │      │       │       │       │               │       │import torchcde                                                                                                               
    13 │       │       │      │       │  99%  │   20M │▁▁   4%        │     2 │import pandas as pd                                                                                                           
    14 │       │       │      │       │       │       │               │       │import numpy as np                                                                                                            
    15 │       │       │      │       │ 100%  │   20M │▁▁   4%        │     2 │import matplotlib.pyplot as plt                                                                                               
    16 │       │       │      │       │       │       │               │       │from copy import copy                                                                                                         
    17 │       │       │      │       │       │       │               │       │                                                                                                                              
    18 │       │       │      │       │       │       │               │       │from torch.utils.data import DataLoader                                                                                       
    19 │       │       │      │       │       │       │               │       │from torch.nn.functional import binary_cross_entropy_with_logits, mse_loss                                                    
    20 │       │       │      │       │       │       │               │       │from torchdiffeq import odeint_adjoint as odeint                                                                              
    21 │       │       │      │       │       │       │               │       │                                                                                                                              
    22 │       │       │      │       │       │       │               │       │from neural_cde import NeuralCDE                                                                                              
    23 │       │       │      │       │       │       │               │       │from neural_ode import NeuralODE                                                                                              
    24 │       │       │      │       │       │       │               │       │from ann import ANN                                                                                                           
    25 │       │       │      │       │       │       │               │       │from rnn import RNN                                                                                                           
    26 │       │       │      │       │       │       │               │       │from get_data import NelsonData, AblesonData, SriramSimulation                                                                
    27 │       │       │      │       │       │       │               │       │from get_augmented_data import (FullVirtualPopulation,                                                                        
    28 │       │       │      │       │       │       │               │       │                                FullVirtualPopulation_ByLab,                                                                  
    29 │       │       │      │       │       │       │               │       │                                NelsonVirtualPopulation, ToyDataset)                                                          
    30 │       │       │      │       │       │       │               │       │                                                                                                                              
    31 │       │       │      │       │       │       │               │       │# The constants listed here are to be defined in classification.py. The train()                                               
    32 │       │       │      │       │       │       │               │       │#  function will iterate through the parameter names passed in the                                                            
    33 │       │       │      │       │       │       │               │       │#  parameter_dict argument and set values to these global variables for use in                                                
    34 │       │       │      │       │       │       │               │       │#  all of the functions in this namespace                                                                                     
    35 │       │       │      │       │       │       │               │       │# Network architecture parameters                                                                                             
    36 │       │       │      │       │       │       │               │       │NETWORK_TYPE: str = ''                                                                                                        
    37 │       │       │      │       │       │       │               │       │INPUT_CHANNELS: int = 0                                                                                                       
    38 │       │       │      │       │       │       │               │       │HDIM: int = 0                                                                                                                 
    39 │       │       │      │       │       │       │               │       │OUTPUT_CHANNELS: int = 0                                                                                                      
    40 │       │       │      │       │       │       │               │       │# Only necessary for RNN                                                                                                      
    41 │       │       │      │       │       │       │               │       │N_RECURS: int = 0                                                                                                             
    42 │       │       │      │       │       │       │               │       │CLASSIFY: bool = True # For use in choosing between classification/prediction                                                 
    43 │       │       │      │       │       │       │               │       │MECHANISTIC: bool = False # Should the mechanistic components be included?                                                    
    44 │       │       │      │       │       │       │               │       │                                                                                                                              
    45 │       │       │      │       │       │       │               │       │# Training hyperparameters                                                                                                    
    46 │       │       │      │       │       │       │               │       │ITERS: int = 0                                                                                                                
    47 │       │       │      │       │       │       │               │       │SAVE_FREQ: int = 0                                                                                                            
    48 │       │       │      │       │       │       │               │       │LR: float = 0.                                                                                                                
    49 │       │       │      │       │       │       │               │       │DECAY: float = 0.                                                                                                             
    50 │       │       │      │       │       │       │               │       │OPT_RESET: int = 0                                                                                                            
    51 │       │       │      │       │       │       │               │       │ATOL: float = 0.                                                                                                              
    52 │       │       │      │       │       │       │               │       │RTOL: float = 0.                                                                                                              
    53 │       │       │      │       │       │       │               │       │                                                                                                                              
    54 │       │       │      │       │       │       │               │       │# Training data selection parameters                                                                                          
    55 │       │       │      │       │       │       │               │       │PATIENT_GROUPS: list = []                                                                                                     
    56 │       │       │      │       │       │       │               │       │INDIVIDUAL_NUMBER: int = 0                                                                                                    
    57 │       │       │      │       │       │       │               │       │METHOD: str = ''                                                                                                              
    58 │       │       │      │       │       │       │               │       │NORMALIZE_STANDARDIZE: str = ''                                                                                               
    59 │       │       │      │       │       │       │               │       │NOISE_MAGNITUDE: float = 0.                                                                                                   
    60 │       │       │      │       │       │       │               │       │NUM_PER_PATIENT: int = 0                                                                                                      
    61 │       │       │      │       │       │       │               │       │POP_NUMBER: int = 0                                                                                                           
    62 │       │       │      │       │       │       │               │       │BATCH_SIZE: int = 0                                                                                                           
    63 │       │       │      │       │       │       │               │       │LABEL_SMOOTHING: float = 0.                                                                                                   
    64 │       │       │      │       │       │       │               │       │DROPOUT: float = 0.                                                                                                           
    65 │       │       │      │       │       │       │               │       │CORT_ONLY: bool = False                                                                                                       
    66 │       │       │      │       │       │       │               │       │MAX_ITR: int = 1                                                                                                              
    67 │       │       │      │       │       │       │               │       │T_END: int = 0                                                                                                                
    68 │       │       │      │       │       │       │               │       │                                                                                                                              
    69 │       │       │      │       │       │       │               │       │# Define the device with which to train networks                                                                              
    70 │       │       │      │       │       │       │               │       │DEVICE:torch.device = torch.device('cpu')                                                                                     
    71 │       │       │      │       │       │       │               │       │                                                                                                                              
    72 │       │       │      │       │       │       │               │       │                                                                                                                              
    73 │       │       │      │       │       │       │               │       │def test(hyperparameters: dict, virtual: bool=True,                                                                           
    74 │       │       │      │       │       │       │               │       │         permutations: list=[], ctrl_range: list=[], mdd_range: list=[],                                                      
    75 │       │       │      │       │       │       │               │       │         ableson_pop: bool=False, plus_ableson_mdd: bool=False,                                                               
    76 │       │       │      │       │       │       │               │       │         toy_data: bool=False):                                                                                               
    77 │       │       │      │       │       │       │               │       │    """Run the test procedure given the order of test patients withheld from                                                  
    78 │       │       │      │       │       │       │               │       │    the training datasets"""                                                                                                  
    79 │       │       │      │       │       │       │               │       │                                                                                                                              
    80 │       │       │      │       │       │       │               │       │    # Loop over the constants passed in hyperparameters and set the values to                                                 
    81 │       │       │      │       │       │       │               │       │    #  the corresponding global variables                                                                                     
    82 │       │       │      │       │       │       │               │       │    for (key, val) in hyperparameters.items():                                                                                
    83 │       │       │      │       │       │       │               │       │        globals()[key] = val                                                                                                  
    84 │       │       │      │       │       │       │               │       │                                                                                                                              
    85 │       │       │      │       │       │       │               │       │    # Set a flag to indicate if we are labeling the data by lab or by diagnosis                                               
    86 │       │       │      │       │       │       │               │       │    by_lab = True if 'Nelson' in PATIENT_GROUPS else False                                                                    
    87 │       │       │      │       │       │       │               │       │                                                                                                                              
    88 │       │       │      │       │       │       │               │       │    # If the user didn't pass lists with the order of test patient                                                            
    89 │       │       │      │       │       │       │               │       │    #  permutations, we only test on one population                                                                           
    90 │       │       │      │       │       │       │               │       │    if not permutations:                                                                                                      
    91 │       │       │      │       │       │       │               │       │        test_single(virtual, ableson_pop, toy_data)                                                                           
    92 │       │       │      │       │       │       │               │       │        return                                                                                                                
    93 │       │       │      │       │       │       │               │       │                                                                                                                              
    94 │       │       │      │       │       │       │               │       │    # Create the list of all combinations of Control and MDD (or Nelson and                                                   
    95 │       │       │      │       │       │       │               │       │    #  Ableson) populations in ctrl_range and mdd_range                                                                       
    96 │       │       │      │       │       │       │               │       │    loop_combos = [(i,j) for i in ctrl_range for j in mdd_range]                                                              
    97 │       │       │      │       │       │       │               │       │    for (ctrl_num, mdd_num) in loop_combos:                                                                                   
    98 │       │       │      │       │       │       │               │       │        control_combination = tuple(                                                                                          
    99 │       │       │      │       │       │       │               │       │            permutations[0][ctrl_num*5:(ctrl_num+1)*5]                                                                        
   100 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   101 │       │       │      │       │       │       │               │       │        mdd_combination = tuple(                                                                                              
   102 │       │       │      │       │       │       │               │       │            permutations[1][mdd_num*5:((mdd_num+1)*5)                                                                         
   103 │       │       │      │       │       │       │               │       │                            if (mdd_num+1)*5 < len(permutations[1])                                                           
   104 │       │       │      │       │       │       │               │       │                            else len(permutations[1])]                                                                        
   105 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   106 │       │       │      │       │       │       │               │       │        # Load the dataset for training                                                                                       
   107 │       │       │      │       │       │       │               │       │        loader, (t_steps, t_start, t_end) = load_data(                                                                        
   108 │       │       │      │       │       │       │               │       │            control_combination=control_combination,                                                                          
   109 │       │       │      │       │       │       │               │       │            mdd_combination=mdd_combination,                                                                                  
   110 │       │       │      │       │       │       │               │       │            patient_groups=PATIENT_GROUPS, by_lab=by_lab,                                                                     
   111 │       │       │      │       │       │       │               │       │            plus_ableson_mdd=plus_ableson_mdd,                                                                                
   112 │       │       │      │       │       │       │               │       │            test=True                                                                                                         
   113 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   114 │       │       │      │       │       │       │               │       │        info = {                                                                                                              
   115 │       │       │      │       │       │       │               │       │            'ctrl_num': ctrl_num,                                                                                             
   116 │       │       │      │       │       │       │               │       │            'control_combination': control_combination,                                                                       
   117 │       │       │      │       │       │       │               │       │            'mdd_num': mdd_num,                                                                                               
   118 │       │       │      │       │       │       │               │       │            'mdd_combination': mdd_combination,                                                                               
   119 │       │       │      │       │       │       │               │       │            'by_lab': by_lab,                                                                                                 
   120 │       │       │      │       │       │       │               │       │            't_steps': t_steps,                                                                                               
   121 │       │       │      │       │       │       │               │       │            't_start': t_start,                                                                                               
   122 │       │       │      │       │       │       │               │       │            't_end': t_end,                                                                                                   
   123 │       │       │      │       │       │       │               │       │        }                                                                                                                     
   124 │       │       │      │       │       │       │               │       │        model = model_init(info)                                                                                              
   125 │       │       │      │       │       │       │               │       │        with torch.no_grad():                                                                                                 
   126 │       │       │      │       │       │       │               │       │            if NETWORK_TYPE in ('NCDE', 'NCDE_LBFGS'):                                                                        
   127 │       │       │      │       │       │       │               │       │                classification_ncde_testing(model, loader, info) if CLASSIFY else prediction_ncde_testing(model, loader, inf  
   128 │       │       │      │       │       │       │               │       │            elif NETWORK_TYPE == 'NODE':                                                                                      
   129 │       │       │      │       │       │       │               │       │                classification_node_testing(model, loader, info) if CLASSIFY else prediction_node_testing(model, loader, inf  
   130 │       │       │      │       │       │       │               │       │            elif NETWORK_TYPE == 'ANN':                                                                                       
   131 │       │       │      │       │       │       │               │       │                classification_ann_testing(model, loader, info) if CLASSIFY else prediction_ann_testing(model, loader, info)  
   132 │       │       │      │       │       │       │               │       │            elif NETWORK_TYPE == 'RNN':                                                                                       
   133 │       │       │      │       │       │       │               │       │                classification_rnn_testing(model, loader, info) if CLASSIFY else prediction_rnn_testing(model, loader, info)  
   134 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   135 │       │       │      │       │       │       │               │       │                raise ValueError(                                                                                             
   136 │       │       │      │       │       │       │               │       │                    "NETWORK_TYPE must be one of: NCDE, NODE or ANN"                                                          
   137 │       │       │      │       │       │       │               │       │                )                                                                                                             
   138 │       │       │      │       │       │       │               │       │                                                                                                                              
   139 │       │       │      │       │       │       │               │       │def test_single(virtual: bool, ableson_pop: bool=False, toy_data: bool=False):                                                
   140 │       │       │      │       │       │       │               │       │    """When we do not have a list of test patient groups, run a test on a                                                     
   141 │       │       │      │       │       │       │               │       │    single test population"""                                                                                                 
   142 │       │       │      │       │       │       │               │       │    loader, (t_steps, t_start, t_end) = load_data(                                                                            
   143 │       │       │      │       │       │       │               │       │        virtual, POP_NUMBER, patient_groups=PATIENT_GROUPS,                                                                   
   144 │       │       │      │       │       │       │               │       │        ableson_pop=ableson_pop, toy_data=toy_data, test=True                                                                 
   145 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   146 │       │       │      │       │       │       │               │       │                                                                                                                              
   147 │       │       │      │       │       │       │               │       │    info = {                                                                                                                  
   148 │       │       │      │       │       │       │               │       │        'virtual': virtual,                                                                                                   
   149 │       │       │      │       │       │       │               │       │        'ableson_pop': ableson_pop,                                                                                           
   150 │       │       │      │       │       │       │               │       │        'toy_data': toy_data,                                                                                                 
   151 │       │       │      │       │       │       │               │       │        't_steps': t_steps,                                                                                                   
   152 │       │       │      │       │       │       │               │       │        't_start': t_start,                                                                                                   
   153 │       │       │      │       │       │       │               │       │        't_end': t_end,                                                                                                       
   154 │       │       │      │       │       │       │               │       │    }                                                                                                                         
   155 │       │       │      │       │       │       │               │       │    model = model_init(info)                                                                                                  
   156 │       │       │      │       │       │       │               │       │    with torch.no_grad():                                                                                                     
   157 │       │       │      │       │       │       │               │       │        if NETWORK_TYPE in ('NCDE', 'NCDE_LBFGS'):                                                                            
   158 │       │       │      │       │       │       │               │       │            classification_ncde_testing(model, loader, info) if CLASSIFY else prediction_ncde_testing(model, loader, info)    
   159 │       │       │      │       │       │       │               │       │        elif NETWORK_TYPE == 'NODE':                                                                                          
   160 │       │       │      │       │       │       │               │       │            classification_node_testing(model, loader, info) if CLASSIFY else prediction_node_testing(model, loader, info)    
   161 │       │       │      │       │       │       │               │       │        elif NETWORK_TYPE == 'ANN':                                                                                           
   162 │       │       │      │       │       │       │               │       │            classification_ann_testing(model, loader, info) if CLASSIFY else prediction_ann_testing(model, loader, info)      
   163 │       │       │      │       │       │       │               │       │        elif NETWORK_TYPE == 'RNN':                                                                                           
   164 │       │       │      │       │       │       │               │       │            classification_rnn_testing(model, loader, info) if CLASSIFY else prediction_rnn_testing(model, loader, info)      
   165 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   166 │       │       │      │       │       │       │               │       │            raise ValueError(                                                                                                 
   167 │       │       │      │       │       │       │               │       │                "NETWORK_TYPE must be one of: NCDE, NODE or ANN"                                                              
   168 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   169 │       │       │      │       │       │       │               │       │                                                                                                                              
   170 │       │       │      │       │       │       │               │       │                                                                                                                              
   171 │       │       │      │       │       │       │               │       │def load_data(virtual: bool=True, pop_number: int=0,                                                                          
   172 │       │       │      │       │       │       │               │       │              control_combination: tuple=(),                                                                                  
   173 │       │       │      │       │       │       │               │       │              mdd_combination: tuple=(), patient_groups: list=[],                                                             
   174 │       │       │      │       │       │       │               │       │              by_lab: bool=False, ableson_pop: bool=False,                                                                    
   175 │       │       │      │       │       │       │               │       │              plus_ableson_mdd: bool=False,                                                                                   
   176 │       │       │      │       │       │       │               │       │              toy_data: bool=False, test: bool=True):                                                                         
   177 │       │       │      │       │       │       │               │       │    if not patient_groups:                                                                                                    
   178 │       │       │      │       │       │       │               │       │        patient_groups = PATIENT_GROUPS                                                                                       
   179 │       │       │      │       │       │       │               │       │    if toy_data and not virtual:                                                                                              
   180 │       │       │      │       │       │       │               │       │        dataset = SriramSimulation(                                                                                           
   181 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   182 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE                                                                       
   183 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   184 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
   185 │       │       │      │       │       │       │               │       │        dataset = NelsonData(                                                                                                 
   186 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   187 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   188 │       │       │      │       │       │       │               │       │            individual_number=INDIVIDUAL_NUMBER,                                                                              
   189 │       │       │      │       │       │       │               │       │        ) if not ableson_pop else AblesonData(                                                                                
   190 │       │       │      │       │       │       │               │       │            patient_groups=copy(patient_groups),                                                                              
   191 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE                                                                       
   192 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   193 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   194 │       │       │      │       │       │       │               │       │        dataset = ToyDataset(                                                                                                 
   195 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   196 │       │       │      │       │       │       │               │       │            patient_groups=PATIENT_GROUPS,                                                                                    
   197 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   198 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   199 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   200 │       │       │      │       │       │       │               │       │            t_end=T_END                                                                                                       
   201 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   202 │       │       │      │       │       │       │               │       │    elif pop_number:                                                                                                          
   203 │       │       │      │       │       │       │               │       │        dataset = NelsonVirtualPopulation(                                                                                    
   204 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   205 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   206 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   207 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   208 │       │       │      │       │       │       │               │       │            pop_number=POP_NUMBER,                                                                                            
   209 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   210 │       │       │      │       │       │       │               │       │            label_smoothing=LABEL_SMOOTHING,                                                                                  
   211 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   212 │       │       │      │       │       │       │               │       │    elif patient_groups[1] not in ['MDD', 'Ableson']:                                                                         
   213 │       │       │      │       │       │       │               │       │        dataset = NelsonVirtualPopulation(                                                                                    
   214 │       │       │      │       │       │       │               │       │            patient_groups=patient_groups,                                                                                    
   215 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   216 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   217 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   218 │       │       │      │       │       │       │               │       │            control_combination=control_combination,                                                                          
   219 │       │       │      │       │       │       │               │       │            mdd_combination=mdd_combination,                                                                                  
   220 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   221 │       │       │      │       │       │       │               │       │            label_smoothing=LABEL_SMOOTHING,                                                                                  
   222 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   223 │       │       │      │       │       │       │               │       │            plus_ableson_mdd=plus_ableson_mdd                                                                                 
   224 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   225 │       │       │      │       │       │       │               │       │    elif by_lab:                                                                                                              
   226 │       │       │      │       │       │       │               │       │        dataset = FullVirtualPopulation_ByLab(                                                                                
   227 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   228 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   229 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   230 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   231 │       │       │      │       │       │       │               │       │            # Since Nelson is treated as control for the purposes of                                                          
   232 │       │       │      │       │       │       │               │       │            #  labeling, we use control_combination for the Nelson data                                                       
   233 │       │       │      │       │       │       │               │       │            #  and mdd_combination for the Ableson data                                                                       
   234 │       │       │      │       │       │       │               │       │            nelson_combination=control_combination,                                                                           
   235 │       │       │      │       │       │       │               │       │            ableson_combination=mdd_combination,                                                                              
   236 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   237 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   238 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   239 │       │       │      │       │       │       │               │       │        dataset = FullVirtualPopulation(                                                                                      
   240 │       │       │      │       │       │       │               │       │            method=METHOD,                                                                                                    
   241 │       │       │      │       │       │       │               │       │            noise_magnitude=NOISE_MAGNITUDE,                                                                                  
   242 │       │       │      │       │       │       │               │       │            normalize_standardize=NORMALIZE_STANDARDIZE,                                                                      
   243 │       │       │      │       │       │       │               │       │            num_per_patient=NUM_PER_PATIENT,                                                                                  
   244 │       │       │      │       │       │       │               │       │            control_combination=control_combination,                                                                          
   245 │       │       │      │       │       │       │               │       │            mdd_combination=mdd_combination,                                                                                  
   246 │       │       │      │       │       │       │               │       │            test=test,                                                                                                        
   247 │       │       │      │       │       │       │               │       │            label_smoothing=LABEL_SMOOTHING                                                                                   
   248 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   249 │       │       │      │       │       │       │               │       │                                                                                                                              
   250 │       │       │      │       │       │       │               │       │    t_steps = len(dataset[0][0][...,0].squeeze())                                                                             
   251 │       │       │      │       │       │       │               │       │    t = dataset[0][0][...,0]                                                                                                  
   252 │       │       │      │       │       │       │               │       │    t_start = t[0]                                                                                                            
   253 │       │       │      │       │       │       │               │       │    t_end = t[-1]                                                                                                             
   254 │       │       │      │       │       │       │               │       │    loader = DataLoader(                                                                                                      
   255 │       │       │      │       │       │       │               │       │        dataset=dataset, batch_size=2000, shuffle=False                                                                       
   256 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   257 │       │       │      │       │       │       │               │       │    return loader, (t_steps, t_start, t_end)                                                                                  
   258 │       │       │      │       │       │       │               │       │                                                                                                                              
   259 │       │       │      │       │       │       │               │       │                                                                                                                              
   260 │       │       │      │       │       │       │               │       │def model_init(info: dict):                                                                                                   
   261 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   262 │       │       │      │       │       │       │               │       │    t_steps = info.get('t_steps', 11)                                                                                         
   263 │       │       │      │       │       │       │               │       │    t_start = info.get('t_start', 0)                                                                                          
   264 │       │       │      │       │       │       │               │       │    t_end = info.get('t_end', 1)                                                                                              
   265 │       │       │      │       │       │       │               │       │                                                                                                                              
   266 │       │       │      │       │       │       │               │       │    if NETWORK_TYPE in ('NCDE', 'NCDE_LBFGS'):                                                                                
   267 │       │       │      │       │       │       │               │       │        return NeuralCDE(                                                                                                     
   268 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS, HDIM, OUTPUT_CHANNELS,                                                                            
   269 │       │       │      │       │       │       │               │       │            t_interval=torch.linspace(t_start, t_end, 1000),                                                                  
   270 │       │       │      │       │       │       │               │       │            device=DEVICE, dropout=DROPOUT, prediction=not CLASSIFY                                                           
   271 │       │       │      │       │       │       │               │       │        ).double()                                                                                                            
   272 │       │       │      │       │       │       │               │       │    if NETWORK_TYPE == 'NODE':                                                                                                
   273 │       │       │      │       │       │       │               │       │        return NeuralODE(                                                                                                     
   274 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS, HDIM, OUTPUT_CHANNELS,                                                                            
   275 │       │       │      │       │       │       │               │       │            device=DEVICE,                                                                                                    
   276 │       │       │      │       │       │       │               │       │        ).double()                                                                                                            
   277 │       │       │      │       │       │       │               │       │    if NETWORK_TYPE == 'ANN':                                                                                                 
   278 │       │       │      │       │       │       │               │       │        return ANN(                                                                                                           
   279 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS*t_steps, HDIM,                                                                                     
   280 │       │       │      │       │       │       │               │       │            OUTPUT_CHANNELS*t_steps,                                                                                          
   281 │       │       │      │       │       │       │               │       │            device=DEVICE,                                                                                                    
   282 │       │       │      │       │       │       │               │       │        ).double()                                                                                                            
   283 │       │       │      │       │       │       │               │       │    if NETWORK_TYPE == 'RNN':                                                                                                 
   284 │       │       │      │       │       │       │               │       │        return RNN(                                                                                                           
   285 │       │       │      │       │       │       │               │       │            INPUT_CHANNELS*t_steps, HDIM,                                                                                     
   286 │       │       │      │       │       │       │               │       │            N_RECURS, device=DEVICE,                                                                                          
   287 │       │       │      │       │       │       │               │       │        ).double()                                                                                                            
   288 │       │       │      │       │       │       │               │       │    raise ValueError("NETWORK_TYPE unsupported")                                                                              
   289 │       │       │      │       │       │       │               │       │                                                                                                                              
   290 │       │       │      │       │       │       │               │       │                                                                                                                              
   291 │       │       │      │       │       │       │               │       │def classification_ncde_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                            
   292 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
   293 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
   294 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
   295 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
   296 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
   297 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
   298 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
   299 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
   300 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   301 │       │       │      │       │       │       │               │       │                                                                                                                              
   302 │       │       │      │       │       │       │               │       │    # Create the Pandas DataFrame which we will write to an Excel sheet                                                       
   303 │       │       │      │       │       │       │               │       │    performance_df = pd.DataFrame(                                                                                            
   304 │       │       │      │       │       │       │               │       │        columns=(                                                                                                             
   305 │       │       │      │       │       │       │               │       │            'Iterations',                                                                                                     
   306 │       │       │      │       │       │       │               │       │            'Success',                                                                                                        
   307 │       │       │      │       │       │       │               │       │            'Prediction',                                                                                                     
   308 │       │       │      │       │       │       │               │       │            'Error',                                                                                                          
   309 │       │       │      │       │       │       │               │       │            'Cross Entropy Loss',                                                                                             
   310 │       │       │      │       │       │       │               │       │            'Success %'                                                                                                       
   311 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   312 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   313 │       │       │      │       │       │       │               │       │                                                                                                                              
   314 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
   315 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
   316 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
   317 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
   318 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
   319 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
   320 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
   321 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   322 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
   323 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   324 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
   325 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
   326 │       │       │      │       │       │       │               │       │                                                                                                                              
   327 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
   328 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
   329 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
   330 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
   331 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
   332 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   333 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   334 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
   335 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
   336 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   337 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   338 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   339 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
   340 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
   341 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   342 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   343 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   344 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   345 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
   346 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   347 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   348 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   349 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
   350 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
   351 │       │       │      │       │       │       │               │       │                                                                                                                              
   352 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
   353 │       │       │      │       │       │       │               │       │    if not virtual:                                                                                                           
   354 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   355 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   356 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
   357 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   358 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   359 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   360 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   361 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   362 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
   363 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   364 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
   365 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   366 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
   367 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   368 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
   369 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
   370 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
   371 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
   372 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   373 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   374 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   375 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
   376 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   377 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
   378 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   379 │       │       │      │       │       │       │               │       │                                                                                                                              
   380 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
   381 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
   382 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
   383 │       │       │      │       │       │       │               │       │    print(f"{n_saves=}")                                                                                                      
   384 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
   385 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
   386 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
   387 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   388 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_{"mechanistic_" if MECHANISTIC else ""}'                                
   389 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
   390 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
   391 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
   392 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
   393 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
   394 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   395 │       │       │      │       │       │       │               │       │                f'{itr*100}ITER_{NORMALIZE_STANDARDIZE}_'                                                                     
   396 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   397 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
   398 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
   399 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   400 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
   401 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   402 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_NCDE_'                                                                                 
   403 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
   404 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
   405 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
   406 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
   407 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   408 │       │       │      │       │       │       │               │       │                f'{itr*100}ITER_{NORMALIZE_STANDARDIZE}_'                                                                     
   409 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   410 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
   411 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   412 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   413 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   414 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_NCDE_'                                                                                 
   415 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
   416 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   417 │       │       │      │       │       │       │               │       │                f'{itr*100}ITER_{NORMALIZE_STANDARDIZE}_'                                                                     
   418 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   419 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
   420 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   421 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
   422 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
   423 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
   424 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
   425 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
   426 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
   427 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
   428 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
   429 │       │       │      │       │       │       │               │       │                                                                                                                              
   430 │       │       │      │       │       │       │               │       │        # Pandas Series to allow us to insert the number of iterations for each                                               
   431 │       │       │      │       │       │       │               │       │        #  group of predicitons only in the first row of the group                                                            
   432 │       │       │      │       │       │       │               │       │        iterations = pd.Series((itr*SAVE_FREQ,), index=(index[0],))                                                           
   433 │       │       │      │       │       │       │               │       │                                                                                                                              
   434 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
   435 │       │       │      │       │       │       │               │       │        for batch in loader:                                                                                                  
   436 │       │       │      │       │       │       │               │       │            # Ensure the data is only CORT if CORT_ONLY, and that the data and                                                
   437 │       │       │      │       │       │       │               │       │            #  labels are loaded into the proper device memory                                                                
   438 │       │       │      │       │       │       │               │       │            (data, labels) = batch                                                                                            
   439 │       │       │      │       │       │       │               │       │            if CORT_ONLY:                                                                                                     
   440 │       │       │      │       │       │       │               │       │                data = data[...,[0,2]]                                                                                        
   441 │       │       │      │       │       │       │               │       │            if toy_data and INPUT_CHANNELS == 3:                                                                              
   442 │       │       │      │       │       │       │               │       │                data = data[...,[0,2,3]]                                                                                      
   443 │       │       │      │       │       │       │               │       │            data = data.to(DEVICE)                                                                                            
   444 │       │       │      │       │       │       │               │       │            labels = labels.to(DEVICE) if CLASSIFY else data                                                                  
   445 │       │       │      │       │       │       │               │       │            coeffs = torchcde.\                                                                                               
   446 │       │       │      │       │       │       │               │       │                hermite_cubic_coefficients_with_backward_differences(data)                                                    
   447 │       │       │      │       │       │       │               │       │                                                                                                                              
   448 │       │       │      │       │       │       │               │       │            pred_y = model(coeffs).squeeze(-1)                                                                                
   449 │       │       │      │       │       │       │               │       │            output = loss(pred_y, labels)                                                                                     
   450 │       │       │      │       │       │       │               │       │                                                                                                                              
   451 │       │       │      │       │       │       │               │       │            # We need to run pred_y through a sigmoid layer to check for                                                      
   452 │       │       │      │       │       │       │               │       │            #  success and error because when training we use                                                                 
   453 │       │       │      │       │       │       │               │       │            #  binary_cross_entropy_with_logits, which combines a sigmoid                                                     
   454 │       │       │      │       │       │       │               │       │            #  layer with BCE (improved performance over running sigmoid then                                                 
   455 │       │       │      │       │       │       │               │       │            #  BCE with torch)                                                                                                
   456 │       │       │      │       │       │       │               │       │            pred_y = torch.sigmoid(pred_y)                                                                                    
   457 │       │       │      │       │       │       │               │       │            error = torch.abs(labels - pred_y)                                                                                
   458 │       │       │      │       │       │       │               │       │                                                                                                                              
   459 │       │       │      │       │       │       │               │       │            # Rounding the predicted y to see if it was successful                                                            
   460 │       │       │      │       │       │       │               │       │            rounded_y = torch.round(pred_y)                                                                                   
   461 │       │       │      │       │       │       │               │       │            success = [not y for y in torch.abs(labels - rounded_y)]                                                          
   462 │       │       │      │       │       │       │               │       │                                                                                                                              
   463 │       │       │      │       │       │       │               │       │            # Create Pandas Series objects so that we can insert these only                                                   
   464 │       │       │      │       │       │       │               │       │            #  in the last row of each iteration prediction group                                                             
   465 │       │       │      │       │       │       │               │       │            cross_entropy_loss = pd.Series(                                                                                   
   466 │       │       │      │       │       │       │               │       │                (output.item(),),                                                                                             
   467 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
   468 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   469 │       │       │      │       │       │       │               │       │            success_pct = pd.Series(                                                                                          
   470 │       │       │      │       │       │       │               │       │                (sum(success)/len(pred_y),),                                                                                  
   471 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
   472 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   473 │       │       │      │       │       │       │               │       │            tmp_df = pd.DataFrame(                                                                                            
   474 │       │       │      │       │       │       │               │       │                data={                                                                                                        
   475 │       │       │      │       │       │       │               │       │                    'Iterations': iterations,                                                                                 
   476 │       │       │      │       │       │       │               │       │                    'Success': success,                                                                                       
   477 │       │       │      │       │       │       │               │       │                    'Prediction': pred_y,                                                                                     
   478 │       │       │      │       │       │       │               │       │                    'Error': error,                                                                                           
   479 │       │       │      │       │       │       │               │       │                    'Cross Entropy Loss': cross_entropy_loss,                                                                 
   480 │       │       │      │       │       │       │               │       │                    'Success %': success_pct                                                                                  
   481 │       │       │      │       │       │       │               │       │                }, index=index                                                                                                
   482 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   483 │       │       │      │       │       │       │               │       │                                                                                                                              
   484 │       │       │      │       │       │       │               │       │            # Add the performance metrics to the DataFrame as a new row                                                       
   485 │       │       │      │       │       │       │               │       │            performance_df = pd.concat(                                                                                       
   486 │       │       │      │       │       │       │               │       │                (                                                                                                             
   487 │       │       │      │       │       │       │               │       │                    performance_df,                                                                                           
   488 │       │       │      │       │       │       │               │       │                    tmp_df                                                                                                    
   489 │       │       │      │       │       │       │               │       │                ),                                                                                                            
   490 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   491 │       │       │      │       │       │       │               │       │    # Save the DataFrame to a file                                                                                            
   492 │       │       │      │       │       │       │               │       │    save_performance(performance_df, info)                                                                                    
   493 │       │       │      │       │       │       │               │       │                                                                                                                              
   494 │       │       │      │       │       │       │               │       │                                                                                                                              
   495 │       │       │      │       │       │       │               │       │def classification_node_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                            
   496 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
   497 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
   498 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
   499 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
   500 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
   501 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
   502 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
   503 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
   504 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   505 │       │       │      │       │       │       │               │       │                                                                                                                              
   506 │       │       │      │       │       │       │               │       │    # Create the Pandas DataFrame which we will write to an Excel sheet                                                       
   507 │       │       │      │       │       │       │               │       │    performance_df = pd.DataFrame(                                                                                            
   508 │       │       │      │       │       │       │               │       │        columns=(                                                                                                             
   509 │       │       │      │       │       │       │               │       │            'Iterations',                                                                                                     
   510 │       │       │      │       │       │       │               │       │            'Success',                                                                                                        
   511 │       │       │      │       │       │       │               │       │            'Prediction',                                                                                                     
   512 │       │       │      │       │       │       │               │       │            'Error',                                                                                                          
   513 │       │       │      │       │       │       │               │       │            'Cross Entropy Loss',                                                                                             
   514 │       │       │      │       │       │       │               │       │            'Success %'                                                                                                       
   515 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   516 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   517 │       │       │      │       │       │       │               │       │                                                                                                                              
   518 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
   519 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
   520 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
   521 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
   522 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
   523 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
   524 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
   525 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   526 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
   527 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   528 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
   529 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
   530 │       │       │      │       │       │       │               │       │                                                                                                                              
   531 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
   532 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
   533 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
   534 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
   535 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
   536 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   537 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   538 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
   539 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
   540 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   541 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   542 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   543 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
   544 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
   545 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   546 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   547 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   548 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   549 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
   550 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   551 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   552 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   553 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
   554 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
   555 │       │       │      │       │       │       │               │       │                                                                                                                              
   556 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
   557 │       │       │      │       │       │       │               │       │    if not virtual:                                                                                                           
   558 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   559 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   560 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   561 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
   562 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   563 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   564 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   565 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   566 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   567 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
   568 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   569 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
   570 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   571 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
   572 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   573 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
   574 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
   575 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
   576 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
   577 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   578 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   579 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   580 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
   581 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
   582 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   583 │       │       │      │       │       │       │               │       │                                                                                                                              
   584 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
   585 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
   586 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
   587 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
   588 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
   589 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
   590 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   591 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_{"mechanistic_" if MECHANISTIC else ""}'                                
   592 │       │       │      │       │       │       │               │       │                                                                                                                              
   593 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
   594 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
   595 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
   596 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
   597 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
   598 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   599 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
   600 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   601 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
   602 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
   603 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   604 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
   605 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   606 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
   607 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
   608 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
   609 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
   610 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
   611 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   612 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
   613 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   614 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
   615 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   616 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   617 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   618 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
   619 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
   620 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   621 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
   622 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   623 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
   624 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   625 │       │       │      │       │       │       │               │       │        readout_filename = "".join(                                                                                           
   626 │       │       │      │       │       │       │               │       │            [state_file[:-4], '_readout', state_file[-4:]]                                                                    
   627 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   628 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
   629 │       │       │      │       │       │       │               │       │        readout_filepath = os.path.join(directory, readout_filename)                                                          
   630 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
   631 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
   632 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
   633 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
   634 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
   635 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
   636 │       │       │      │       │       │       │               │       │        readout_state_dict = torch.load(readout_filepath, map_location=DEVICE)                                                
   637 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
   638 │       │       │      │       │       │       │               │       │        readout = nn.Linear(OUTPUT_CHANNELS, 1)                                                                               
   639 │       │       │      │       │       │       │               │       │        readout.load_state_dict(readout_state_dict)                                                                           
   640 │       │       │      │       │       │       │               │       │                                                                                                                              
   641 │       │       │      │       │       │       │               │       │        # Pandas Series to allow us to insert the number of iterations for each                                               
   642 │       │       │      │       │       │       │               │       │        #  group of predicitons only in the first row of the group                                                            
   643 │       │       │      │       │       │       │               │       │        iterations = pd.Series((itr*100,), index=(index[0],))                                                                 
   644 │       │       │      │       │       │       │               │       │                                                                                                                              
   645 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
   646 │       │       │      │       │       │       │               │       │        for (data, labels) in loader:                                                                                         
   647 │       │       │      │       │       │       │               │       │            t_eval = data[0,:,0].view(-1)                                                                                     
   648 │       │       │      │       │       │       │               │       │            # Ensure we have assigned the data and labels to the correct                                                      
   649 │       │       │      │       │       │       │               │       │            #  processing device                                                                                              
   650 │       │       │      │       │       │       │               │       │            if CORT_ONLY:                                                                                                     
   651 │       │       │      │       │       │       │               │       │                # If we are only using CORT, we can discard the middle column as it                                           
   652 │       │       │      │       │       │       │               │       │                #  contains the ACTH concentrations                                                                           
   653 │       │       │      │       │       │       │               │       │                data = data[...,2]                                                                                            
   654 │       │       │      │       │       │       │               │       │            if toy_data and INPUT_CHANNELS == 2:                                                                              
   655 │       │       │      │       │       │       │               │       │                data = data[...,[2,3]]                                                                                        
   656 │       │       │      │       │       │       │               │       │            data = data.to(DEVICE)                                                                                            
   657 │       │       │      │       │       │       │               │       │            labels = labels.to(DEVICE) if CLASSIFY else data                                                                  
   658 │       │       │      │       │       │       │               │       │            y0 = data[:,0,1:]                                                                                                 
   659 │       │       │      │       │       │       │               │       │                                                                                                                              
   660 │       │       │      │       │       │       │               │       │            # Compute the forward direction of the NODE                                                                       
   661 │       │       │      │       │       │       │               │       │            pred_y = odeint(                                                                                                  
   662 │       │       │      │       │       │       │               │       │                model, y0, t_eval                                                                                             
   663 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   664 │       │       │      │       │       │       │               │       │            # We need to take the output_channels down to a single output, then                                               
   665 │       │       │      │       │       │       │               │       │            #  we only need the last value (so the value after the entire depth of                                            
   666 │       │       │      │       │       │       │               │       │            #  the network)                                                                                                   
   667 │       │       │      │       │       │       │               │       │            # We squeeze to remove the extraneous dimension of the output so that                                             
   668 │       │       │      │       │       │       │               │       │            #  it matches the shape of the labels                                                                             
   669 │       │       │      │       │       │       │               │       │            pred_y = readout(pred_y)[-1].squeeze(-1)                                                                          
   670 │       │       │      │       │       │       │               │       │            output = loss(pred_y, labels)                                                                                     
   671 │       │       │      │       │       │       │               │       │                                                                                                                              
   672 │       │       │      │       │       │       │               │       │            # We need to run pred_y through a sigmoid layer to check for                                                      
   673 │       │       │      │       │       │       │               │       │            #  success and error because when training we use                                                                 
   674 │       │       │      │       │       │       │               │       │            #  binary_cross_entropy_with_logits, which combines a sigmoid                                                     
   675 │       │       │      │       │       │       │               │       │            #  layer with BCE (improved performance over running sigmoid then                                                 
   676 │       │       │      │       │       │       │               │       │            #  BCE with torch)                                                                                                
   677 │       │       │      │       │       │       │               │       │            pred_y = torch.sigmoid(pred_y)                                                                                    
   678 │       │       │      │       │       │       │               │       │            error = torch.abs(labels - pred_y)                                                                                
   679 │       │       │      │       │       │       │               │       │                                                                                                                              
   680 │       │       │      │       │       │       │               │       │            # Rounding the predicted y to see if it was successful                                                            
   681 │       │       │      │       │       │       │               │       │            rounded_y = torch.round(pred_y)                                                                                   
   682 │       │       │      │       │       │       │               │       │            success = [not y for y in torch.abs(labels - rounded_y)]                                                          
   683 │       │       │      │       │       │       │               │       │                                                                                                                              
   684 │       │       │      │       │       │       │               │       │            # Create Pandas Series objects so that we can insert these only                                                   
   685 │       │       │      │       │       │       │               │       │            #  in the last row of each iteration prediction group                                                             
   686 │       │       │      │       │       │       │               │       │            cross_entropy_loss = pd.Series(                                                                                   
   687 │       │       │      │       │       │       │               │       │                (output.item(),),                                                                                             
   688 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
   689 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   690 │       │       │      │       │       │       │               │       │            success_pct = pd.Series(                                                                                          
   691 │       │       │      │       │       │       │               │       │                (sum(success)/len(pred_y),),                                                                                  
   692 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
   693 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   694 │       │       │      │       │       │       │               │       │            tmp_df = pd.DataFrame(                                                                                            
   695 │       │       │      │       │       │       │               │       │                data={                                                                                                        
   696 │       │       │      │       │       │       │               │       │                    'Iterations': iterations,                                                                                 
   697 │       │       │      │       │       │       │               │       │                    'Success': success,                                                                                       
   698 │       │       │      │       │       │       │               │       │                    'Prediction': pred_y,                                                                                     
   699 │       │       │      │       │       │       │               │       │                    'Error': error,                                                                                           
   700 │       │       │      │       │       │       │               │       │                    'Cross Entropy Loss': cross_entropy_loss,                                                                 
   701 │       │       │      │       │       │       │               │       │                    'Success %': success_pct                                                                                  
   702 │       │       │      │       │       │       │               │       │                }, index=index                                                                                                
   703 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   704 │       │       │      │       │       │       │               │       │                                                                                                                              
   705 │       │       │      │       │       │       │               │       │            # Add the performance metrics to the DataFrame as a new row                                                       
   706 │       │       │      │       │       │       │               │       │            performance_df = pd.concat(                                                                                       
   707 │       │       │      │       │       │       │               │       │                (                                                                                                             
   708 │       │       │      │       │       │       │               │       │                    performance_df,                                                                                           
   709 │       │       │      │       │       │       │               │       │                    tmp_df                                                                                                    
   710 │       │       │      │       │       │       │               │       │                ),                                                                                                            
   711 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   712 │       │       │      │       │       │       │               │       │    # Save the DataFrame to a file                                                                                            
   713 │       │       │      │       │       │       │               │       │    save_performance(performance_df, info)                                                                                    
   714 │       │       │      │       │       │       │               │       │                                                                                                                              
   715 │       │       │      │       │       │       │               │       │                                                                                                                              
   716 │       │       │      │       │       │       │               │       │def classification_ann_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                             
   717 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
   718 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
   719 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
   720 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
   721 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
   722 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
   723 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
   724 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
   725 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   726 │       │       │      │       │       │       │               │       │    t_steps = info.get('t_steps', 11)                                                                                         
   727 │       │       │      │       │       │       │               │       │                                                                                                                              
   728 │       │       │      │       │       │       │               │       │    # Create the Pandas DataFrame which we will write to an Excel sheet                                                       
   729 │       │       │      │       │       │       │               │       │    performance_df = pd.DataFrame(                                                                                            
   730 │       │       │      │       │       │       │               │       │        columns=(                                                                                                             
   731 │       │       │      │       │       │       │               │       │            'Iterations',                                                                                                     
   732 │       │       │      │       │       │       │               │       │            'Success',                                                                                                        
   733 │       │       │      │       │       │       │               │       │            'Prediction',                                                                                                     
   734 │       │       │      │       │       │       │               │       │            'Error',                                                                                                          
   735 │       │       │      │       │       │       │               │       │            'Cross Entropy Loss',                                                                                             
   736 │       │       │      │       │       │       │               │       │            'Success %'                                                                                                       
   737 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   738 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   739 │       │       │      │       │       │       │               │       │                                                                                                                              
   740 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
   741 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
   742 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
   743 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
   744 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
   745 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
   746 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
   747 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   748 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
   749 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   750 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
   751 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
   752 │       │       │      │       │       │       │               │       │                                                                                                                              
   753 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
   754 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
   755 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
   756 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
   757 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
   758 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   759 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   760 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
   761 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
   762 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   763 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   764 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   765 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
   766 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
   767 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   768 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   769 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   770 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   771 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
   772 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   773 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   774 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   775 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
   776 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
   777 │       │       │      │       │       │       │               │       │                                                                                                                              
   778 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
   779 │       │       │      │       │       │       │               │       │    if not virtual:                                                                                                           
   780 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   781 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   782 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   783 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
   784 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   785 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   786 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   787 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   788 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   789 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
   790 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   791 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
   792 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   793 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
   794 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   795 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
   796 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
   797 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
   798 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
   799 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   800 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   801 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   802 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
   803 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
   804 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   805 │       │       │      │       │       │       │               │       │                                                                                                                              
   806 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
   807 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
   808 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
   809 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
   810 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
   811 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
   812 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   813 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
   814 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_{"mechanistic_" if MECHANISTIC else ""}'                                   
   815 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
   816 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
   817 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
   818 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
   819 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   820 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
   821 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   822 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
   823 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
   824 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   825 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
   826 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   827 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
   828 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
   829 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
   830 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
   831 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
   832 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   833 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
   834 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   835 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
   836 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   837 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   838 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
   839 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
   840 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
   841 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
   842 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
   843 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
   844 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
   845 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   846 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
   847 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
   848 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
   849 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
   850 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
   851 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
   852 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
   853 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
   854 │       │       │      │       │       │       │               │       │                                                                                                                              
   855 │       │       │      │       │       │       │               │       │        # Pandas Series to allow us to insert the number of iterations for each                                               
   856 │       │       │      │       │       │       │               │       │        #  group of predicitons only in the first row of the group                                                            
   857 │       │       │      │       │       │       │               │       │        iterations = pd.Series((itr*100,), index=(index[0],))                                                                 
   858 │       │       │      │       │       │       │               │       │                                                                                                                              
   859 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
   860 │       │       │      │       │       │       │               │       │        for (data, labels) in loader:                                                                                         
   861 │       │       │      │       │       │       │               │       │            # Check how many patients are in the batch (as it may be less than                                                
   862 │       │       │      │       │       │       │               │       │            #  BATCH_SIZE if it's the last batch)                                                                             
   863 │       │       │      │       │       │       │               │       │            batch_size_ = data.size(0)                                                                                        
   864 │       │       │      │       │       │       │               │       │            # Ensure the data is only CORT if CORT_ONLY, and that the data and                                                
   865 │       │       │      │       │       │       │               │       │            #  labels are loaded into the proper device memory                                                                
   866 │       │       │      │       │       │       │               │       │            if CORT_ONLY:                                                                                                     
   867 │       │       │      │       │       │       │               │       │                data = data[...,2]                                                                                            
   868 │       │       │      │       │       │       │               │       │            elif toy_data and INPUT_CHANNELS == 2:                                                                            
   869 │       │       │      │       │       │       │               │       │                data = data[...,[2,3]]                                                                                        
   870 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   871 │       │       │      │       │       │       │               │       │                data = data[...,1:]                                                                                           
   872 │       │       │      │       │       │       │               │       │            data = data.to(DEVICE)                                                                                            
   873 │       │       │      │       │       │       │               │       │            labels = labels.to(DEVICE) if CLASSIFY else data                                                                  
   874 │       │       │      │       │       │       │               │       │                                                                                                                              
   875 │       │       │      │       │       │       │               │       │            # We need to reshape the data to fit the ANN properly                                                             
   876 │       │       │      │       │       │       │               │       │            pred_y = model(                                                                                                   
   877 │       │       │      │       │       │       │               │       │                data.reshape(                                                                                                 
   878 │       │       │      │       │       │       │               │       │                    batch_size_,                                                                                              
   879 │       │       │      │       │       │       │               │       │                    INPUT_CHANNELS*t_steps)                                                                                   
   880 │       │       │      │       │       │       │               │       │            ).squeeze(-1).reshape(-1, labels.size(1), labels.size(2))                                                         
   881 │       │       │      │       │       │       │               │       │            output = loss(pred_y, labels)                                                                                     
   882 │       │       │      │       │       │       │               │       │                                                                                                                              
   883 │       │       │      │       │       │       │               │       │            # We need to run pred_y through a sigmoid layer to check for                                                      
   884 │       │       │      │       │       │       │               │       │            #  success and error because when training we use                                                                 
   885 │       │       │      │       │       │       │               │       │            #  binary_cross_entropy_with_logits, which combines a sigmoid                                                     
   886 │       │       │      │       │       │       │               │       │            #  layer with BCE (improved performance over running sigmoid then                                                 
   887 │       │       │      │       │       │       │               │       │            #  BCE with torch)                                                                                                
   888 │       │       │      │       │       │       │               │       │            pred_y = torch.sigmoid(pred_y)                                                                                    
   889 │       │       │      │       │       │       │               │       │            error = torch.abs(labels - pred_y)                                                                                
   890 │       │       │      │       │       │       │               │       │                                                                                                                              
   891 │       │       │      │       │       │       │               │       │            # Rounding the predicted y to see if it was successful                                                            
   892 │       │       │      │       │       │       │               │       │            rounded_y = torch.round(pred_y)                                                                                   
   893 │       │       │      │       │       │       │               │       │            success = [not y for y in torch.abs(labels - rounded_y)]                                                          
   894 │       │       │      │       │       │       │               │       │                                                                                                                              
   895 │       │       │      │       │       │       │               │       │            # Create Pandas Series objects so that we can insert these only                                                   
   896 │       │       │      │       │       │       │               │       │            #  in the last row of each iteration prediction group                                                             
   897 │       │       │      │       │       │       │               │       │            cross_entropy_loss = pd.Series(                                                                                   
   898 │       │       │      │       │       │       │               │       │                (output.item(),),                                                                                             
   899 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
   900 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   901 │       │       │      │       │       │       │               │       │            success_pct = pd.Series(                                                                                          
   902 │       │       │      │       │       │       │               │       │                (sum(success)/len(pred_y),),                                                                                  
   903 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
   904 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   905 │       │       │      │       │       │       │               │       │            tmp_df = pd.DataFrame(                                                                                            
   906 │       │       │      │       │       │       │               │       │                data={                                                                                                        
   907 │       │       │      │       │       │       │               │       │                    'Iterations': iterations,                                                                                 
   908 │       │       │      │       │       │       │               │       │                    'Success': success,                                                                                       
   909 │       │       │      │       │       │       │               │       │                    'Prediction': pred_y,                                                                                     
   910 │       │       │      │       │       │       │               │       │                    'Error': error,                                                                                           
   911 │       │       │      │       │       │       │               │       │                    'Cross Entropy Loss': cross_entropy_loss,                                                                 
   912 │       │       │      │       │       │       │               │       │                    'Success %': success_pct                                                                                  
   913 │       │       │      │       │       │       │               │       │                }, index=index                                                                                                
   914 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   915 │       │       │      │       │       │       │               │       │                                                                                                                              
   916 │       │       │      │       │       │       │               │       │            # Add the performance metrics to the DataFrame as a new row                                                       
   917 │       │       │      │       │       │       │               │       │            performance_df = pd.concat(                                                                                       
   918 │       │       │      │       │       │       │               │       │                (                                                                                                             
   919 │       │       │      │       │       │       │               │       │                    performance_df,                                                                                           
   920 │       │       │      │       │       │       │               │       │                    tmp_df                                                                                                    
   921 │       │       │      │       │       │       │               │       │                ),                                                                                                            
   922 │       │       │      │       │       │       │               │       │            )                                                                                                                 
   923 │       │       │      │       │       │       │               │       │    # Save the DataFrame to a file                                                                                            
   924 │       │       │      │       │       │       │               │       │    save_performance(performance_df, info)                                                                                    
   925 │       │       │      │       │       │       │               │       │                                                                                                                              
   926 │       │       │      │       │       │       │               │       │                                                                                                                              
   927 │       │       │      │       │       │       │               │       │def classification_rnn_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                             
   928 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
   929 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
   930 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
   931 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
   932 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
   933 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
   934 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
   935 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
   936 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
   937 │       │       │      │       │       │       │               │       │    t_steps = info.get('t_steps', 11)                                                                                         
   938 │       │       │      │       │       │       │               │       │                                                                                                                              
   939 │       │       │      │       │       │       │               │       │    # Create the Pandas DataFrame which we will write to an Excel sheet                                                       
   940 │       │       │      │       │       │       │               │       │    performance_df = pd.DataFrame(                                                                                            
   941 │       │       │      │       │       │       │               │       │        columns=(                                                                                                             
   942 │       │       │      │       │       │       │               │       │            'Iterations',                                                                                                     
   943 │       │       │      │       │       │       │               │       │            'Success',                                                                                                        
   944 │       │       │      │       │       │       │               │       │            'Prediction',                                                                                                     
   945 │       │       │      │       │       │       │               │       │            'Error',                                                                                                          
   946 │       │       │      │       │       │       │               │       │            'Cross Entropy Loss',                                                                                             
   947 │       │       │      │       │       │       │               │       │            'Success %'                                                                                                       
   948 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   949 │       │       │      │       │       │       │               │       │    )                                                                                                                         
   950 │       │       │      │       │       │       │               │       │                                                                                                                              
   951 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
   952 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
   953 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
   954 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
   955 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
   956 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
   957 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
   958 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   959 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
   960 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
   961 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
   962 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
   963 │       │       │      │       │       │       │               │       │                                                                                                                              
   964 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
   965 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
   966 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
   967 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
   968 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
   969 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   970 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   971 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
   972 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
   973 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   974 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   975 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   976 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
   977 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
   978 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   979 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   980 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   981 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
   982 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
   983 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
   984 │       │       │      │       │       │       │               │       │            else:                                                                                                             
   985 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
   986 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
   987 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
   988 │       │       │      │       │       │       │               │       │                                                                                                                              
   989 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
   990 │       │       │      │       │       │       │               │       │    if not virtual:                                                                                                           
   991 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   992 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   993 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
   994 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
   995 │       │       │      │       │       │       │               │       │        )                                                                                                                     
   996 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
   997 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
   998 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
   999 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1000 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
  1001 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1002 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
  1003 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1004 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
  1005 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1006 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
  1007 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
  1008 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
  1009 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
  1010 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1011 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1012 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1013 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
  1014 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
  1015 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1016 │       │       │      │       │       │       │               │       │                                                                                                                              
  1017 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
  1018 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
  1019 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
  1020 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
  1021 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
  1022 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
  1023 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1024 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_{"mechanistic_" if MECHANISTIC else ""}'                                
  1025 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1026 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
  1027 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
  1028 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
  1029 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1030 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1031 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1032 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1033 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
  1034 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
  1035 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1036 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
  1037 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1038 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1039 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1040 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
  1041 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
  1042 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1043 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1044 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1045 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1046 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1047 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1048 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1049 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1050 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1051 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
  1052 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1053 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1054 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1055 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1056 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1057 │       │       │      │       │       │       │               │       │        readout_filename = "".join(                                                                                           
  1058 │       │       │      │       │       │       │               │       │            [state_file[:-4], '_readout', state_file[-4:]]                                                                    
  1059 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1060 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
  1061 │       │       │      │       │       │       │               │       │        readout_filepath = os.path.join(directory, readout_filename)                                                          
  1062 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
  1063 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
  1064 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
  1065 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
  1066 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
  1067 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
  1068 │       │       │      │       │       │       │               │       │        readout_state_dict = torch.load(readout_filepath, map_location=DEVICE)                                                
  1069 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
  1070 │       │       │      │       │       │       │               │       │        readout = nn.Linear(HDIM, 1).double()                                                                                 
  1071 │       │       │      │       │       │       │               │       │        readout.load_state_dict(readout_state_dict)                                                                           
  1072 │       │       │      │       │       │       │               │       │                                                                                                                              
  1073 │       │       │      │       │       │       │               │       │        # Pandas Series to allow us to insert the number of iterations for each                                               
  1074 │       │       │      │       │       │       │               │       │        #  group of predicitons only in the first row of the group                                                            
  1075 │       │       │      │       │       │       │               │       │        iterations = pd.Series((itr*100,), index=(index[0],))                                                                 
  1076 │       │       │      │       │       │       │               │       │                                                                                                                              
  1077 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
  1078 │       │       │      │       │       │       │               │       │        for (data, labels) in loader:                                                                                         
  1079 │       │       │      │       │       │       │               │       │            # Check how many patients are in the batch (as it may be less than                                                
  1080 │       │       │      │       │       │       │               │       │            #  BATCH_SIZE if it's the last batch)                                                                             
  1081 │       │       │      │       │       │       │               │       │            batch_size_ = data.size(0)                                                                                        
  1082 │       │       │      │       │       │       │               │       │            # Ensure the data is only CORT if CORT_ONLY, and that the data and                                                
  1083 │       │       │      │       │       │       │               │       │            #  labels are loaded into the proper device memory                                                                
  1084 │       │       │      │       │       │       │               │       │            if CORT_ONLY:                                                                                                     
  1085 │       │       │      │       │       │       │               │       │                data = data[...,2]                                                                                            
  1086 │       │       │      │       │       │       │               │       │            elif toy_data and INPUT_CHANNELS == 2:                                                                            
  1087 │       │       │      │       │       │       │               │       │                data = data[...,[2,3]]                                                                                        
  1088 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1089 │       │       │      │       │       │       │               │       │                data = data[...,1:]                                                                                           
  1090 │       │       │      │       │       │       │               │       │            data = data.to(DEVICE)                                                                                            
  1091 │       │       │      │       │       │       │               │       │            labels = labels.to(DEVICE) if CLASSIFY else data                                                                  
  1092 │       │       │      │       │       │       │               │       │                                                                                                                              
  1093 │       │       │      │       │       │       │               │       │            # We need to reshape the data to fit the ANN properly                                                             
  1094 │       │       │      │       │       │       │               │       │            pred_y = model(                                                                                                   
  1095 │       │       │      │       │       │       │               │       │                data.reshape(                                                                                                 
  1096 │       │       │      │       │       │       │               │       │                    batch_size_,                                                                                              
  1097 │       │       │      │       │       │       │               │       │                    INPUT_CHANNELS*t_steps)                                                                                   
  1098 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1099 │       │       │      │       │       │       │               │       │            pred_y = readout(pred_y).squeeze(-1).reshape(-1, labels.size(1), labels.size(2))                                  
  1100 │       │       │      │       │       │       │               │       │                                                                                                                              
  1101 │       │       │      │       │       │       │               │       │            output = loss(pred_y, labels)                                                                                     
  1102 │       │       │      │       │       │       │               │       │                                                                                                                              
  1103 │       │       │      │       │       │       │               │       │            # We need to run pred_y through a sigmoid layer to check for                                                      
  1104 │       │       │      │       │       │       │               │       │            #  success and error because when training we use                                                                 
  1105 │       │       │      │       │       │       │               │       │            #  binary_cross_entropy_with_logits, which combines a sigmoid                                                     
  1106 │       │       │      │       │       │       │               │       │            #  layer with BCE (improved performance over running sigmoid then                                                 
  1107 │       │       │      │       │       │       │               │       │            #  BCE with torch)                                                                                                
  1108 │       │       │      │       │       │       │               │       │            pred_y = torch.sigmoid(pred_y)                                                                                    
  1109 │       │       │      │       │       │       │               │       │            error = torch.abs(labels - pred_y)                                                                                
  1110 │       │       │      │       │       │       │               │       │                                                                                                                              
  1111 │       │       │      │       │       │       │               │       │            # Rounding the predicted y to see if it was successful                                                            
  1112 │       │       │      │       │       │       │               │       │            rounded_y = torch.round(pred_y)                                                                                   
  1113 │       │       │      │       │       │       │               │       │            success = [not y for y in torch.abs(labels - rounded_y)]                                                          
  1114 │       │       │      │       │       │       │               │       │                                                                                                                              
  1115 │       │       │      │       │       │       │               │       │            # Create Pandas Series objects so that we can insert these only                                                   
  1116 │       │       │      │       │       │       │               │       │            #  in the last row of each iteration prediction group                                                             
  1117 │       │       │      │       │       │       │               │       │            cross_entropy_loss = pd.Series(                                                                                   
  1118 │       │       │      │       │       │       │               │       │                (output.item(),),                                                                                             
  1119 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
  1120 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1121 │       │       │      │       │       │       │               │       │            success_pct = pd.Series(                                                                                          
  1122 │       │       │      │       │       │       │               │       │                (sum(success)/len(pred_y),),                                                                                  
  1123 │       │       │      │       │       │       │               │       │                index=(index[-1],)                                                                                            
  1124 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1125 │       │       │      │       │       │       │               │       │            tmp_df = pd.DataFrame(                                                                                            
  1126 │       │       │      │       │       │       │               │       │                data={                                                                                                        
  1127 │       │       │      │       │       │       │               │       │                    'Iterations': iterations,                                                                                 
  1128 │       │       │      │       │       │       │               │       │                    'Success': success,                                                                                       
  1129 │       │       │      │       │       │       │               │       │                    'Prediction': pred_y,                                                                                     
  1130 │       │       │      │       │       │       │               │       │                    'Error': error,                                                                                           
  1131 │       │       │      │       │       │       │               │       │                    'Cross Entropy Loss': cross_entropy_loss,                                                                 
  1132 │       │       │      │       │       │       │               │       │                    'Success %': success_pct                                                                                  
  1133 │       │       │      │       │       │       │               │       │                }, index=index                                                                                                
  1134 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1135 │       │       │      │       │       │       │               │       │                                                                                                                              
  1136 │       │       │      │       │       │       │               │       │            # Add the performance metrics to the DataFrame as a new row                                                       
  1137 │       │       │      │       │       │       │               │       │            performance_df = pd.concat(                                                                                       
  1138 │       │       │      │       │       │       │               │       │                (                                                                                                             
  1139 │       │       │      │       │       │       │               │       │                    performance_df,                                                                                           
  1140 │       │       │      │       │       │       │               │       │                    tmp_df                                                                                                    
  1141 │       │       │      │       │       │       │               │       │                ),                                                                                                            
  1142 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1143 │       │       │      │       │       │       │               │       │    # Save the DataFrame to a file                                                                                            
  1144 │       │       │      │       │       │       │               │       │    save_performance(performance_df, info)                                                                                    
  1145 │       │       │      │       │       │       │               │       │                                                                                                                              
  1146 │       │       │      │       │       │       │               │       │                                                                                                                              
  1147 │       │       │      │       │       │       │               │       │def prediction_ncde_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                                
  1148 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
  1149 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
  1150 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
  1151 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
  1152 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
  1153 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
  1154 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
  1155 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
  1156 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
  1157 │       │       │      │       │       │       │               │       │                                                                                                                              
  1158 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
  1159 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
  1160 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
  1161 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
  1162 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
  1163 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
  1164 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
  1165 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1166 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
  1167 │       │       │      │       │       │       │               │       │    elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                      
  1168 │       │       │      │       │       │       │               │       │        index = [INDIVIDUAL_NUMBER]                                                                                           
  1169 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1170 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
  1171 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
  1172 │       │       │      │       │       │       │               │       │                                                                                                                              
  1173 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
  1174 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
  1175 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
  1176 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
  1177 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
  1178 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1179 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1180 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
  1181 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
  1182 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1183 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1184 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1185 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
  1186 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
  1187 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1188 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1189 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1190 │       │       │      │       │       │       │               │       │        elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                  
  1191 │       │       │      │       │       │       │               │       │            t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                          
  1192 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1193 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
  1194 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1195 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1196 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1197 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
  1198 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
  1199 │       │       │      │       │       │       │               │       │                                                                                                                              
  1200 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
  1201 │       │       │      │       │       │       │               │       │    if not virtual and len(PATIENT_GROUPS) == 1:                                                                              
  1202 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1203 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1204 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1205 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}/'                                                                                           
  1206 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1207 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
  1208 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1209 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1210 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
  1211 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1212 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1213 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1214 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1215 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1216 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
  1217 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1218 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
  1219 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1220 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
  1221 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1222 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
  1223 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
  1224 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
  1225 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
  1226 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1227 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1228 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1229 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
  1230 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1231 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
  1232 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1233 │       │       │      │       │       │       │               │       │                                                                                                                              
  1234 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
  1235 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
  1236 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
  1237 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
  1238 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
  1239 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
  1240 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1241 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_{"mechanistic_" if MECHANISTIC else ""}'                                
  1242 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1243 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
  1244 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
  1245 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
  1246 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1247 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1248 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1249 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1250 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
  1251 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
  1252 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1253 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
  1254 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1255 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1256 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1257 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
  1258 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
  1259 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1260 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1261 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1262 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1263 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1264 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1265 │       │       │      │       │       │       │               │       │        elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                  
  1266 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1267 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1268 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]}{INDIVIDUAL_NUMBER}_'                                                                    
  1269 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1270 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1271 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1272 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1273 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1274 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1275 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1276 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1277 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
  1278 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1279 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1280 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1281 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1282 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1283 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
  1284 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
  1285 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
  1286 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
  1287 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
  1288 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
  1289 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
  1290 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
  1291 │       │       │      │       │       │       │               │       │                                                                                                                              
  1292 │       │       │      │       │       │       │               │       │        # Pandas Series to allow us to insert the number of iterations for each                                               
  1293 │       │       │      │       │       │       │               │       │        #  group of predicitons only in the first row of the group                                                            
  1294 │       │       │      │       │       │       │               │       │        iterations = pd.Series((itr*SAVE_FREQ,), index=(index[0],))                                                           
  1295 │       │       │      │       │       │       │               │       │                                                                                                                              
  1296 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
  1297 │       │       │      │       │       │       │               │       │        for (data, labels) in loader:                                                                                         
  1298 │       │       │      │       │       │       │               │       │            for i, pt in enumerate(data):                                                                                     
  1299 │       │       │      │       │       │       │               │       │                if INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                            
  1300 │       │       │      │       │       │       │               │       │                    pt = pt.double().view(1,t_steps,-1)                                                                       
  1301 │       │       │      │       │       │       │               │       │                # Ensure the data is only CORT if CORT_ONLY, and that the data and                                            
  1302 │       │       │      │       │       │       │               │       │                #  labels are loaded into the proper device memory                                                            
  1303 │       │       │      │       │       │       │               │       │                data_orig = pt                                                                                                
  1304 │       │       │      │       │       │       │               │       │                if CORT_ONLY:                                                                                                 
  1305 │       │       │      │       │       │       │               │       │                    pt = pt[...,[0,2]]                                                                                        
  1306 │       │       │      │       │       │       │               │       │                if toy_data and INPUT_CHANNELS == 3:                                                                          
  1307 │       │       │      │       │       │       │               │       │                    pt = pt[...,[0,2,3]]                                                                                      
  1308 │       │       │      │       │       │       │               │       │                pt = pt.to(DEVICE)                                                                                            
  1309 │       │       │      │       │       │       │               │       │                labels = labels.to(DEVICE) if CLASSIFY else pt                                                                
  1310 │       │       │      │       │       │       │               │       │                coeffs = torchcde.\                                                                                           
  1311 │       │       │      │       │       │       │               │       │                    hermite_cubic_coefficients_with_backward_differences(data)                                                
  1312 │       │       │      │       │       │       │               │       │                                                                                                                              
  1313 │       │       │      │       │       │       │               │       │                pred_y = model(coeffs).squeeze(-1)                                                                            
  1314 │       │       │      │       │       │       │               │       │                                                                                                                              
  1315 │       │       │      │       │       │       │               │       │                if i < len(index)/2:                                                                                          
  1316 │       │       │      │       │       │       │               │       │                    patient_id = f'Control Patient {index[i]}'                                                                
  1317 │       │       │      │       │       │       │               │       │                else:                                                                                                         
  1318 │       │       │      │       │       │       │               │       │                    patient_id = f'MDD Patient {index[i]}'                                                                    
  1319 │       │       │      │       │       │       │               │       │                                                                                                                              
  1320 │       │       │      │       │       │       │               │       │                # Graph the results                                                                                           
  1321 │       │       │      │       │       │       │               │       │                graph_results(pred_y, data_orig, patient_id, itr, info)                                                       
  1322 │       │       │      │       │       │       │               │       │                                                                                                                              
  1323 │       │       │      │       │       │       │               │       │                                                                                                                              
  1324 │       │       │      │       │       │       │               │       │def prediction_node_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                                
  1325 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
  1326 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
  1327 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
  1328 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
  1329 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
  1330 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
  1331 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
  1332 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
  1333 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
  1334 │       │       │      │       │       │       │               │       │    t_steps = info.get('t_steps', 11)                                                                                         
  1335 │       │       │      │       │       │       │               │       │                                                                                                                              
  1336 │       │       │      │       │       │       │               │       │    # Initialize the parameters if we are doing mechanistic loss                                                              
  1337 │       │       │      │       │       │       │               │       │    param_init(model)                                                                                                         
  1338 │       │       │      │       │       │       │               │       │                                                                                                                              
  1339 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
  1340 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
  1341 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
  1342 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
  1343 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
  1344 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
  1345 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
  1346 │       │       │      │       │       │       │               │       │    elif toy_data and len(PATIENT_GROUPS) == 1:                                                                               
  1347 │       │       │      │       │       │       │               │       │        index = [i for i in range(1000)]                                                                                      
  1348 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1349 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
  1350 │       │       │      │       │       │       │               │       │    elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                      
  1351 │       │       │      │       │       │       │               │       │        index = [INDIVIDUAL_NUMBER]                                                                                           
  1352 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1353 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
  1354 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
  1355 │       │       │      │       │       │       │               │       │                                                                                                                              
  1356 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
  1357 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
  1358 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
  1359 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
  1360 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
  1361 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1362 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1363 │       │       │      │       │       │       │               │       │        elif toy_data and len(PATIENT_GROUPS) == 1:                                                                           
  1364 │       │       │      │       │       │       │               │       │            t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                          
  1365 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
  1366 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
  1367 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1368 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1369 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1370 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
  1371 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
  1372 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1373 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1374 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1375 │       │       │      │       │       │       │               │       │        elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                  
  1376 │       │       │      │       │       │       │               │       │            t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                          
  1377 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1378 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
  1379 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1380 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1381 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1382 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
  1383 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
  1384 │       │       │      │       │       │       │               │       │                                                                                                                              
  1385 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
  1386 │       │       │      │       │       │       │               │       │    if not virtual and len(PATIENT_GROUPS) == 1:                                                                              
  1387 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1388 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1389 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1390 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}/'                                                                                           
  1391 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1392 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
  1393 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1394 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1395 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1396 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
  1397 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1398 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1399 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1400 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1401 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1402 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
  1403 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1404 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
  1405 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1406 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
  1407 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1408 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
  1409 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
  1410 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
  1411 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
  1412 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1413 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1414 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1415 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
  1416 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
  1417 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1418 │       │       │      │       │       │       │               │       │                                                                                                                              
  1419 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
  1420 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
  1421 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
  1422 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
  1423 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
  1424 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
  1425 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1426 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_{"mechanistic_" if MECHANISTIC else ""}'                                
  1427 │       │       │      │       │       │       │               │       │                                                                                                                              
  1428 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1429 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
  1430 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
  1431 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
  1432 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1433 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1434 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1435 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1436 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
  1437 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
  1438 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1439 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
  1440 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1441 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1442 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1443 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
  1444 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
  1445 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1446 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1447 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1448 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1449 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1450 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1451 │       │       │      │       │       │       │               │       │        elif len(PATIENT_GROUPS) == 1:                                                                                        
  1452 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1453 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1454 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]}{INDIVIDUAL_NUMBER}_'                                                                    
  1455 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1456 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1457 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1458 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1459 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1460 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1461 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1462 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1463 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
  1464 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1465 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1466 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1467 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1468 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1469 │       │       │      │       │       │       │               │       │        readout_filename = "".join(                                                                                           
  1470 │       │       │      │       │       │       │               │       │            [state_file[:-4], '_readout', state_file[-4:]]                                                                    
  1471 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1472 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
  1473 │       │       │      │       │       │       │               │       │        readout_filepath = os.path.join(directory, readout_filename)                                                          
  1474 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
  1475 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
  1476 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
  1477 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
  1478 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
  1479 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
  1480 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
  1481 │       │       │      │       │       │       │               │       │                                                                                                                              
  1482 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
  1483 │       │       │      │       │       │       │               │       │        for (data, labels) in loader:                                                                                         
  1484 │       │       │      │       │       │       │               │       │            for i, pt in enumerate(data):                                                                                     
  1485 │       │       │      │       │       │       │               │       │                if INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                            
  1486 │       │       │      │       │       │       │               │       │                    pt = pt.double().view(1,t_steps,INPUT_CHANNELS+1)                                                         
  1487 │       │       │      │       │       │       │               │       │                elif toy_data and not virtual:                                                                                
  1488 │       │       │      │       │       │       │               │       │                    pt = pt.double().view(1, t_steps, INPUT_CHANNELS+1)                                                       
  1489 │       │       │      │       │       │       │               │       │                data_orig = pt                                                                                                
  1490 │       │       │      │       │       │       │               │       │                t_eval = pt[0,:,0].view(-1)                                                                                   
  1491 │       │       │      │       │       │       │               │       │                dense_t_eval = torch.linspace(t_eval[0], t_eval[-1], 1000, dtype=torch.float64)                               
  1492 │       │       │      │       │       │       │               │       │                # Ensure we have assigned the data and labels to the correct                                                  
  1493 │       │       │      │       │       │       │               │       │                #  processing device                                                                                          
  1494 │       │       │      │       │       │       │               │       │                if CORT_ONLY:                                                                                                 
  1495 │       │       │      │       │       │       │               │       │                    # If we are only using CORT, we can discard the middle column as it                                       
  1496 │       │       │      │       │       │       │               │       │                    #  contains the ACTH concentrations                                                                       
  1497 │       │       │      │       │       │       │               │       │                    pt = pt[...,2]                                                                                            
  1498 │       │       │      │       │       │       │               │       │                if toy_data and INPUT_CHANNELS == 2:                                                                          
  1499 │       │       │      │       │       │       │               │       │                    pt = pt[...,[2,3]]                                                                                        
  1500 │       │       │      │       │       │       │               │       │                pt = pt.to(DEVICE)                                                                                            
  1501 │       │       │      │       │       │       │               │       │                labels = labels.to(DEVICE) if CLASSIFY else pt                                                                
  1502 │       │       │      │       │       │       │               │       │                y0 = pt[:,0,1:]                                                                                               
  1503 │       │       │      │       │       │       │               │       │                                                                                                                              
  1504 │       │       │      │       │       │       │               │       │                # Compute the forward direction of the NODE                                                                   
  1505 │       │       │      │       │       │       │               │       │                pred_y = odeint(                                                                                              
  1506 │       │       │      │       │       │       │               │       │                    model, y0, dense_t_eval                                                                                   
  1507 │       │       │      │       │       │       │               │       │                ).squeeze(-1)                                                                                                 
  1508 │       │       │      │       │       │       │               │       │                                                                                                                              
  1509 │       │       │      │       │       │       │               │       │                if i < len(index)/2:                                                                                          
  1510 │       │       │      │       │       │       │               │       │                    patient_id = f'Control Patient {index[i]}'                                                                
  1511 │       │       │      │       │       │       │               │       │                else:                                                                                                         
  1512 │       │       │      │       │       │       │               │       │                    patient_id = f'MDD Patient {index[i]}'                                                                    
  1513 │       │       │      │       │       │       │               │       │                                                                                                                              
  1514 │       │       │      │       │       │       │               │       │                # Graph the results                                                                                           
  1515 │       │       │      │       │       │       │               │       │                graph_results(pred_y, dense_t_eval, data_orig, patient_id,                                                    
  1516 │       │       │      │       │       │       │               │       │                              itr, info)                                                                                      
  1517 │       │       │      │       │       │       │               │       │                                                                                                                              
  1518 │       │       │      │       │       │       │               │       │                                                                                                                              
  1519 │       │       │      │       │       │       │               │       │def prediction_ann_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                                 
  1520 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
  1521 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
  1522 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
  1523 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
  1524 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
  1525 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
  1526 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
  1527 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
  1528 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
  1529 │       │       │      │       │       │       │               │       │    t_steps = info.get('t_steps', 11)                                                                                         
  1530 │       │       │      │       │       │       │               │       │                                                                                                                              
  1531 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
  1532 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
  1533 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
  1534 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
  1535 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
  1536 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
  1537 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
  1538 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1539 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
  1540 │       │       │      │       │       │       │               │       │    elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                      
  1541 │       │       │      │       │       │       │               │       │        index = [INDIVIDUAL_NUMBER]                                                                                           
  1542 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1543 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
  1544 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
  1545 │       │       │      │       │       │       │               │       │                                                                                                                              
  1546 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
  1547 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
  1548 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
  1549 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
  1550 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
  1551 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1552 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1553 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
  1554 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
  1555 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1556 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1557 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1558 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
  1559 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
  1560 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1561 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1562 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1563 │       │       │      │       │       │       │               │       │        elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                  
  1564 │       │       │      │       │       │       │               │       │            t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                          
  1565 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1566 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
  1567 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1568 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1569 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1570 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
  1571 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
  1572 │       │       │      │       │       │       │               │       │                                                                                                                              
  1573 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
  1574 │       │       │      │       │       │       │               │       │    if not virtual and len(PATIENT_GROUPS) == 1:                                                                              
  1575 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1576 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1577 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1578 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}/'                                                                                           
  1579 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1580 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
  1581 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1582 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1583 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1584 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
  1585 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1586 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1587 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1588 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1589 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1590 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
  1591 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1592 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
  1593 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1594 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
  1595 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1596 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
  1597 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
  1598 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
  1599 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
  1600 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1601 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1602 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1603 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
  1604 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
  1605 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1606 │       │       │      │       │       │       │               │       │                                                                                                                              
  1607 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
  1608 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
  1609 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
  1610 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
  1611 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
  1612 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
  1613 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1614 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1615 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_{"mechanistic_" if MECHANISTIC else ""}'                                   
  1616 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
  1617 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
  1618 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
  1619 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1620 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1621 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1622 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1623 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
  1624 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
  1625 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1626 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
  1627 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1628 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1629 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1630 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
  1631 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
  1632 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1633 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1634 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1635 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1636 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1637 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1638 │       │       │      │       │       │       │               │       │        elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                  
  1639 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1640 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1641 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]}{INDIVIDUAL_NUMBER}_'                                                                    
  1642 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1643 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1644 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1645 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1646 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1647 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1648 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1649 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1650 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
  1651 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1652 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1653 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1654 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1655 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1656 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
  1657 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
  1658 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
  1659 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
  1660 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
  1661 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
  1662 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
  1663 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
  1664 │       │       │      │       │       │       │               │       │                                                                                                                              
  1665 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
  1666 │       │       │      │       │       │       │               │       │        for i, (data, labels) in enumerate(loader):                                                                           
  1667 │       │       │      │       │       │       │               │       │            for i, pt in enumerate(data):                                                                                     
  1668 │       │       │      │       │       │       │               │       │                if INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                            
  1669 │       │       │      │       │       │       │               │       │                    pt = pt.double().view(1,t_steps,-1)                                                                       
  1670 │       │       │      │       │       │       │               │       │                data_orig = pt                                                                                                
  1671 │       │       │      │       │       │       │               │       │                # Here, we only ever have a batch size of 1 for plotting                                                      
  1672 │       │       │      │       │       │       │               │       │                batch_size_ = 1                                                                                               
  1673 │       │       │      │       │       │       │               │       │                # Ensure the data is only CORT if CORT_ONLY, and that the data and                                            
  1674 │       │       │      │       │       │       │               │       │                #  labels are loaded into the proper device memory                                                            
  1675 │       │       │      │       │       │       │               │       │                if CORT_ONLY:                                                                                                 
  1676 │       │       │      │       │       │       │               │       │                    pt = pt[...,2]                                                                                            
  1677 │       │       │      │       │       │       │               │       │                elif toy_data and INPUT_CHANNELS == 2:                                                                        
  1678 │       │       │      │       │       │       │               │       │                    pt = pt[...,[2,3]]                                                                                        
  1679 │       │       │      │       │       │       │               │       │                else:                                                                                                         
  1680 │       │       │      │       │       │       │               │       │                    pt = pt[...,1:]                                                                                           
  1681 │       │       │      │       │       │       │               │       │                pt = pt.to(DEVICE)                                                                                            
  1682 │       │       │      │       │       │       │               │       │                labels = labels.to(DEVICE) if CLASSIFY else pt                                                                
  1683 │       │       │      │       │       │       │               │       │                                                                                                                              
  1684 │       │       │      │       │       │       │               │       │                # We need to reshape the data to fit the ANN properly                                                         
  1685 │       │       │      │       │       │       │               │       │                pred_y = model(                                                                                               
  1686 │       │       │      │       │       │       │               │       │                    pt.reshape(                                                                                               
  1687 │       │       │      │       │       │       │               │       │                        batch_size_,                                                                                          
  1688 │       │       │      │       │       │       │               │       │                        INPUT_CHANNELS*t_steps)                                                                               
  1689 │       │       │      │       │       │       │               │       │                ).squeeze(-1).reshape(-1, labels.size(1))                                                                     
  1690 │       │       │      │       │       │       │               │       │                                                                                                                              
  1691 │       │       │      │       │       │       │               │       │                if i < len(index)/2:                                                                                          
  1692 │       │       │      │       │       │       │               │       │                    patient_id = f'Control Patient {index[i]}'                                                                
  1693 │       │       │      │       │       │       │               │       │                else:                                                                                                         
  1694 │       │       │      │       │       │       │               │       │                    patient_id = f'MDD Patient {index[i]}'                                                                    
  1695 │       │       │      │       │       │       │               │       │                                                                                                                              
  1696 │       │       │      │       │       │       │               │       │                # Graph the results                                                                                           
  1697 │       │       │      │       │       │       │               │       │                graph_results(pred_y, data_orig, patient_id, itr, info)                                                       
  1698 │       │       │      │       │       │       │               │       │                                                                                                                              
  1699 │       │       │      │       │       │       │               │       │                                                                                                                              
  1700 │       │       │      │       │       │       │               │       │def prediction_rnn_testing(model: NeuralCDE, loader: DataLoader, info: dict):                                                 
  1701 │       │       │      │       │       │       │               │       │    """Run the testing procedure for the given model and DataLoader"""                                                        
  1702 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
  1703 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
  1704 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
  1705 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
  1706 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
  1707 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
  1708 │       │       │      │       │       │       │               │       │    ableson_pop = info.get('ableson_pop', False)                                                                              
  1709 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
  1710 │       │       │      │       │       │       │               │       │    t_steps = info.get('t_steps', 11)                                                                                         
  1711 │       │       │      │       │       │       │               │       │                                                                                                                              
  1712 │       │       │      │       │       │       │               │       │    # Set up the index numbers to match the patient numbers of the test                                                       
  1713 │       │       │      │       │       │       │               │       │    #  patients (or just 1-5 for Control and the same for MDD if no test                                                      
  1714 │       │       │      │       │       │       │               │       │    #  combinations)                                                                                                          
  1715 │       │       │      │       │       │       │               │       │    if control_combination:                                                                                                   
  1716 │       │       │      │       │       │       │               │       │        index = control_combination+mdd_combination                                                                           
  1717 │       │       │      │       │       │       │               │       │    elif ableson_pop:                                                                                                         
  1718 │       │       │      │       │       │       │               │       │        index = [i for i in range(50)]                                                                                        
  1719 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1720 │       │       │      │       │       │       │               │       │        index = [i for i in range(2000)]                                                                                      
  1721 │       │       │      │       │       │       │               │       │    elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                      
  1722 │       │       │      │       │       │       │               │       │        index = [INDIVIDUAL_NUMBER]                                                                                           
  1723 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1724 │       │       │      │       │       │       │               │       │        index = [i for i in range(5)]                                                                                         
  1725 │       │       │      │       │       │       │               │       │        index = index+index                                                                                                   
  1726 │       │       │      │       │       │       │               │       │                                                                                                                              
  1727 │       │       │      │       │       │       │               │       │    tmp_index = []                                                                                                            
  1728 │       │       │      │       │       │       │               │       │    for i, entry in enumerate(index):                                                                                         
  1729 │       │       │      │       │       │       │               │       │        if ableson_pop:                                                                                                       
  1730 │       │       │      │       │       │       │               │       │            if i < 37:                                                                                                        
  1731 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' +  str(entry)                                                                     
  1732 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1733 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1734 │       │       │      │       │       │       │               │       │        elif toy_data:                                                                                                        
  1735 │       │       │      │       │       │       │               │       │            if i < 1000:                                                                                                      
  1736 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1737 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1738 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1739 │       │       │      │       │       │       │               │       │        elif control_combination:                                                                                             
  1740 │       │       │      │       │       │       │               │       │            if i < len(control_combination):                                                                                  
  1741 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1742 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1743 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1744 │       │       │      │       │       │       │               │       │        elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                  
  1745 │       │       │      │       │       │       │               │       │            t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                          
  1746 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1747 │       │       │      │       │       │       │               │       │            if i < 5:                                                                                                         
  1748 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[0] + ' ' + str(entry)                                                                      
  1749 │       │       │      │       │       │       │               │       │            else:                                                                                                             
  1750 │       │       │      │       │       │       │               │       │                t = PATIENT_GROUPS[1] + ' ' + str(entry)                                                                      
  1751 │       │       │      │       │       │       │               │       │        tmp_index.append(t)                                                                                                   
  1752 │       │       │      │       │       │       │               │       │    index = tuple(tmp_index)                                                                                                  
  1753 │       │       │      │       │       │       │               │       │                                                                                                                              
  1754 │       │       │      │       │       │       │               │       │    # Set the directory name where the model state dictionaries are located                                                   
  1755 │       │       │      │       │       │       │               │       │    if not virtual and len(PATIENT_GROUPS) == 1:                                                                              
  1756 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1757 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1758 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1759 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}/'                                                                                           
  1760 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1761 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
  1762 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1763 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1764 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1765 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
  1766 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1767 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1768 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1769 │       │       │      │       │       │       │               │       │            f'Network States/'                                                                                                
  1770 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1771 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
  1772 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1773 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
  1774 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1775 │       │       │      │       │       │       │               │       │            f'Network States ({"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Training)/'                                     
  1776 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1777 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
  1778 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
  1779 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
  1780 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
  1781 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1782 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1783 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1784 │       │       │      │       │       │       │               │       │            f'Network States (VPOP Training)/'                                                                                
  1785 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
  1786 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1787 │       │       │      │       │       │       │               │       │                                                                                                                              
  1788 │       │       │      │       │       │       │               │       │    # Loop over the state dictionaries based on the number of iterations, from                                                
  1789 │       │       │      │       │       │       │               │       │    #  100 to MAX_ITR*100                                                                                                     
  1790 │       │       │      │       │       │       │               │       │    n_saves = int(np.floor(MAX_ITR/SAVE_FREQ))                                                                                
  1791 │       │       │      │       │       │       │               │       │    for itr in range(1,n_saves+1):                                                                                            
  1792 │       │       │      │       │       │       │               │       │        # Set the filename for the network state_dict                                                                         
  1793 │       │       │      │       │       │       │               │       │        if virtual:                                                                                                           
  1794 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1795 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_{"mechanistic_" if MECHANISTIC else ""}'                                
  1796 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1797 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                    
  1798 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                        
  1799 │       │       │      │       │       │       │               │       │                f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                      
  1800 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1801 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1802 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1803 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1804 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}'                                                                                           
  1805 │       │       │      │       │       │       │               │       │                f'{"_byLab" if by_lab else ""}.txt'                                                                           
  1806 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1807 │       │       │      │       │       │       │               │       │        elif ableson_pop:                                                                                                     
  1808 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1809 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1810 │       │       │      │       │       │       │               │       │                f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                          
  1811 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]+str(control_combination)}_'                                                              
  1812 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[1]+str(mdd_combination)}_'                                                                  
  1813 │       │       │      │       │       │       │               │       │                f'{NUM_PER_PATIENT}perPatient_'                                                                               
  1814 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1815 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1816 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1817 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1818 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1819 │       │       │      │       │       │       │               │       │        elif INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                                  
  1820 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1821 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1822 │       │       │      │       │       │       │               │       │                f'{PATIENT_GROUPS[0]}{INDIVIDUAL_NUMBER}_'                                                                    
  1823 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1824 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1825 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1826 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1827 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1828 │       │       │      │       │       │       │               │       │        else:                                                                                                                 
  1829 │       │       │      │       │       │       │               │       │            state_file = (                                                                                                    
  1830 │       │       │      │       │       │       │               │       │                f'NN_state_{HDIM}nodes_{NETWORK_TYPE}_'                                                                       
  1831 │       │       │      │       │       │       │               │       │                f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                            
  1832 │       │       │      │       │       │       │               │       │                f'batchsize{BATCH_SIZE}_'                                                                                     
  1833 │       │       │      │       │       │       │               │       │                f'{itr*SAVE_FREQ}ITER_{NORMALIZE_STANDARDIZE}_'                                                               
  1834 │       │       │      │       │       │       │               │       │                f'smoothing{LABEL_SMOOTHING}_'                                                                                
  1835 │       │       │      │       │       │       │               │       │                f'dropout{DROPOUT}.txt'                                                                                       
  1836 │       │       │      │       │       │       │               │       │            )                                                                                                                 
  1837 │       │       │      │       │       │       │               │       │        readout_filename = "".join(                                                                                           
  1838 │       │       │      │       │       │       │               │       │            [state_file[:-4], '_readout', state_file[-4:]]                                                                    
  1839 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1840 │       │       │      │       │       │       │               │       │        state_filepath = os.path.join(directory, state_file)                                                                  
  1841 │       │       │      │       │       │       │               │       │        readout_filepath = os.path.join(directory, readout_filename)                                                          
  1842 │       │       │      │       │       │       │               │       │        # Check that the file exists                                                                                          
  1843 │       │       │      │       │       │       │               │       │        if not os.path.exists(state_filepath):                                                                                
  1844 │       │       │      │       │       │       │               │       │            raise FileNotFoundError(f'Failed to load file: {state_filepath}')                                                 
  1845 │       │       │      │       │       │       │               │       │        # Load the state dictionary from the file and set the model to that                                                   
  1846 │       │       │      │       │       │       │               │       │        #  state                                                                                                              
  1847 │       │       │      │       │       │       │               │       │        state_dict = torch.load(state_filepath, map_location=DEVICE)                                                          
  1848 │       │       │      │       │       │       │               │       │        readout_state_dict = torch.load(readout_filepath, map_location=DEVICE)                                                
  1849 │       │       │      │       │       │       │               │       │        model.load_state_dict(state_dict)                                                                                     
  1850 │       │       │      │       │       │       │               │       │        readout = nn.Linear(HDIM, 1).double()                                                                                 
  1851 │       │       │      │       │       │       │               │       │        readout.load_state_dict(readout_state_dict)                                                                           
  1852 │       │       │      │       │       │       │               │       │                                                                                                                              
  1853 │       │       │      │       │       │       │               │       │        # Loop through the test patients                                                                                      
  1854 │       │       │      │       │       │       │               │       │        for (data, labels) in loader:                                                                                         
  1855 │       │       │      │       │       │       │               │       │            for i, pt in enumerate(data):                                                                                     
  1856 │       │       │      │       │       │       │               │       │                if INDIVIDUAL_NUMBER and len(PATIENT_GROUPS) == 1:                                                            
  1857 │       │       │      │       │       │       │               │       │                    pt = pt.double().view(1,t_steps,-1)                                                                       
  1858 │       │       │      │       │       │       │               │       │                data_orig = pt                                                                                                
  1859 │       │       │      │       │       │       │               │       │                # Here, we only ever have a batch size of 1 for plotting                                                      
  1860 │       │       │      │       │       │       │               │       │                batch_size_ = 1                                                                                               
  1861 │       │       │      │       │       │       │               │       │                # Ensure the data is only CORT if CORT_ONLY, and that the data and                                            
  1862 │       │       │      │       │       │       │               │       │                #  labels are loaded into the proper device memory                                                            
  1863 │       │       │      │       │       │       │               │       │                if CORT_ONLY:                                                                                                 
  1864 │       │       │      │       │       │       │               │       │                    pt = pt[...,2]                                                                                            
  1865 │       │       │      │       │       │       │               │       │                elif toy_data and INPUT_CHANNELS == 2:                                                                        
  1866 │       │       │      │       │       │       │               │       │                    pt = pt[...,[2,3]]                                                                                        
  1867 │       │       │      │       │       │       │               │       │                else:                                                                                                         
  1868 │       │       │      │       │       │       │               │       │                    pt = pt[...,1:]                                                                                           
  1869 │       │       │      │       │       │       │               │       │                pt = pt.to(DEVICE)                                                                                            
  1870 │       │       │      │       │       │       │               │       │                labels = labels.to(DEVICE) if CLASSIFY else pt                                                                
  1871 │       │       │      │       │       │       │               │       │                                                                                                                              
  1872 │       │       │      │       │       │       │               │       │                # We need to reshape the data to fit the ANN properly                                                         
  1873 │       │       │      │       │       │       │               │       │                pred_y = model(                                                                                               
  1874 │       │       │      │       │       │       │               │       │                    pt.reshape(                                                                                               
  1875 │       │       │      │       │       │       │               │       │                        batch_size_,                                                                                          
  1876 │       │       │      │       │       │       │               │       │                        INPUT_CHANNELS*t_steps)                                                                               
  1877 │       │       │      │       │       │       │               │       │                )                                                                                                             
  1878 │       │       │      │       │       │       │               │       │                pred_y = readout(pred_y).squeeze(-1).reshape(                                                                 
  1879 │       │       │      │       │       │       │               │       │                    -1, labels.size(1),                                                                                       
  1880 │       │       │      │       │       │       │               │       │                )                                                                                                             
  1881 │       │       │      │       │       │       │               │       │                                                                                                                              
  1882 │       │       │      │       │       │       │               │       │                if i < len(index)/2:                                                                                          
  1883 │       │       │      │       │       │       │               │       │                    patient_id = f'Control Patient {index[i]}'                                                                
  1884 │       │       │      │       │       │       │               │       │                else:                                                                                                         
  1885 │       │       │      │       │       │       │               │       │                    patient_id = f'MDD Patient {index[i]}'                                                                    
  1886 │       │       │      │       │       │       │               │       │                                                                                                                              
  1887 │       │       │      │       │       │       │               │       │                # Graph the results                                                                                           
  1888 │       │       │      │       │       │       │               │       │                graph_results(pred_y, data_orig, patient_id, itr, info)                                                       
  1889 │       │       │      │       │       │       │               │       │                                                                                                                              
  1890 │       │       │      │       │       │       │               │       │                                                                                                                              
  1891 │       │       │      │       │       │       │               │       │def param_init(model: nn.Module):                                                                                             
  1892 │       │       │      │       │       │       │               │       │    """Initialize the parameters for the mechanistic loss, and set them to                                                    
  1893 │       │       │      │       │       │       │               │       │    require gradient"""                                                                                                       
  1894 │       │       │      │       │       │       │               │       │    k_stress = torch.nn.Parameter(torch.tensor(13.7), requires_grad=True)                                                     
  1895 │       │       │      │       │       │       │               │       │    Ki = torch.nn.Parameter(torch.tensor(1.6), requires_grad=True)                                                            
  1896 │       │       │      │       │       │       │               │       │    VS3 = torch.nn.Parameter(torch.tensor(3.25), requires_grad=True)                                                          
  1897 │       │       │      │       │       │       │               │       │    Km1 = torch.nn.Parameter(torch.tensor(1.74), requires_grad=True)                                                          
  1898 │       │       │      │       │       │       │               │       │    KP2 = torch.nn.Parameter(torch.tensor(8.3), requires_grad=True)                                                           
  1899 │       │       │      │       │       │       │               │       │    VS4 = torch.nn.Parameter(torch.tensor(0.907), requires_grad=False)                                                        
  1900 │       │       │      │       │       │       │               │       │    Km2 = torch.nn.Parameter(torch.tensor(0.112), requires_grad=False)                                                        
  1901 │       │       │      │       │       │       │               │       │    KP3 = torch.nn.Parameter(torch.tensor(0.945), requires_grad=False)                                                        
  1902 │       │       │      │       │       │       │               │       │    VS5 = torch.nn.Parameter(torch.tensor(0.00535), requires_grad=False)                                                      
  1903 │       │       │      │       │       │       │               │       │    Km3 = torch.nn.Parameter(torch.tensor(0.0768), requires_grad=False)                                                       
  1904 │       │       │      │       │       │       │               │       │    Kd1 = torch.nn.Parameter(torch.tensor(0.00379), requires_grad=False)                                                      
  1905 │       │       │      │       │       │       │               │       │    Kd2 = torch.nn.Parameter(torch.tensor(0.00916), requires_grad=False)                                                      
  1906 │       │       │      │       │       │       │               │       │    Kd3 = torch.nn.Parameter(torch.tensor(0.356), requires_grad=False)                                                        
  1907 │       │       │      │       │       │       │               │       │    n1 = torch.nn.Parameter(torch.tensor(5.43), requires_grad=True)                                                           
  1908 │       │       │      │       │       │       │               │       │    n2 = torch.nn.Parameter(torch.tensor(5.1), requires_grad=True)                                                            
  1909 │       │       │      │       │       │       │               │       │    Kb = torch.nn.Parameter(torch.tensor(0.0202), requires_grad=True)                                                         
  1910 │       │       │      │       │       │       │               │       │    Gtot = torch.nn.Parameter(torch.tensor(3.28), requires_grad=True)                                                         
  1911 │       │       │      │       │       │       │               │       │    VS2 = torch.nn.Parameter(torch.tensor(0.0509), requires_grad=True)                                                        
  1912 │       │       │      │       │       │       │               │       │    K1 = torch.nn.Parameter(torch.tensor(0.645), requires_grad=True)                                                          
  1913 │       │       │      │       │       │       │               │       │    Kd5 = torch.nn.Parameter(torch.tensor(0.0854), requires_grad=True)                                                        
  1914 │       │       │      │       │       │       │               │       │                                                                                                                              
  1915 │       │       │      │       │       │       │               │       │    params = {                                                                                                                
  1916 │       │       │      │       │       │       │               │       │        'k_stress': k_stress,                                                                                                 
  1917 │       │       │      │       │       │       │               │       │        'Ki': Ki,                                                                                                             
  1918 │       │       │      │       │       │       │               │       │        'VS3': VS3,                                                                                                           
  1919 │       │       │      │       │       │       │               │       │        'Km1': Km1,                                                                                                           
  1920 │       │       │      │       │       │       │               │       │        'KP2': KP2,                                                                                                           
  1921 │       │       │      │       │       │       │               │       │        'VS4': VS4,                                                                                                           
  1922 │       │       │      │       │       │       │               │       │        'Km2': Km2,                                                                                                           
  1923 │       │       │      │       │       │       │               │       │        'KP3': KP3,                                                                                                           
  1924 │       │       │      │       │       │       │               │       │        'VS5': VS5,                                                                                                           
  1925 │       │       │      │       │       │       │               │       │        'Km3': Km3,                                                                                                           
  1926 │       │       │      │       │       │       │               │       │        'Kd1': Kd1,                                                                                                           
  1927 │       │       │      │       │       │       │               │       │        'Kd2': Kd2,                                                                                                           
  1928 │       │       │      │       │       │       │               │       │        'Kd3': Kd3,                                                                                                           
  1929 │       │       │      │       │       │       │               │       │        'n1': n1,                                                                                                             
  1930 │       │       │      │       │       │       │               │       │        'n2': n2,                                                                                                             
  1931 │       │       │      │       │       │       │               │       │        'Kb': Kb,                                                                                                             
  1932 │       │       │      │       │       │       │               │       │        'Gtot': Gtot,                                                                                                         
  1933 │       │       │      │       │       │       │               │       │        'VS2': VS2,                                                                                                           
  1934 │       │       │      │       │       │       │               │       │        'K1': K1,                                                                                                             
  1935 │       │       │      │       │       │       │               │       │        'Kd5': Kd5                                                                                                            
  1936 │       │       │      │       │       │       │               │       │    }                                                                                                                         
  1937 │       │       │      │       │       │       │               │       │                                                                                                                              
  1938 │       │       │      │       │       │       │               │       │    for key, val in params.items():                                                                                           
  1939 │       │       │      │       │       │       │               │       │        model.register_parameter(key, val)                                                                                    
  1940 │       │       │      │       │       │       │               │       │                                                                                                                              
  1941 │       │       │      │       │       │       │               │       │    return params                                                                                                             
  1942 │       │       │      │       │       │       │               │       │                                                                                                                              
  1943 │       │       │      │       │       │       │               │       │                                                                                                                              
  1944 │       │       │      │       │       │       │               │       │def loss(pred_y, labels):                                                                                                     
  1945 │       │       │      │       │       │       │               │       │    """To compute the loss with potential mechanistic components"""                                                           
  1946 │       │       │      │       │       │       │               │       │    if CLASSIFY:                                                                                                              
  1947 │       │       │      │       │       │       │               │       │        return binary_cross_entropy_with_logits(pred_y, labels)                                                               
  1948 │       │       │      │       │       │       │               │       │                                                                                                                              
  1949 │       │       │      │       │       │       │               │       │    if MECHANISTIC:                                                                                                           
  1950 │       │       │      │       │       │       │               │       │        pass                                                                                                                  
  1951 │       │       │      │       │       │       │               │       │                                                                                                                              
  1952 │       │       │      │       │       │       │               │       │    return mse_loss(pred_y, labels)                                                                                           
  1953 │       │       │      │       │       │       │               │       │                                                                                                                              
  1954 │       │       │      │       │       │       │               │       │                                                                                                                              
  1955 │       │       │      │       │       │       │               │       │def save_performance(performance_df: pd.DataFrame, info: dict):                                                               
  1956 │       │       │      │       │       │       │               │       │    """Save the performance characteristics to an Excel spreadsheet"""                                                        
  1957 │       │       │      │       │       │       │               │       │    # Access the necessary variables from the info dictionary                                                                 
  1958 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
  1959 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
  1960 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
  1961 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
  1962 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
  1963 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
  1964 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
  1965 │       │       │      │       │       │       │               │       │                                                                                                                              
  1966 │       │       │      │       │       │       │               │       │    # Set the directory name based on which type of dataset was used for the                                                  
  1967 │       │       │      │       │       │       │               │       │    #  training                                                                                                               
  1968 │       │       │      │       │       │       │               │       │    if not virtual:                                                                                                           
  1969 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1970 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  1971 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1972 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
  1973 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1974 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  1975 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1976 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  1977 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  1978 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
  1979 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1980 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
  1981 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1982 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  1983 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/Augmented Data/'                                               
  1984 │       │       │      │       │       │       │               │       │            f'{"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Classification/'                                                
  1985 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
  1986 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
  1987 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
  1988 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
  1989 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1990 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  1991 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  1992 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  1993 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/Augmented Data/'                                               
  1994 │       │       │      │       │       │       │               │       │            f'VPOP Classification/'                                                                                           
  1995 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
  1996 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  1997 │       │       │      │       │       │       │               │       │                                                                                                                              
  1998 │       │       │      │       │       │       │               │       │    # Make sure the directory exists before we try to write anything                                                          
  1999 │       │       │      │       │       │       │               │       │    if not os.path.exists(directory):                                                                                         
  2000 │       │       │      │       │       │       │               │       │        os.makedirs(directory)                                                                                                
  2001 │       │       │      │       │       │       │               │       │                                                                                                                              
  2002 │       │       │      │       │       │       │               │       │    # Set the filename for the network state_dict                                                                             
  2003 │       │       │      │       │       │       │               │       │    filename = (                                                                                                              
  2004 │       │       │      │       │       │       │               │       │        f'{NETWORK_TYPE}_{HDIM}nodes_'                                                                                        
  2005 │       │       │      │       │       │       │               │       │        f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                                  
  2006 │       │       │      │       │       │       │               │       │        f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                            
  2007 │       │       │      │       │       │       │               │       │        f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                                
  2008 │       │       │      │       │       │       │               │       │        f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                              
  2009 │       │       │      │       │       │       │               │       │        f'{NUM_PER_PATIENT}perPatient_'                                                                                       
  2010 │       │       │      │       │       │       │               │       │        f'batchsize{BATCH_SIZE}_'                                                                                             
  2011 │       │       │      │       │       │       │               │       │        f'{MAX_ITR}maxITER_{NORMALIZE_STANDARDIZE}_'                                                                          
  2012 │       │       │      │       │       │       │               │       │        f'smoothing{LABEL_SMOOTHING}_'                                                                                        
  2013 │       │       │      │       │       │       │               │       │        f'dropout{DROPOUT}'                                                                                                   
  2014 │       │       │      │       │       │       │               │       │        f'{"_byLab" if by_lab else ""}.xlsx'                                                                                  
  2015 │       │       │      │       │       │       │               │       │    ) if virtual else (                                                                                                       
  2016 │       │       │      │       │       │       │               │       │        f'{NETWORK_TYPE}_{HDIM}nodes_'                                                                                        
  2017 │       │       │      │       │       │       │               │       │        f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                                    
  2018 │       │       │      │       │       │       │               │       │        f'batchsize{BATCH_SIZE}_'                                                                                             
  2019 │       │       │      │       │       │       │               │       │        f'{MAX_ITR}maxITER_{NORMALIZE_STANDARDIZE}_'                                                                          
  2020 │       │       │      │       │       │       │               │       │        f'smoothing{LABEL_SMOOTHING}_'                                                                                        
  2021 │       │       │      │       │       │       │               │       │        f'dropout{DROPOUT}.xlsx'                                                                                              
  2022 │       │       │      │       │       │       │               │       │    )                                                                                                                         
  2023 │       │       │      │       │       │       │               │       │                                                                                                                              
  2024 │       │       │      │       │       │       │               │       │    with pd.ExcelWriter(os.path.join(directory, filename)) as writer:                                                         
  2025 │       │       │      │       │       │       │               │       │        performance_df.to_excel(writer)                                                                                       
  2026 │       │       │      │       │       │       │               │       │                                                                                                                              
  2027 │       │       │      │       │       │       │               │       │                                                                                                                              
  2028 │       │       │      │       │       │       │               │       │def graph_results(pred_y: torch.Tensor, pred_t: torch.Tensor,                                                                 
  2029 │       │       │      │       │       │       │               │       │                  data: torch.Tensor, patient_id: str,                                                                        
  2030 │       │       │      │       │       │       │               │       │                  save_num: int, info: dict):                                                                                 
  2031 │       │       │      │       │       │       │               │       │    # Access the necessary variables from the info dictionary                                                                 
  2032 │       │       │      │       │       │       │               │       │    virtual = info.get('virtual', True)                                                                                       
  2033 │       │       │      │       │       │       │               │       │    ctrl_num = info.get('ctrl_num')                                                                                           
  2034 │       │       │      │       │       │       │               │       │    control_combination = info.get('control_combination')                                                                     
  2035 │       │       │      │       │       │       │               │       │    mdd_num = info.get('mdd_num')                                                                                             
  2036 │       │       │      │       │       │       │               │       │    mdd_combination = info.get('mdd_combination')                                                                             
  2037 │       │       │      │       │       │       │               │       │    by_lab = info.get('by_lab')                                                                                               
  2038 │       │       │      │       │       │       │               │       │    toy_data = info.get('toy_data', False)                                                                                    
  2039 │       │       │      │       │       │       │               │       │                                                                                                                              
  2040 │       │       │      │       │       │       │               │       │    # Convert the save number to the number of iterations                                                                     
  2041 │       │       │      │       │       │       │               │       │    itr = save_num*SAVE_FREQ                                                                                                  
  2042 │       │       │      │       │       │       │               │       │                                                                                                                              
  2043 │       │       │      │       │       │       │               │       │    # Set the directory name based on which type of dataset was used for the                                                  
  2044 │       │       │      │       │       │       │               │       │    #  training                                                                                                               
  2045 │       │       │      │       │       │       │               │       │    if not virtual and len(PATIENT_GROUPS) == 1:                                                                              
  2046 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  2047 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  2048 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  2049 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}/'                                                                                           
  2050 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2051 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
  2052 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  2053 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  2054 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  2055 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]}/'                                                                                
  2056 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2057 │       │       │      │       │       │       │               │       │    elif toy_data:                                                                                                            
  2058 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  2059 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  2060 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/'                                                              
  2061 │       │       │      │       │       │       │               │       │            f'Toy Dataset/'                                                                                                   
  2062 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2063 │       │       │      │       │       │       │               │       │    elif not POP_NUMBER:                                                                                                      
  2064 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  2065 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  2066 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/Augmented Data/'                                               
  2067 │       │       │      │       │       │       │               │       │            f'{"Full" if not CORT_ONLY else "CORT ONLY"} VPOP Classification/'                                                
  2068 │       │       │      │       │       │       │               │       │            f'{"By Lab" if by_lab else "By Diagnosis"}/'                                                                      
  2069 │       │       │      │       │       │       │               │       │            f'{"Control" if not by_lab else "Nelson"} '                                                                       
  2070 │       │       │      │       │       │       │               │       │            f'{ctrl_num} {control_combination}/'                                                                              
  2071 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1] if not by_lab else "Ableson"} {mdd_num} {mdd_combination}/'                                  
  2072 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2073 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  2074 │       │       │      │       │       │       │               │       │        directory = (                                                                                                         
  2075 │       │       │      │       │       │       │               │       │            f'Results/'                                                                                                       
  2076 │       │       │      │       │       │       │               │       │            f'{"Classification" if CLASSIFY else "Prediction"}/Augmented Data/'                                               
  2077 │       │       │      │       │       │       │               │       │            f'VPOP Classification/'                                                                                           
  2078 │       │       │      │       │       │       │               │       │            f'Control vs {PATIENT_GROUPS[1]} Population {POP_NUMBER}/'                                                        
  2079 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2080 │       │       │      │       │       │       │               │       │                                                                                                                              
  2081 │       │       │      │       │       │       │               │       │    # Make sure the directory exists before we try to write anything                                                          
  2082 │       │       │      │       │       │       │               │       │    if not os.path.exists(directory):                                                                                         
  2083 │       │       │      │       │       │       │               │       │        os.makedirs(directory)                                                                                                
  2084 │       │       │      │       │       │       │               │       │                                                                                                                              
  2085 │       │       │      │       │       │       │               │       │    # Set the filename for the network state_dict                                                                             
  2086 │       │       │      │       │       │       │               │       │    if not virtual and len(PATIENT_GROUPS) == 1:                                                                              
  2087 │       │       │      │       │       │       │               │       │        filename = (                                                                                                          
  2088 │       │       │      │       │       │       │               │       │            f'{NETWORK_TYPE}_{HDIM}nodes_'                                                                                    
  2089 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]}{INDIVIDUAL_NUMBER}_'                                                                        
  2090 │       │       │      │       │       │       │               │       │            f'batchsize{BATCH_SIZE}_'                                                                                         
  2091 │       │       │      │       │       │       │               │       │            f'{MAX_ITR}maxITER_{NORMALIZE_STANDARDIZE}_'                                                                      
  2092 │       │       │      │       │       │       │               │       │            f'smoothing{LABEL_SMOOTHING}_'                                                                                    
  2093 │       │       │      │       │       │       │               │       │            f'dropout{DROPOUT}_'                                                                                              
  2094 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2095 │       │       │      │       │       │       │               │       │    elif not virtual:                                                                                                         
  2096 │       │       │      │       │       │       │               │       │        filename = (                                                                                                          
  2097 │       │       │      │       │       │       │               │       │            f'{NETWORK_TYPE}_{HDIM}nodes_'                                                                                    
  2098 │       │       │      │       │       │       │               │       │            f'Control_vs_{PATIENT_GROUPS[1]}_'                                                                                
  2099 │       │       │      │       │       │       │               │       │            f'batchsize{BATCH_SIZE}_'                                                                                         
  2100 │       │       │      │       │       │       │               │       │            f'{MAX_ITR}maxITER_{NORMALIZE_STANDARDIZE}_'                                                                      
  2101 │       │       │      │       │       │       │               │       │            f'smoothing{LABEL_SMOOTHING}_'                                                                                    
  2102 │       │       │      │       │       │       │               │       │            f'dropout{DROPOUT}_'                                                                                              
  2103 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2104 │       │       │      │       │       │       │               │       │    else:                                                                                                                     
  2105 │       │       │      │       │       │       │               │       │        filename = (                                                                                                          
  2106 │       │       │      │       │       │       │               │       │            f'{NETWORK_TYPE}_{HDIM}nodes_'                                                                                    
  2107 │       │       │      │       │       │       │               │       │            f'{METHOD}{NOISE_MAGNITUDE}Virtual_'                                                                              
  2108 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[0]+str(control_combination) if not POP_NUMBER else ""}_'                                        
  2109 │       │       │      │       │       │       │               │       │            f'{PATIENT_GROUPS[1]+str(mdd_combination) if not POP_NUMBER else ""}_'                                            
  2110 │       │       │      │       │       │       │               │       │            f'{"Control vs "+PATIENT_GROUPS[1]+" Population"+str(POP_NUMBER) if POP_NUMBER else ""}'                          
  2111 │       │       │      │       │       │       │               │       │            f'{NUM_PER_PATIENT}perPatient_'                                                                                   
  2112 │       │       │      │       │       │       │               │       │            f'batchsize{BATCH_SIZE}_'                                                                                         
  2113 │       │       │      │       │       │       │               │       │            f'{MAX_ITR}maxITER_{NORMALIZE_STANDARDIZE}_'                                                                      
  2114 │       │       │      │       │       │       │               │       │            f'smoothing{LABEL_SMOOTHING}_'                                                                                    
  2115 │       │       │      │       │       │       │               │       │            f'dropout{DROPOUT}_'                                                                                              
  2116 │       │       │      │       │       │       │               │       │            f'{"_byLab" if by_lab else ""}_'                                                                                  
  2117 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2118 │       │       │      │       │       │       │               │       │                                                                                                                              
  2119 │       │       │      │       │       │       │               │       │    # pred_y = pred_y.view(data.size(1), data.size(2)-1)                                                                      
  2120 │       │       │      │       │       │       │               │       │    pred_y = pred_y.squeeze()                                                                                                 
  2121 │       │       │      │       │       │       │               │       │    fig, axes = plt.subplots(nrows=INPUT_CHANNELS, figsize=(10,10))                                                           
  2122 │       │       │      │       │       │       │               │       │    for idx,ax in enumerate(range(INPUT_CHANNELS)):                                                                           
  2123 │       │       │      │       │       │       │               │       │        axes[ax].plot(data[...,0].squeeze(), data[...,idx+1].squeeze(), 'o', label=patient_id)                                
  2124 │       │       │      │       │       │       │               │       │        axes[ax].plot(                                                                                                        
  2125 │       │       │      │       │       │       │               │       │            pred_t, pred_y[:,idx], label=f'Predicted y ({itr} iterations)'                                                    
  2126 │       │       │      │       │       │       │               │       │        )                                                                                                                     
  2127 │       │       │      │       │       │       │               │       │        axes[ax].set(title=patient_id, xlabel='Time (normalized)', ylabel='Concentration')                                    
  2128 │       │       │      │       │       │       │               │       │        axes[ax].legend(fancybox=True, shadow=True, loc='upper right')                                                        
  2129 │       │       │      │       │       │       │               │       │                                                                                                                              
  2130 │       │       │      │       │       │       │               │       │    plt.savefig(os.path.join(directory, filename+patient_id+'.png'), dpi=300)                                                 
  2131 │       │       │      │       │       │       │               │       │    plt.close(fig)                                                                                                            
  2132 │       │       │      │       │       │       │               │       │                                                                                                                              
  2133 │       │       │      │       │       │       │               │       │                                                                                                                              
  2134 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
  2135 │       │       │      │       │       │       │               │       │#                                 MIT License                                 #                                               
  2136 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
  2137 │       │       │      │       │       │       │               │       │#     Copyright (c) 2022 Christopher John Parker <parkecp@mail.uc.edu>        #                                               
  2138 │       │       │      │       │       │       │               │       │#                                                                             #                                               
  2139 │       │       │      │       │       │       │               │       │# Permission is hereby granted, free of charge, to any person obtaining a     #                                               
  2140 │       │       │      │       │       │       │               │       │# copy of this software and associated documentation files (the "Software"),  #                                               
  2141 │       │       │      │       │       │       │               │       │# to deal in the Software without restriction, including without limitation   #                                               
  2142 │       │       │      │       │       │       │               │       │# the rights to use, copy, modify, merge, publish, distribute, sublicense,    #                                               
  2143 │       │       │      │       │       │       │               │       │# and/or sell copies of the Software, and to permit persons to whom the       #                                               
  2144 │       │       │      │       │       │       │               │       │# Software is furnished to do so, subject to the following conditions:        #                                               
  2145 │       │       │      │       │       │       │               │       │#                                                                             #                                               
  2146 │       │       │      │       │       │       │               │       │# The above copyright notice and this permission notice shall be included in  #                                               
  2147 │       │       │      │       │       │       │               │       │# all copies or substantial portions of the Software.                         #                                               
  2148 │       │       │      │       │       │       │               │       │#                                                                             #                                               
  2149 │       │       │      │       │       │       │               │       │# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  #                                               
  2150 │       │       │      │       │       │       │               │       │# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,    #                                               
  2151 │       │       │      │       │       │       │               │       │# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE #                                               
  2152 │       │       │      │       │       │       │               │       │# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER      #                                               
  2153 │       │       │      │       │       │       │               │       │# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING     #                                               
  2154 │       │       │      │       │       │       │               │       │# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER         #                                               
  2155 │       │       │      │       │       │       │               │       │# DEALINGS IN THE SOFTWARE.                                                   #                                               
  2156 │       │       │      │       │       │       │               │       │#                                                                             #                                               
  2157 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                               
  2158 │       │       │      │       │       │       │               │       │                                                                                                                              
  2159 │       │       │      │       │       │       │               │       │                                                                                                                              
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                                                                                              
Top PEAK memory consumption, by line:
(1)    15:    20 MB                                                                                                                                                                                           
(2)    13:    20 MB                                                                                                                                                                                           
                                                         /home/ec2-user/NCDE-model/neural_ode.py: % of time =   0.28% (347.431ms) out of 2m:2.595s.                                                          
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                                                                                              
       │Time   │–––––– │––––… │–––––– │Memory │–––––– │–––––––––––    │Copy   │                                                                                                                              
  Line │Python │native │syst… │GPU    │Python │peak   │timeline/%     │(MB/s) │/home/ec2-user/NCDE-model/neural_ode.py                                                                                       
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │      │       │       │       │               │       │# File Name: neural_ode.py                                                                                                    
     2 │       │       │      │       │       │       │               │       │# Author: Christopher Parker                                                                                                  
     3 │       │       │      │       │       │       │               │       │# Created: Mon Aug 14, 2023 | 11:02P EDT                                                                                      
     4 │       │       │      │       │       │       │               │       │# Last Modified: Thu Sep 14, 2023 | 08:13P EDT                                                                                
     5 │       │       │      │       │       │       │               │       │                                                                                                                              
     6 │       │       │      │       │       │       │               │       │"""Contains the class for running NODE training"""                                                                            
     7 │       │       │      │       │       │       │               │       │                                                                                                                              
     8 │       │       │      │       │       │       │               │       │import torch                                                                                                                  
     9 │       │       │      │       │       │       │               │       │import torch.nn as nn                                                                                                         
    10 │       │       │      │       │       │       │               │       │import numpy as np                                                                                                            
    11 │       │       │      │       │       │       │               │       │                                                                                                                              
    12 │       │       │      │       │       │       │               │       │class NeuralODE(nn.Module):                                                                                                   
    13 │       │       │      │       │       │       │               │       │    def __init__(self, input_channels, hdim, output_channels,                                                                 
    14 │       │       │      │       │       │       │               │       │                 device=torch.device('cpu')):                                                                                 
    15 │       │       │      │       │       │       │               │       │        super().__init__()                                                                                                    
    16 │       │       │      │       │       │       │               │       │                                                                                                                              
    17 │       │       │      │       │       │       │               │       │        self.net = nn.Sequential(                                                                                             
    18 │       │       │      │       │       │       │               │       │            nn.Linear(input_channels, hdim),                                                                                  
    19 │       │       │      │       │       │       │               │       │            nn.Tanh(),                                                                                                        
    20 │       │       │      │       │       │       │               │       │            nn.Linear(hdim, hdim),                                                                                            
    21 │       │       │      │       │       │       │               │       │            nn.Tanh(),                                                                                                        
    22 │       │       │      │       │       │       │               │       │            nn.Linear(hdim, hdim),                                                                                            
    23 │       │       │      │       │       │       │               │       │            nn.Tanh(),                                                                                                        
    24 │       │       │      │       │       │       │               │       │            nn.Linear(hdim, hdim),                                                                                            
    25 │       │       │      │       │       │       │               │       │            nn.Tanh(),                                                                                                        
    26 │       │       │      │       │       │       │               │       │            nn.Linear(hdim, output_channels),                                                                                 
    27 │       │       │      │       │       │       │               │       │            nn.Tanh(),                                                                                                        
    28 │       │       │      │       │       │       │               │       │        ).to(device)                                                                                                          
    29 │       │       │      │       │       │       │               │       │                                                                                                                              
    30 │       │       │      │       │       │       │               │       │        for m in self.net.modules():                                                                                          
    31 │       │       │      │       │       │       │               │       │            if isinstance(m, nn.Linear):                                                                                      
    32 │       │       │      │       │       │       │               │       │                nn.init.xavier_normal_(m.weight)                                                                              
    33 │       │       │      │       │       │       │               │       │                # nn.init.normal_(m.weight, mean=0., std=np.sqrt(2/(hdim*2)))                                                 
    34 │       │       │      │       │       │       │               │       │                nn.init.constant_(m.bias, 0)                                                                                  
    35 │       │       │      │       │       │       │               │       │                                                                                                                              
    36 │       │       │      │       │       │       │               │       │    def forward(self, t, y):                                                                                                  
    37 │       │       │      │       │       │       │               │       │        """t is unnecessary, but still passed by the NODE solver"""                                                           
    38 │       │       │      │       │  34%  │   11M │▁   2%         │    59 │        return self.net(y)                                                                                                    
    39 │       │       │      │       │       │       │               │       │                                                                                                                              
    40 │       │       │      │       │       │       │               │       │                                                                                                                              
    41 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                                 
    42 │       │       │      │       │       │       │               │       │#                                 MIT License                               #                                                 
    43 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                                 
    44 │       │       │      │       │       │       │               │       │#     Copyright (c) 2023 Christopher John Parker <parkecp@mail.uc.edu>      #                                                 
    45 │       │       │      │       │       │       │               │       │#                                                                           #                                                 
    46 │       │       │      │       │       │       │               │       │# Permission is hereby granted, free of charge, to any person obtaining a   #                                                 
    47 │       │       │      │       │       │       │               │       │# copy of this software and associated documentation files (the "Software"),#                                                 
    48 │       │       │      │       │       │       │               │       │# to deal in the Software without restriction, including without limitation #                                                 
    49 │       │       │      │       │       │       │               │       │# the rights to use, copy, modify, merge, publish, distribute, sublicense,  #                                                 
    50 │       │       │      │       │       │       │               │       │# and/or sell copies of the Software, and to permit persons to whom the     #                                                 
    51 │       │       │      │       │       │       │               │       │# Software is furnished to do so, subject to the following conditions:      #                                                 
    52 │       │       │      │       │       │       │               │       │#                                                                           #                                                 
    53 │       │       │      │       │       │       │               │       │# The above copyright notice and this permission notice shall be included   #                                                 
    54 │       │       │      │       │       │       │               │       │# in all copies or substantial portions of the Software.                    #                                                 
    55 │       │       │      │       │       │       │               │       │#                                                                           #                                                 
    56 │       │       │      │       │       │       │               │       │# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS   #                                                 
    57 │       │       │      │       │       │       │               │       │# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF                #                                                 
    58 │       │       │      │       │       │       │               │       │# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.    #                                                 
    59 │       │       │      │       │       │       │               │       │# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY      #                                                 
    60 │       │       │      │       │       │       │               │       │# CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,      #                                                 
    61 │       │       │      │       │       │       │               │       │# TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE         #                                                 
    62 │       │       │      │       │       │       │               │       │# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                    #                                                 
    63 │       │       │      │       │       │       │               │       │#                                                                           #                                                 
    64 │       │       │      │       │       │       │               │       │#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#                                                 
    65 │       │       │      │       │       │       │               │       │                                                                                                                              
    66 │       │       │      │       │       │       │               │       │                                                                                                                              
       │       │       │      │       │       │       │               │       │                                                                                                                              
╶──────┼───────┼───────┼──────┼───────┼───────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │      │       │       │       │               │       │function summary for /home/ec2-user/NCDE-model/neural_ode.py                                                                  
    13 │       │       │      │       │       │       │               │       │NeuralODE.__init__                                                                                                            
    36 │       │       │      │       │  34%  │   11M │█   2%         │    59 │NeuralODE.forward                                                                                                             
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                                                                                              
Top PEAK memory consumption, by line:
(1)    38:    11 MB                                                                                                                                                                                           
